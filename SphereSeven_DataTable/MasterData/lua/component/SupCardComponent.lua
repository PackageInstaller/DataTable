---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by win 10.
--- DateTime: 2019/6/13 19:06
---

local SupCardComponent = BaseClass("SupCardComponent", Component)
local base = Component


local function Awake(self)
    base.Awake(self)
    self.SupCards = {}
    self.UpdataNum = 0
    self.IsInit = false
end

local function Add(self,cardInfo)
    self.SupCards[cardInfo.Id] = cardInfo
end

local function Get(self,supCardId)
    return self.SupCards[supCardId]
end

local function Remove(self,supCardId)
    self.Cards[supCardId] = nil;
end

local function GetStageByStar(self,star)

    if star <= 2 then
        return 1
    elseif star <= 4 then
        return 2
    elseif star == 5 then
        return 3
    end
end

local function Clear(self)
    self.SupCards = {}
end

--设置 援助的卡(id)
local function SetAid(self,card_id,callback)
    coroutine.start(function ()
        local info = coroutine.yieldstart(Game.Scene.Session.CoCall,nil,Game.Scene.Session,
                OuterOpcode.Name2Code.ETModel_C2M_AdiSet, {CardId=card_id})
        if info.Error == ErrorCode.ERR_Success then
            if callback~=nil then callback()end
        end
    end)
end
--获取随机援助角色


local function AddCardsData(self,info)
    for k,v in table.pairsByKeys(info.AidCards) do
        local card = Game.Registry:NewObject("SupCard",v)
        card:InitCardComponent()
        self:Add(card)
    end
end

local function ResetAids(self,callback)
    local info = coroutine.yieldstart(Game.Scene.Session.CoCall,nil,Game.Scene.Session,
            OuterOpcode.Name2Code.ETModel_C2M_GetAdis, {Type = 2})
    if info.Error == ErrorCode.ERR_Success then
         --Name   拥有者玩家名字
         --OwnId  拥有者玩家Id
         --Info   同CardInfo
        self:Clear()
        self.UpdataNum = info.UpdataNum
        AddCardsData(self,info)
        if callback~=nil then callback(info.AidCards) end
    end
end

local function GetAids(self,callback,isOnClick)
    local type = 0
    if isOnClick then
        type = 1
        self.IsInit = true
    else
        type = 0
        --if self.UpdataNum == 0 then
        --    type = 0
        --else
        --    type = 2
        --end
    end
    
    local info = coroutine.yieldstart(Game.Scene.Session.CoCall,nil,Game.Scene.Session,
            OuterOpcode.Name2Code.ETModel_C2M_GetAdis, {Type = type})--, 0 是单纯获取 1刷新一次 2 重置刷新次数
    if info.Error == ErrorCode.ERR_Success then
        self:Clear()
        print("--支援数据:"..info.UpdataNum)
        print("--支援Tpye:"..type)
        -- Name   拥有者玩家名字
        -- OwnId  拥有者玩家Id
        -- Info   同CardInfo
        self.UpdataNum = info.UpdataNum
        if type == 0 then
            if table.count(self.SupCards) == 0 then
                AddCardsData(self,info)
            end
        elseif type == 1 then
            AddCardsData(self,info)
        elseif type == 2 then
            AddCardsData(self,info)
        end

        if callback~=nil then callback()end
    end
end

local function Dispose(self)
    base.Dispose(self)

    for _,v in pairs(self.SupCards) do
        v:Dispose()
    end
    self.IsInit = false
end

SupCardComponent.Awake = Awake
SupCardComponent.Add = Add
SupCardComponent.Get = Get
SupCardComponent.Remove = Remove
SupCardComponent.GetStageByStar = GetStageByStar
SupCardComponent.Clear = Clear
SupCardComponent.Dispose = Dispose
SupCardComponent.SetAid=SetAid
SupCardComponent.GetAids= GetAids
SupCardComponent.ResetAids = ResetAids
return SupCardComponent