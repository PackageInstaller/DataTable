---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by win 10.
--- DateTime: 2019/6/13 15:04
---
local PointEffectComponent = BaseClass("PointEffectComponent",Component);
local base = Component
--local prefabPath = "UI/Prefabs/View/UI/PointEffectController.prefab";
local effectPath = "UI/Effects/PointEffect.prefab";

local function Awake(self)
    base.Awake(self)
    self.effectTab = {};
    self.canvas_trans = GameObject.Find("UIRoot/UIEffect").transform
    self.scene_component = Game.Scene:GetComponent("SceneComponent")
    self.camera = CS.UnityEngine.GameObject.Find("UICamera"):GetComponent("Camera");

    --for i = 1,7 do
    --    coroutine.start(function()
    --        local object = GameObjectPool:GetInstance():CoGetGameObjectAsync(effectPath);
    --        local effect = object.transform:Find("bao"):GetComponent("ParticleSystem")
    --        object.transform:SetParent(self.canvas_trans);
    --        object.transform.localPosition = Vector2.New(9999, 9999);
    --        table.insert(self.effectTab,effect);
    --    end)
    --end
end

local function GetPosition(transform,camera)
    local vc2 = CS.Vector2.one;
    local parentRc = transform:GetComponent("RectTransform");
    CS.UnityEngine.RectTransformUtility.ScreenPointToLocalPointInRectangle(parentRc, CS.UnityEngine.Input.mousePosition, camera, vc2);
    return vc2
end

local function SetEffectPos(self,effect)
    local parent = effect.transform.parent;
    parent:SetParent(self.canvas_trans)
    parent.localScale = Vector2.New(1.2,1.2);
    local vc2 = CSUtil.CurrMousePosition(parent,self.camera);
    parent.localPosition =  Vector2.New(vc2.x,vc2.y);
    effect:Play();
end

local function Update(self)
    if Input.touchCount ~= nil and Input.touchCount > 1 then -- 点击效果仅限单指操作
        return
    end
    if Input.GetMouseButtonDown(0) and not self.scene_component:IsLoginScene() and Time.timeScale ~= 0 then
        local effect;
        for k,v in table.pairsByKeys(self.effectTab) do
            if not v.isPlaying then
                effect = v;
            end
        end
        if not effect then
            coroutine.start(function()
                local object = GameObjectPool:GetInstance():CoGetGameObjectAsync(effectPath);
                effect = object.transform:Find("bao"):GetComponent("ParticleSystem")
                table.insert(self.effectTab,effect);
                SetEffectPos(self,effect);
            end)
        else
            SetEffectPos(self,effect);
        end
    end
end

local function Dispose(self)
    base.Dispose(self)
end

PointEffectComponent.Awake = Awake
PointEffectComponent.Update = Update
PointEffectComponent.Dispose = Dispose

return PointEffectComponent