---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by win 10.
--- DateTime: 2019/4/3 11:40
---
--管理界面的子集预制体

local ListChildPool = BaseClass("ListChildPool ",Singleton)

local function __init(self)
end

local function ClearContent(self,content)
    if content.childCount == 0 then return end 
    
    for i = 0,content.transform.childCount - 1 do
        local child = content.transform:GetChild(0).gameObject;
        self:Remove(child);
    end
end

local function GetPrefabName(name)
    local startIndex = string.find(name,"(Clone)")
    if startIndex == nil then
        Logger.Log("item prefab name is not right, no (clone).")
        return name
    end
    return string.sub(name,1,startIndex - 2)
end

local function ResetItem(transform,name)  --回收预制体时  将预制体还原初始状态
    if name == "EquipItemNew" then  --装备列表
        -- local starRoot = transform:Find("IconRoot/StarRoot")
        -- for i = 0,starRoot.childCount - 1 do
        --     starRoot:GetChild(i).gameObject:SetActive(false)
        -- end
        -- transform:Find("Select").gameObject:SetActive(false)
        -- transform:Find("Select1").gameObject:SetActive(false)
        -- transform:Find("Lock").gameObject:SetActive(false)
        -- transform:Find("Holder").gameObject:SetActive(false)
        -- transform:Find("IconRoot/Level"):GetComponent("Text").text = ""
        -- transform:Find("IconRoot/Avatar"):GetComponent("Image").sprite = DeActiveSprite
        -- transform:Find("IconRoot/Avatar"):GetComponent("Image").material = nil
        -- transform:Find("IconRoot/StarBg"):GetComponent("Image").sprite = DeActiveSprite
    elseif name == "CardItemNew" then --角色列表（中）
        transform:Find("CardInfo/Frame"):GetComponent("Image").sprite = DeActiveSprite
        transform:Find("CardInfo/SubProp"):GetComponent("Image").sprite = DeActiveSprite
        transform:Find("CardInfo/AtkDistance"):GetComponent("Image").sprite = DeActiveSprite
        transform:Find("CardInfo/AbiliType"):GetComponent("Image").sprite = DeActiveSprite
        transform:Find("CardInfo/MainProp"):GetComponent("Image").sprite = DeActiveSprite
        transform:Find("CardInfo/Avatar"):GetComponent("Image").material = nil

        transform:Find("CardInfo/New").gameObject:SetActive(false)
        transform:Find("CardInfo/Select").gameObject:SetActive(false)
        transform:Find("CardInfo/Support").gameObject:SetActive(false)
        transform:Find("CardInfo/other/Lock").gameObject:SetActive(false)
        transform:Find("CardInfo/other/IsRoom").gameObject:SetActive(false)
        transform:Find("CardInfo/other/IsHome").gameObject:SetActive(false)
        transform:Find("CardInfo/other/IsSupport").gameObject:SetActive(false)
        transform:Find("CardInfo/Text_bg").gameObject:SetActive(false)
        transform:Find("CardInfo/LevelText"):GetComponent("Text").text = ""
        transform:Find("CardInfo/NameTextRoot/NameText"):GetComponent("Text").text = ""
        local starRoot = transform:Find("CardInfo/Star")
        for i = 0,starRoot.childCount - 1 do
            starRoot:GetChild(i).gameObject:SetActive(false)
        end
    elseif name == "CardResolveItem" then  --角色分解列表
        transform:Find("Mask/Avatar"):GetComponent("Image").sprite = DeActiveSprite
        transform:Find("RareFrame"):GetComponent("Image").sprite = DeActiveSprite
        transform:Find("Level"):GetComponent("Text").text = ""
        local starRoot = transform:Find("Star")
        for i = 0,starRoot.childCount - 1 do
            starRoot:GetChild(i).gameObject:SetActive(false)
        end
    elseif name == "CardHandBookSubItem" then --装备图鉴列表
        transform:Find("NameImage/Name/Value"):GetComponent("Text").text = ""
        transform:Find("Frame"):GetComponent("Image").sprite = DeActiveSprite
        transform:Find("Avatar"):GetComponent("Image").sprite = DeActiveSprite
        transform:Find("Avatar"):GetComponent("Image").material = nil
        local starRoot = transform:Find("Avatar/Star")
        for i = 0,starRoot.childCount - 1 do
            starRoot:GetChild(i).gameObject:SetActive(false)
        end
    elseif name == "FightVisitItem" then  --战魂列表
        -- transform:Find("CardInfo/Mask/Avatar"):GetComponent("Image").sprite =  DeActiveSprite
        -- transform:Find("CardInfo/Mask/Avatar"):GetComponent("Image").material = nil
        -- transform:Find("CardInfo/Frame"):GetComponent("Image").sprite =  DeActiveSprite
        -- transform:Find("CardInfo/Sub"):GetComponent("Image").sprite =  DeActiveSprite
        -- transform:Find("CardInfo/Lab").gameObject:SetActive(false)
        -- transform:Find("CardInfo/Lock").gameObject:SetActive(false)
        -- transform:Find("CardInfo/Select").gameObject:SetActive(false)
        -- transform:Find("CardInfo/IsEquip").gameObject:SetActive(false)
        -- local starRoot = transform:Find("CardInfo/StarRoot")
        -- for i = 0,starRoot.childCount - 1 do
        --     starRoot:GetChild(i).gameObject:SetActive(false)
        -- end
    end
end

local function Remove(self,child,path)
    local name = GetPrefabName(child.name);
    local fullPath;
    if path == nil then
        ResetItem(child.transform,name)
        fullPath =  HomeSceneItemPath.."/"..name..".prefab"
        GameObjectPool:GetInstance():RecycleGameObject(fullPath, child);
    else
        fullPath = "SsUnit/"..name.."/Model/"..name..".prefab"
        GameObjectPool:GetInstance():RecycleGameObject(fullPath, child);
        GameObjectPool:GetInstance():DestroyGameObjectByPath(fullPath);
    end
end

local function GetChild(self,name,parent,callBack,isReverse)
    local object = GameObjectPool:GetInstance():CoGetGameObjectAsync(HomeSceneItemPath.."/"..name..".prefab");
    local func_Init = function()
        if parent ~= nil then
            object.transform:SetParent(parent.transform)
        else
            object.transform:SetParent(nil)
        end
        object.transform.localScale = Vector3.one;
        object.transform.localPosition = Vector3.zero;
        object:SetActive(true);
    end

    local func_callBack = function()
        if callBack ~= nil then
            callBack(object);
        end
    end

    if isReverse then
        func_callBack()
        coroutine.waitforframes(1)
        func_Init()
    else
        func_Init()
        func_callBack()
    end
end

-- 资源 异步分帧实例化
local function AsynGetChild(self, list, name, parent, callBack, loadedBack, limitNum)
    local func_Init = function(obj)
        if parent ~= nil then
            obj.transform:SetParent(parent.transform)
        else
            obj.transform:SetParent(nil)
        end
        obj.transform.localScale = Vector3.one;
        obj.transform.localPosition = Vector3.zero;
        obj:SetActive(true);
    end
    local func_callBack = function(obj, data, index)
        if callBack ~= nil then
            callBack(obj, data, index);
        end
    end
    limitNum = limitNum or 20
    local array = table.values(list)
    coroutine.start(function ()
        for i = 1, #array do
            if (i + 1) % limitNum == 0 then
                coroutine.waitforframes(1)
            end
            local object = GameObjectPool:GetInstance():CoGetGameObjectAsync(HomeSceneItemPath.."/"..name..".prefab")
            func_Init(object)
            func_callBack(object, array[i], i)
        end
        if loadedBack ~= nil then
            loadedBack()
        end
    end)
end

local function CreateCardPaintAnim(self,name,parent,callBack)
    local object = GameObjectPool:GetInstance():CoGetGameObjectAsync("UI/Prefabs/View/UI/Spine/"..name..".prefab");
    object.transform:SetParent(parent.transform)
    object.transform.localScale = Vector3.New(135,135,1)
    object.transform.localPosition = Vector3.New(-287,-912,333)
    callBack(object);
end

local function RemoveCardPaintAnim (self,child)
    local name = GetPrefabName(child.name);
    local path = "UI/Prefabs/View/UI/Spine/"..name..".prefab"
    GameObjectPool:GetInstance():RecycleGameObject(path, child);
end

ListChildPool.__init = __init;
ListChildPool.ClearContent = ClearContent;
ListChildPool.Remove = Remove;
ListChildPool.GetChild = GetChild;
ListChildPool.AsynGetChild = AsynGetChild;
ListChildPool.CreateCardPaintAnim = CreateCardPaintAnim
ListChildPool.RemoveCardPaintAnim = RemoveCardPaintAnim
return ListChildPool;