---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by win 10.
--- DateTime: 2019/5/24 16:58
---

local UIMarriedView = BaseClass("UIMarriedView",UIBaseView);
local base = UIBaseView
local this = UIMarriedView


--local handDefPos = Vector3.New(0,9.4,-0.68) 
--local handEndPos = Vector3.New(0,0.92,-0.68)
--local handDurTime = 2.5
--
--local jzDefPos = Vector3.New(1.21,-5.15,-0.04)
--local jzEndPos = Vector3.New(1.08,-0.22,-0.04)
--local jzDurTime = 1


local handImgDefPos = Vector2.New(776,-326)
--local handImgEndPos = Vector2.New(776,185)
--local handImgDurTime = 0.7

local effectName = "GetMarried"
--local beginY = 0

--local function OnDragBegin(self)
--    beginY = Input.mousePosition.y
--end


--local function OnDrag(self)
--    if Input.mousePosition.y >beginY then
--        EventTriggerListener.Get(self.gameObject).onLuaDragHandler = nil
--        EventTriggerListener.Get(self.gameObject).onLuaDragBeginHandler = nil
--        coroutine.start(function()
--            local rect = self.handImg.transform:GetComponent("RectTransform")
--            self.handImg:DOFade(1,0.3)
--            coroutine.waitforseconds(0.3)
--            rect:DOLocalMove(handImgEndPos,handImgDurTime)
--            coroutine.waitforseconds(handImgDurTime)
--            self.handImg:DOFade(0,0.3)
--            self.dragState = 1
--        end)
--    end
--end


local function Play(self, card)
    coroutine.waitforseconds(4) --等待前半部分特效播放
    --self.ef_hand:Pause()
    self.ef_jz:Pause()
  --  self.ef_glow1:Pause()
    coroutine.start(function()
        coroutine.waitforseconds(2.5)
        --self.ef_hand:Play()
        self.ef_jz:Play()
     --   self.ef_glow1:Play()
    end)
    self.uiDrawing:CoPlayImage(card.TemplateId, self.model.info.previousSkinId)

    local zSkin = Z_Skin[self.model.info.previousSkinId]

        if self.uiDrawing.showMode == 2 and zSkin.IsSpine == 1 then
            self.uiDrawing:ChangeMode(card.TemplateId, self.model.info.previousSkinId)
        end
    --local img = self.uiDrawing.prefab.transform:Find("Drawing"):GetComponent("Image")
    self.uiDrawing:DOFade(1,0.5) --显示立绘
    coroutine.waitforseconds(2)
    self.uiDrawing:DOFade(0,0.5) --关闭立绘
    --self.effect_hand:DOLocalMove(handEndPos,handDurTime)
    coroutine.waitforseconds(4)
    
    -- if self.model.info.previousSkinId ~= card.SkinId then
    --     self.uiDrawing:CoPlayImage(card.TemplateId, card.SkinId)

    --     local zSkin = Z_Skin[card.SkinId]

    --     if self.uiDrawing.showMode == 2 and zSkin.IsSpine == 1 then
    --         self.uiDrawing:ChangeMode(card.TemplateId, card.SkinId)
    --     end
    -- end
    self.uiDrawing:DOFade(0, 0)
    --self.ef_hand:Pause()
    --self.ef_jz:Pause()
    --EventTriggerListener.Get(self.gameObject).onLuaDragHandler = function()OnDrag(self) end
    --EventTriggerListener.Get(self.gameObject).onLuaDragBeginHandler = function()OnDragBegin(self) end
    --while(true) do
    --    if self.dragState == 1 then
    --        break
    --    end
    --    coroutine.waitforseconds(0.1)
    --end
    --print(11111)
    --self.ef_hand:Play()
    --print(22222)
    --self.ef_jz:Play()
    --print(33333)
    --self.effect_jz:DOLocalMove(jzEndPos,jzDurTime)
    --print(44444)
    --coroutine.waitforseconds(jzDurTime + 0.3)
    --table.csenuObject(self.effect_jz,function(v)
    --    v.gameObject:SetActive(true)
    --end)
    --UIPublic.PlayEffect(self.effect_jz:Find("Glwo"))
    --coroutine.waitforseconds(2)
    --GameObject.Destroy(self.ef_hand)
    --GameObject.Destroy(self.ef_jz)
    
    coroutine.waitforseconds(3)
    self.uiDrawing:DOFade(1,1.8)
    coroutine.waitforseconds(2) --2.5
   -- UIPublic.FadeAllChild(self.talkRoot,1,0.5)
   -- local zSkin = table.first(Z_Skin, function (v) return card.TemplateId == v.BelongCard and v.MarryUnlock == 1 end)
   -- if zSkin ~= nil then
   --     self.uiDrawing:CoPlayImage(card.TemplateId, zSkin.Stage)
   -- else
   --     self.uiDrawing:CoPlayImage(card.TemplateId, card.SkinId)
   -- end
    -- 測試用
    --for i = 1001, 1036 do
    --	local zSkins = table.choose(Z_Skin,function(k,v) return v.BelongCard == i end)
    --	local tempSkins = {}
    --	table.walk(zSkins, function (k, v)
    --		tempSkins[v.SortId] = v
    --	end)
    --	table.walk(tempSkins, function (k, v)
    --        coroutine.waitforseconds(0.5)
    --        self.uiDrawing.cardId = v.BelongCard
    --        self.uiDrawing.stage = v.Stage
    --        self.uiDrawing:CoPlayForceWithoutCallback()
    --	end)
    --end
    self.uiDrawing:CoPlayForceWithoutCallback()
    coroutine.waitforseconds(3)
    self.ef_beijing:Pause()
end

local function InitTalkRoot(self,card)
    local zCard = Z_Card[card.TemplateId]
    local transform = self.talkRoot
    local nameTxt = transform:Find("NameTxt"):GetComponent("Text")
    local talkTxt = transform:Find("TalkTxt"):GetComponent("Text")
    nameTxt.text = zCard.Name 
    talkTxt.text = "暂未配置" -- ignoreCN
end

function this.OnCreate(self)
    base.OnCreate(self)
    self.paint = self.rc:GetObject("Paint"):GetComponent("Image")
    self.handImg = self.rc:GetObject("Hand"):GetComponent("Image")
    self.audio = self.gameObject:GetComponent(typeof(AudioSource))
    self.audio1 = self.gameObject.transform:Find("EventBg"):GetComponent(typeof(AudioSource))
    self.audio:Stop()
    self.handImg:DOFade(0,0)
    self.rawImage = self.rc:GetObject("RawImage"):GetComponent("RawImage")
    self.talkRoot = self.rc:GetObject("TalkBg").transform
    self.spinePic = self.rc:GetObject("SpinePic")
    self.paintRoot = self.rc:GetObject("PaintRoot")
    UIPublic.FadeAllChild(self.talkRoot,0,0)
    self.uiDrawing = UIDrawing.New(self.paintRoot, self.paint, self.spinePic, SoundType.Marry, UIWindowNames.UIHome, self.rc:GetObject("Lines"))
    self.uiDrawing:changeType(ShowGirlShowType.Marry)
end

function this.OnEnable(self)
    base.OnEnable(self)
    Game.Scene:GetComponent("SoundComponent"):Stop()
    self.dragState = 0
    local card = self.model.info.card
    local rect = self.handImg.transform:GetComponent("RectTransform")
    InitTalkRoot(self,card)
    UIPublic.FadeAllChild(self.talkRoot,0,0)
    EventTriggerListener.Get(self.gameObject).onLuaDragHandler = nil
    EventTriggerListener.Get(self.gameObject).onLuaDragBeginHandler = nil
    self.handImg:DOFade(0,0)
    self.paint:DOFade(0,0)
    coroutine.waitforseconds(0.3)
    rect:DOLocalMove(handImgDefPos,0)
    self.handImg:DOFade(0,0)
    self.audio.volume = ClientData:GetInstance():GetVolume("SoundVolume")
    self.audio1.volume =self.audio.volume
    
    self.uiEffectComponent = Game.Scene:GetComponent("UIEffectComponent")
    self.effect = self.uiEffectComponent:LoadEffect(effectName)
    --self.effect_hand = self.effect.transform:Find("Shou")
    self.effect_jz = self.effect.transform:Find("JieZhi")
    local camera = self.effect.transform:Find("Camera"):GetComponent("Camera")
    self.rawImage.texture = camera.targetTexture
    self.audio1:Play()
    coroutine.start(function()
        Game.Scene:GetComponent("BgmComponent"):CoPlay(BgmType.UI,"GetMarry")
    end)
    --table.csenuObject(self.effect_jz,function(v)
    --    v.gameObject:SetActive(false)
    --end)
    
    --self.ef_hand = self.effect_hand:GetComponent("ParticleSystem")
    self.ef_beijing = self.effect.transform:Find("BeiJing"):GetComponent("ParticleSystem")
    self.ef_jz = self.effect_jz:GetComponent("ParticleSystem")
    self.ef_glow1 =  self.effect.transform:Find("Glow1"):GetComponent("ParticleSystem")

    --self.effect_hand:DOLocalMove(handDefPos,0)
    --self.effect_jz:DOLocalMove(jzDefPos,0)
    
    --UIPublic.SetCardOriginal(card.TemplateId,self.paint,card.SkinId,1)
    if self.model.info.callback ~= nil then
        self.model.info.callback()
    end
    Play(self,card)
    UIUtil.OpenSkipHint(function() UIManager:GetInstance():CloseWindow(UIWindowNames.UIGetMarried) end,2)
   
    self:OnRefresh()
end

function this.OnRefresh(self) 
    
end

function this.OnAddListener(self)
    base.OnAddListener(self)
end

function this.OnRemoveListener(self)
    base.OnRemoveListener(self)
end

function this.OnDisable(self)
    base.OnDisable(self)
    -- self.uiDrawing:changeType(ShowGirlShowType.Original)
    self.handImg:DOFade(0,0)
    UIPublic.FadeAllChild(self.talkRoot,0,0)
    self.audio:Stop()
    Game.Scene:GetComponent("SoundComponent"):Stop()
    coroutine.start(function ()
        coroutine.waitforframes(3)
        Game.Scene:GetComponent("BgmComponent"):CoPlay(BgmType.UI,"Home")
        local marryInfo = self.model.info.marryInfo
        if marryInfo ~= nil and table.count(marryInfo) > 0 then -- 如果解锁了皮肤
            local info = marryInfo[1]
            local zSkin = table.first(Z_Skin, function (v) return info.templateId == v.Id end)
            if zSkin ~= nil then
                UIManager:GetInstance():OpenWindow(UIWindowNames.UIReward, {rewards = marryInfo, title = LangUtil.GetSysLang(1068)..":"..zSkin.Name.."X1"})
                UIUtil.ToolTipFourth(LangUtil.GetSysLang(1068)..":"..zSkin.Name.."X1");--获得皮肤
            end
        end
    end)
    self.uiEffectComponent:Remove()
    self.effect = nil
    self.uiDrawing:Disable()
    UIManager:GetInstance():OpenWindow(UIWindowNames.UIComTop)
    
end

function this.OnDestroy(self)
    base.OnDestroy(self)
end

return this;

