---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by win 10.
--- DateTime: 2019/4/3 13:59
---

local UISevenStarCtrl = BaseClass("UISevenStarCtrl",UIBaseCtrl)
local this = UISevenStarCtrl

local function OnSectionChg(self,id,difficulty)
    UIData.SetSectionId(id,difficulty);
end

local function LaunchAtk(data)
    local ac = Game.Scene:GetComponent("AgainstComponent")
    ac:SetCurLevel(data)
    Game.Scene.SceneComponent:SwitchScene(SceneConfig.BattleScene)
end

local function OpenFormatWindow(self)
    UIManager:GetInstance():OpenWindow(UIWindowNames.UIFormatNew);
end

local function OpenReadyWindow(self,data)
    UIUtil.OpenFormat(data);
end




local expendStarStone = 100

local function SendOpenTimeRequest(self,isItem,day)
    
    local player = Game.Scene.Player
    local reqData = {}

    reqData.Id = day*10

    local buy = function()
        coroutine.start(function()
            local response =coroutine.yieldstart(Game.Scene.Session.CoCall,nil,Game.Scene.Session,
                    OuterOpcode.Name2Code.ETModel_C2M_OpenTime,reqData)
            if response.Error == ErrorCode.ERR_Success then
                if reqData.ExpendFreeStarStone ~= nil then
                    player.FreeStarStone = player.FreeStarStone - reqData.ExpendFreeStarStone
                end
                if reqData.ExpendPaidStarStone ~= nil then
                    player.PaidStarStone = player.PaidStarStone - reqData.ExpendPaidStarStone
                end
                player:GetComponent("SevenStarComponent").Days[day].OpenTime = response.OpenDateTime
                if reqData.ExpendMaterialList ~= nil then
                    for k ,v in pairs(reqData.ExpendMaterialList) do
                        UIUtil.RemoveItem(v.MaterialId,v.Amount)
                    end
                end
                DataManager:GetInstance():Broadcast(DataMessageNames.ON_PLAYER_INFO_CHG)
            else
                UIUtil.ToolTipFourth(LangUtil.GetServerError(response.Error))
            end
        end)
    end
    if isItem then --使用物品
        local item = table.first(Game.Scene.Player:GetComponent("ItemComponent").Items,function(v) return v.TemplateId == 3014 end)
        local Material = {["MaterialId"]=item.Id,["Amount"] = 1}
        reqData.ExpendMaterialList={Material}
        buy()
    else --使用星石
        
        local surplusStarStone = player.FreeStarStone - expendStarStone
        if surplusStarStone < 0 then
            reqData.ExpendPaidStarStone = -surplusStarStone
            reqData.ExpendFreeStarStone = player.FreeStarStone
        else
            reqData.ExpendPaidStarStone = 0
            reqData.ExpendFreeStarStone = expendStarStone
        end
        reqData.Id = reqData.Id + 1
        buy()
    end
end


local function toolTip(self,callback)
    local tipData = {}
    local tipData1 = {}
    local tipData2 = {}
    tipData.title = LangUtil.GetSysLang(9)--"提示"
    tipData.type = 2
    tipData.startType = 0
    tipData.message = LangUtil.GetSysLang(539)--"确定使用100星石开放一小时"
    tipData.But2 = function()
        if Game.Scene.Player.FreeStarStone < 100 then
            tipData1.title = LangUtil.GetSysLang(9)--"提示"
            tipData1.type = 2
            tipData1.startType = 1
            tipData1.message = LangUtil.GetSysLang(545)--"星石不足，是否使用星光石补充?"
            tipData1.But2=function()
                if Game.Scene.Player.FreeStarStone +  Game.Scene.Player.PaidStarStone < 100 then
                    tipData2.title = LangUtil.GetSysLang(9)--"提示"
                    tipData2.type = 2
                    tipData2.startType = 2
                    tipData2.message = LangUtil.GetSysLang(546)--"星石不足，是否前往购买?"
                    tipData2.But2=function()
                        UIManager:GetInstance():CloseWindow(UIWindowNames.ToolTipFirstPlus);
                        UIManager:GetInstance():OpenWindow(UIWindowNames.UIStarLightStoneShop)
                    end
                    UIUtil.ToolTipFirstPlus(tipData2)
                else
                    if callback~=nil then callback()end
                    UIManager:GetInstance():CloseWindow(UIWindowNames.ToolTipFirstPlus);
                end
            end
            UIUtil.ToolTipFirstPlus(tipData1)
        else
            if callback~=nil then callback()end
            UIManager:GetInstance():CloseWindow(UIWindowNames.ToolTipFirstPlus);
        end

    end

    --tipData.But1=function() UIManager:GetInstance():OpenWindow(UIWindowNames.UICardList)    end

    UIUtil.ToolTipFirstPlus(tipData)
end


function this.OpenSevenStarTime(self,day)
    local item = table.first(Game.Scene.Player:GetComponent("ItemComponent").Items,function(v) return v.TemplateId == 3014 end)
    local func = function(isItem)
        SendOpenTimeRequest(self,isItem,day)
    end
    
    if item ~= nil and item.Amount>0 then
        local tipData = {}
        tipData.title = LangUtil.GetSysLang(9)
        tipData.type = 5
        tipData.startType =1
        tipData.message = LangUtil.GetSysLang(538)--"是否优先消耗'时之沙漏'开放此模式1小时?"
        tipData.Amount = item.Amount
        tipData.TemplateId = 3014
        --tipData.ExpenseNum = 1 --需要消耗一张
        --tipData.Amount = item.Amount
        tipData.But2 = function()
            func(true)
        end
        UIUtil.ToolTipFirstPlus(tipData)
    else
        local tipData = {}
        tipData.title = LangUtil.GetSysLang(9)
        tipData.type = 5
        tipData.startType = 2
        tipData.message = LangUtil.GetSysLang(1095)--"是否优先消耗'时之沙漏'开放此模式1小时?"
        tipData.Amount = 0
        tipData.TemplateId = 3014
        --tipData.ExpenseNum = 1 --需要消耗一张
        --tipData.Amount = item.Amount
        tipData.But2 = function()
            UIManager:GetInstance():OpenWindow(UIWindowNames.UIGeneralShop)
        end
        
        UIUtil.ToolTipFirstPlus(tipData)
    end
    
end

local function OnOpenMonsterMessageWindow(monsterData)
    local showData = {};
    showData.monster = monsterData;
    showData.showType = 4;
    UIUtil.OpenThingsDetailWindow(showData);
end

local function OnOpenItemMessageWindow(gameObject)
    local showData = gameObject:GetComponent("BindData"):Get("showData");
    UIUtil.OpenThingsDetailWindow(showData);
end

local function CloseSelf()
    UIManager:GetInstance():CloseWindow(UIWindowNames.UISevenStar);
end

local function OpenIntensWindow()
    UIManager:GetInstance():OpenWindow(UIWindowNames.UIMainIntens);
end

local function SendRestRequest(self,expendStarStone,isItem,diff,day)
    PublicRequest.SendOpenBattleModeRequest(expendStarStone,isItem,diff,day)
end

UISevenStarCtrl.LaunchAtk = LaunchAtk
UISevenStarCtrl.OpenIntensWindow = OpenIntensWindow
UISevenStarCtrl.OnSectionChg = OnSectionChg
UISevenStarCtrl.OnOpenMonsterMessageWindow = OnOpenMonsterMessageWindow
UISevenStarCtrl.OnOpenItemMessageWindow = OnOpenItemMessageWindow
UISevenStarCtrl.OpenFormatWindow = OpenFormatWindow
UISevenStarCtrl.CloseSelf = CloseSelf
UISevenStarCtrl.OpenReadyWindow = OpenReadyWindow
UISevenStarCtrl.SendRestRequest = SendRestRequest


return UISevenStarCtrl