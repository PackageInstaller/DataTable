---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by win 10.
--- DateTime: 2019/4/3 13:59
---

local UILordRoadView = BaseClass("UILordRoadView",UIBaseView);
local base = UIBaseView;
local this = UILordRoadView

local pfbName = "LordRoadItem"


local function InitSectionPanel(self,zStoryLevel)
    local info = {zStoryLevel = zStoryLevel}
    UIManager:GetInstance():OpenWindow(UIWindowNames.UILordRoadSectionInfo,info)
end

local function InitSectionItem(self,gameObject,zLordRoad,isActive)
    local zStoryLevel = Z_LordRoadLevel[zLordRoad.LevelId]
    local transform = gameObject.transform
    local icon = transform:Find("Icon/Value"):GetComponent("Image")
    local nameTxt = transform:Find("Icon/Value/Text"):GetComponent("Text")
    local descTxt = transform:Find("Desc"):GetComponent("Text")
    local apTxt = transform:Find("Ap"):GetComponent("Text")
    local levelTxt = transform:Find("Level"):GetComponent("Text")
    local isPort = transform:Find("Icon/IsPort").gameObject
    local button = transform:Find("Button").gameObject
    local deButton =  transform:Find("Button/De").gameObject
    local select = transform:Find("Select").gameObject
    local lockImage = transform:Find("LockImage").gameObject
    LangUtil.BindText(nameTxt)
    LangUtil.BindText(descTxt)
    LangUtil.BindText(apTxt)
    LangUtil.BindText(levelTxt)
    LangUtil.BindText(button.transform:Find("Text"))

    deButton:SetActive(false)
    select:SetActive(false)
    isPort:SetActive(false)
    lockImage:SetActive(false)
    descTxt.text = zLordRoad.Name
    apTxt.text = "AP " .. zStoryLevel.EnergyExpend
    levelTxt.text = string.gsub(LangUtil.GetSysLang(502),"X",zLordRoad.Id - 100)--"第"..(zLordRoad.Id - 100).."关"
    --isPort:SetActive(zLordRoad.Id <= self.completedLordRoad)
    --isPort:SetActive(false)
    UIUtil.AddBtnEvent(button,function() InitSectionPanel(self,zStoryLevel)  end)


    if isActive == false then
        lockImage:SetActive(true)
        LangUtil.BindText(transform:Find("LockImage/Text")).text =LangUtil.GetSysLang(495)
        UIPublic.InitButton(button,false,1,LangUtil.GetSysLang(494))
    else
        UIPublic.InitButton(button,true,1,LangUtil.GetSysLang(494))
        if zLordRoad.Id ~= self.completedLordRoad + 1 then
            deButton:SetActive(true)
            isPort:SetActive(true)
            LangUtil.BindText(deButton.transform:Find("Text")).text=LangUtil.GetSysLang(493)
        else
            select:SetActive(true)
        end
    end
    
end


local function InitSectionContent(self)
    self.secContent.gameObject:SetActive(false)
    coroutine.start(function()
        for k,v in table.pairsByKeys(Z_LordRoad) do
            if k - self.completedLordRoad  <= 1  then
                ListChildPool:GetInstance():GetChild(pfbName,self.secContent,function(gameObject)
                    if self.active == false then ListChildPool:GetInstance():Remove(gameObject) end
                    InitSectionItem(self,gameObject,v,true)
                end)
            elseif k - self.completedLordRoad  <= 2  then
                ListChildPool:GetInstance():GetChild(pfbName,self.secContent,function(gameObject)
                    if self.active == false then ListChildPool:GetInstance():Remove(gameObject) end
                    InitSectionItem(self,gameObject,v,false)
                end)
            end
        end
        coroutine.waitforframes(2)
        for i = 0,self.secContent.transform.childCount - 1 do
            self.secContent.transform:GetChild(i):SetAsFirstSibling()
        end
        self.secContent:SetActive(true)
        self.secContent.transform.parent.parent:GetComponent("ScrollRect"):DOVerticalNormalizedPos(1,0)
    end)
end



function this.OnCreate(self)
    base.OnCreate(self);
    self.secContent = self.rc:GetObject("Content")
    self.backBtn = self.rc:GetObject("BackButton")
    
    UIUtil.AddBtnEvent(self.backBtn,function(go) 
        self.ctrl:CloseSelf() 
        --if UIManager:GetInstance():GetWindow(UIWindowNames.UIBattleMode) == nil then
        --local window =UIManager:GetInstance():GetWindow(UIWindowNames.UIHome)
        --local view =window.View
        --view:ToolTip()
        --end 
    end,"Back")
    self.TipsPanel = self.rc:GetObject("TipsPanel").transform
    local TipsBgBtn = self.rc:GetObject("TipsBgBtn")
    local TipsBtn = self.TipsPanel:Find("TipsBtn")
    local Tips = self.TipsPanel:Find("Tips").gameObject
    Tips:SetActive(false)
    TipsBgBtn:SetActive(false)
    UIUtil.AddBtnEvent(TipsBtn,function(go)
        local localActive = Tips.activeInHierarchy
        TipsBgBtn:SetActive(not localActive)
        Tips:SetActive(not localActive)
    end)
    UIUtil.AddBtnEvent(TipsBgBtn,function(go)
        Tips:SetActive(false)
        TipsBgBtn:SetActive(false)
    end)
end

function this.OnLangCreate(self)
    LangUtil.BindText(self.backBtn.transform:Find("Text")).text = LangUtil.GetSysLang(105)
    LangUtil.BindText(self.TipsPanel:Find("Tips/Text")).text = LangUtil.GetSysLang(4050)
    
    local intensBtn = self.rc:GetObject("Intens")
    local formatBtn = self.rc:GetObject("Format")
    LangUtil.GetSpriteLang(120, function(sprite) intensBtn:GetComponent("Image").sprite = sprite end)
    LangUtil.GetSpriteLang(19, function(sprite) formatBtn:GetComponent("Image").sprite = sprite end)
    UIUtil.AddBtnEvent(intensBtn,function() UIManager:GetInstance():OpenWindow(UIWindowNames.UIMainIntens)  end)
    UIUtil.AddBtnEvent(formatBtn,function() UIManager:GetInstance():OpenWindow(UIWindowNames.UIFormatNew)  end)
end

function this.OnEnable(self)
    base.OnEnable(self);
    --local againstComponent = Game.Scene:GetComponent("AgainstComponent")
    local guide=Game.Scene:GetComponent("GuideComponent")
    local Story=Game.Scene.Player:GetComponent("StoryComponent")
    local guideStep2 = table.first(guide.GuideList,function (v) return v.Id== 11001  end) --信条
    --if Game.Scene:GetComponent("AgainstComponent").BattleWin and
    --        againstComponent.LevelType == LevelType.LevelTypeTower  then--解锁第一个信条技能后跳转到home场景
        if Story.CompletedLordRoad >= 101 and  (guideStep2 == nil or guideStep2.Step < 9) then
            guide:CheckStart(10,0)
        end
    --end
    self:OnRefresh()
end

function this.OnRefresh(self)
    self.player = Game.Scene.Player
    local storyComponent =  self.player:GetComponent("StoryComponent")
    self.completedLordRoad = storyComponent.CompletedLordRoad
    if self.completedLordRoad == 0 then self.completedLordRoad = 100 end 
    self.selectLevel = 101
    InitSectionContent(self)
end


function this.OnAddListener(self)
    base.OnAddListener(self);
end

function this.OnRemoveListener(self)
    base.OnRemoveListener(self);
end

function this.OnViewTop(self)
    base.OnViewTop(self)
    UIManager:GetInstance():OpenWindow(UIWindowNames.UIComTop)
end

function this.OnDisViewTop(self)
    base.OnDisViewTop(self)
    UIManager:GetInstance():CloseWindow(UIWindowNames.UIComTop)
end

function this.OnDisable(self)
    base.OnDisable(self);
    ListChildPool:GetInstance():ClearContent(self.secContent)
end

function this.OnDestroy(self)
    base.OnDestroy(self);
end

return this

