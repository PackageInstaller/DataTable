---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by win 10.
--- DateTime: 2019/4/16 19:10
---
local UIShowEquipView = BaseClass("UIShowEquipView",UIBaseView);
local base = UIBaseView;
local this = UIShowEquipView;

local recordOrder = {order = 1,kind = 1}  --是否正序  顺序类型
local screenTypes = {star = 0,Part = 0,exclusive = 0,isEquip = 0}
local pfbName = "EquipItemNew"



local function IsAgreeEquip(self,zEquip)
    local zCard = Z_Card[self.cardId]
    if zEquip.Exclusive ~=0 and zEquip.Exclusive ~= zCard.Id then
        return false
    end
    if zEquip.AtkRange ~= zCard.AtkType and zEquip.AtkRange ~= 3 then
        return false
    end
    if zCard.MainProp ~= zEquip.AtkType and zEquip.AtkType ~= 3 and zEquip.AtkType ~=0 then
        return false
    end
    return true
end

local function OnEquip(self,equip)
    if self.equip == nil then
        UIManager:GetInstance():OpenWindow(UIWindowNames.UIEquipChangeState1,{equip = equip,part = self.part,card = self.card,
                                                                              state = 1})
    else
        UIManager:GetInstance():OpenWindow(UIWindowNames.UIEquipChangeState2,{equip1 = self.equip,equip2 = equip,part = self.part})
    end
end

local function InitEquipListData(self)
    self.list = {}
    for k,v in table.pairsByKeys(self.equipList) do
        local zEquip = Z_Equip[v.TemplateId]
        if IsAgreeEquip(self,zEquip) then
            table.insert(self.list,v)
        end
    end
    
    self.list = UIPublic.EquipScreenFunc(self.list,screenTypes)
    table.sort(self.list, function(a,b) return UIPublic.EquipSortFunc(a,b,recordOrder)end )

    if recordOrder.order ~= 1 then
        self.list = table.reverseTable(self.list)
    end
    
end

local function InitEquipList(self)
    self.hint:SetActive(table.count(self.list) == 0)
    self.holdTxt.text = table.count(self.list)
    self.scroll:Clear()
    self.scroll:ScrollInit(self.list, self.scrollView, pfbName, function (arg)
        local gameObject = arg.go
        local equip = arg.data
        UIUtil.AddBtnEvent(gameObject,function()OnEquip(self,equip) end)
        UIPublic.InitEquipItemNew(gameObject.transform,equip,true)
    end)
end


local function InitOrderButton(self)
    local txt = self.sortBtn.transform:Find("Text"):GetComponent("Text")
    txt.text = (recordOrder.order == 1 and {LangUtil.GetSysLang(154)} or {LangUtil.GetSysLang(153)})[1]
end

local function OnSort(self)
    recordOrder.order = (recordOrder.order == 1 and {2}or {1})[1]
    InitOrderButton(self)
    InitEquipListData(self)
    InitEquipList(self)
end

local function OnScreen(self)
    local uiData = {}
    uiData.recordOrder = recordOrder
    uiData.screenTypes = screenTypes
    uiData.callBack = function(list,kind)
        screenTypes = table.clone(list)
        recordOrder.kind = kind
        InitEquipListData(self)
        InitEquipList(self)
    end
    UIManager:GetInstance():OpenWindow(UIWindowNames.UIEquipSort2,uiData)
end

function this.OnLangCreate(self)
    LangUtil.BindText(self.langRc:GetObject("HoldValue"),FontType.All_Number)
    LangUtil.BindText(self.langRc:GetObject("HoldText")).text = LangUtil.GetSysLang(312)
    LangUtil.BindText(self.langRc:GetObject("ScreenText")).text =LangUtil.GetSysLang(155)
    LangUtil.BindText(self.langRc:GetObject("SortText"))
    LangUtil.BindText(self.langRc:GetObject("BackText"))
end

function this.OnCreate(self)
    base.OnCreate(self)
    local backBtn = self.rc:GetObject("BackButton")
    self.scroll = VerticalScroll.New()
    self.scroll:SetUpdateCount(40)
    self.scrollView = self.rc:GetObject("Scroll View"):GetComponent("ScrollRect")
    self.hint = self.rc:GetObject("Hint")
    self.sortBtn = self.rc:GetObject("Sort")
    self.screenBtn = self.rc:GetObject("Screen")
    self.uiNameTxt = self.rc:GetObject("UIName"):GetComponent("Text")
    self.content = self.rc:GetObject("Content")
    
    self.holdTxt = self.rc:GetObject("HoldNum"):GetComponent("Text")
    UIUtil.AddBtnEvent(self.sortBtn,function() OnSort(self)  end)
    UIUtil.AddBtnEvent(self.screenBtn,function() OnScreen(self)  end)
    UIUtil.AddBtnEvent(backBtn,function() self.ctrl:CloseSelf() end,"Back")
   
end

function this.OnEnable(self)
    base.OnEnable(self);
    self:OnRefresh();
end

function this.OnRefresh(self)
    self.EquipPartName = {LangUtil.GetSysLang(243),LangUtil.GetSysLang(244),LangUtil.GetSysLang(245),LangUtil.GetSysLang(246),
                          LangUtil.GetSysLang(247),LangUtil.GetSysLang(248)}
    self.equips = Game.Scene.Player:GetComponent("EquipComponent").Equips
    self.equip = self.model.data.equip
    self.part = self.model.data.part
    self.equipList = self.model.data.equipList
    self.card = self.model.data.card
    self.cardId = self.card.TemplateId
    self.uiNameTxt.text = self.EquipPartName[self.part]
    self.holdTxt.text = table.count(self.equipList).."/"..table.count(Z_Equip)
    InitEquipListData(self)
    InitEquipList(self)
    InitOrderButton(self)
end

function this.OnAddListener(self)
    base.OnAddListener(self);
end

function this.OnRemoveListener(self)
    base.OnRemoveListener(self);
end

function this.OnDisable(self)
    base.OnDisable(self);
    self.scroll:Dispose()
end

function this.OnDestroy(self)
    base.OnDestroy(self);
end

return this;


