---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by win 10.
--- DateTime: 2019/5/24 16:58
---

local UIBattleLoseView = BaseClass("UIBattleLoseView",UIBaseView);
local base = UIBaseView
local this = UIBattleLoseView

local losePrefab = "UI/Effects/Battle/Failure.prefab"

function this.OnCreate(self)
    base.OnCreate(self);
    
    self.expArea = self.rc:GetObject("ExpBar"):GetComponent("Image")
    self.img1 = self.rc:GetObject("Img1"):GetComponent("Image")
    self.img2 = self.rc:GetObject("Img2"):GetComponent("Image")
    self.efx = nil
    EventTriggerListener.Get(self.gameObject).onLuaClick = function()
        Game.Scene:GetComponent("BattleComponent").fsm:Switch(BattleState.LeaveScene)
    end
end

function this.OnLangCreate(self)
    self.levelTxt = LangUtil.BindText(self.rc:GetObject("Level"), FontType.All_Number)
    LangUtil.BindText(self.rc:GetObject("ContinueText")).text = LangUtil.GetSysLang(3022)--点击继续
    
end

function this.OnEnable(self)
    base.OnEnable(self);

    self.img1:DOFade(0, 0)
    self.img2:DOFade(0, 0)
    self.img1.transform:DOScale(0, 0)
    self.img2.transform:DOScale(0, 0)

    Game.Scene:GetComponent("PlayerBattleComponent"):PlayAnim(PlayerAnim.Failure)
    Game.Scene:GetComponent("BgmComponent"):Stop()
    
    coroutine.start(function ()
        self.efx = GameObjectPool:GetInstance():CoGetGameObjectAsync(losePrefab)
        self.efx.transform:DOShakePosition(1,20,100,90);
        self.efx.transform:SetParent(self.gameObject.transform, false)
        table.csenu(self.efx:GetComponentsInChildren(typeof(Transform)),function (v)
            v.gameObject.layer = LayerMask.NameToLayer("UI")
        end)
        table.csenu(self.efx:GetComponentsInChildren(typeof(CS.UnityEngine.ParticleSystemRenderer)),function (smr)
            smr.sortingOrder = self.canvas.unity_canvas.sortingOrder + 1
        end)
        Game.Scene:GetComponent("SoundComponent"):CoPlay(CommonSoundPath.battleLose)
        --Game.Scene:GetComponent("BgmComponent"):CoPlay(BgmType.UI, "BattleLose", true)
        self.img1.transform:DOScale(1, 0.2)
        self.img2.transform:DOScale(1, 0.2)
        self.img1:DOFade(1, 0.2)
        self.img2:DOFade(1, 0.2)
        local IsAAutoGame = Game.Scene:GetComponent("AgainstComponent").IsAutoGame
        if IsAAutoGame ~= nil and IsAAutoGame ~= 0 then
            Game.Scene:GetComponent("BattleComponent").fsm:Switch(BattleState.LeaveScene)
        end
    end)
    
    local player = Game.Scene.Player
    self.levelTxt.text = "LV."..player.Level
    if player.Level == maxLevel then
        self.expArea.value = 1
    else
        local next_level_exp = Z_PlayerLevelUp[player.Level + 1].Exp
        self.expArea.fillAmount = player.Exp / next_level_exp
    end
end

function this.OnDisable(self)
    if self.efx ~= nil then
        GameObjectPool:GetInstance():RecycleGameObject(losePrefab, self.efx)
    end
end

return this;

