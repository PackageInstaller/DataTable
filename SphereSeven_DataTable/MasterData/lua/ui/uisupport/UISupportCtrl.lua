---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by win 10.
--- DateTime: 2019/6/14 11:39
---

local UISupportCtrl = BaseClass("UISupportCtrl",UIBaseCtrl)
local this = UISupportCtrl;

function this.CloseSelf(self)
    UIManager:GetInstance():CloseWindow(UIWindowNames.UISupport);
end

function this.ChangeSupCard(self,supCardId,index)
    UIManager:GetInstance():CloseWindow(UIWindowNames.UISupport);
    local team = UIData.GetCurTeam();
    local matrixPos;
    if index ~= nil then
        local supDetail = table.first(team.TeamDetailList,function(v) return v.IsSupport == true end)
        if supDetail ~= nil then
            matrixPos = supDetail.MatrixPos;
        end
    end
    UIUtil.ClearSupportCard();
    if supCardId ~= nil then
        local TeamDetail = {};
        TeamDetail.CardId = supCardId;
        if matrixPos ~= nil then
            TeamDetail.MatrixPos = matrixPos;
        else
            TeamDetail.MatrixPos = -1;
        end
        TeamDetail.IsSupport = true;
        if index ~= nil then
            table.insert(team.TeamDetailList,index,Game.Registry:NewObject("TeamDetail",TeamDetail));
        else
            table.insert(team.TeamDetailList,Game.Registry:NewObject("TeamDetail",TeamDetail));
        end
    end
    DataManager:GetInstance():Broadcast(DataMessageNames.ON_FORMAT_DATA_CHG);
end

function this.SendTeamChgReq(self,cardData,team,supportCardId)
    local c2gTeamAdjust = {};
    local cur_Team =team;
    c2gTeamAdjust.TeamNo = cur_Team.TeamNo;
    c2gTeamAdjust.BattleArrayNo = cur_Team.BattleArrayNo;
    c2gTeamAdjust.EnhanceType = cur_Team.EnhanceType;
    c2gTeamAdjust.TeamDetailInfoList = {};
    local card_list = team.TeamDetailList;
    local matrixPos;
    for i = 1, #card_list do
        if card_list[i].CardId ~= cardData.card.Id then
            local tab = {};
            tab.CardId = card_list[i].CardId;
            tab.MatrixPos = card_list[i].MatrixPos;
            table.insert(c2gTeamAdjust.TeamDetailInfoList,tab);
        else
            matrixPos = card_list[i].MatrixPos;
        end
    end
    c2gTeamAdjust.AdjustType = 0;
    coroutine.start(function()
        local g2cTeamAdjust = coroutine.yieldstart(Game.Scene.Session.CoCall, nil,  Game.Scene.Session,
                OuterOpcode.Name2Code.ETModel_C2M_TeamAdjust, c2gTeamAdjust);
        if g2cTeamAdjust.Error == ErrorCode.ERR_Success then
            for k,v in table.pairsByKeys(Game.Scene.Player:GetComponent("TeamComponent"):GetTeams()) do
                if v.TeamNo == c2gTeamAdjust.TeamNo then
                    v.BattleArrayNo = c2gTeamAdjust.BattleArrayNo;
                    v.TeamDetailList = c2gTeamAdjust.TeamDetailInfoList;
                    local tab = {};
                    tab.CardId = supportCardId;
                    tab.MatrixPos = matrixPos;
                    tab.IsSupport = true;
                    table.insert(v.TeamDetailList,cardData.index,tab);
                    break;
                end
            end
            UIManager:GetInstance():CloseWindow(UIWindowNames.UISupport);
            DataManager:GetInstance():Broadcast(DataMessageNames.ON_FORMAT_DATA_CHG);
        end
    end)
end


return this;