---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by win 10.
--- DateTime: 2019/4/22 9:52
---

local UIFightSoulIntensView = BaseClass("UIFightSoulIntensView",UIBaseView);
local this = UIFightSoulIntensView;
local base = UIBaseView

local VisitLogic = require "UI/UIIntens/UIFightSoulIntens/UIFightSoulIntensLogic/VisitLogic";
local ChangeLogic = require "UI/UIIntens/UIFightSoulIntens/UIFightSoulIntensLogic/ChangeLogic";
local FuseLogic = require "UI/UIIntens/UIFightSoulIntens/UIFightSoulIntensLogic/FuseLogic";
local ResolveLogic = require "UI/UIIntens/UIFightSoulIntens/UIFightSoulIntensLogic/ResolveLogic";

function this.OpenPanel(self,id)
    --if self.cur_card == nil and id == 2 then
    --    return
    --end
    self.panel_id = id
    for k,v in pairs(self.panels) do
        if id == k then
            v:SetActive(true);
        else
            v:SetActive(false);
        end
    end

    for k,v in pairs(self.btns)do
        if k == id then
            v.transform:Find("Active").gameObject:SetActive(true)
            --v.transform:Find("Text"):GetComponent("Text").color = selectColor
            v:GetComponent("Button").enabled = false
        else
            v.transform:Find("Active").gameObject:SetActive(false)
            v:GetComponent("Button").enabled = true
            --v.transform:Find("Text"):GetComponent("Text").color = defColor
        end
    end

    self.func_tab[id](self);
end



function this.OnLangCreate(self)
    local btnRoot = self.langRc:GetObject("ButtonRoot").transform
    for i = 0, 3 do
        local id = 75 + i*2
        LangUtil.GetSpriteLang(id,function(sprite)
            btnRoot:GetChild(i):Find("bg"):GetComponent("Image").sprite = sprite
        end)
        LangUtil.GetSpriteLang(id+1,function(sprite)
            btnRoot:GetChild(i):Find("Active"):GetComponent("Image").sprite = sprite
        end)
    end
    
    LangUtil.BindText(self.langRc:GetObject("ReturnButton").transform:Find("Text")).text = LangUtil.GetSysLang(138)
    VisitLogic.OnLangCreate(self,self.panels[1])
    ChangeLogic.OnLangCreate(self,self.panels[2])
    FuseLogic.OnLangCreate(self,self.panels[3])
    ResolveLogic.OnLangCreate(self,self.panels[4])
end

function this.OnCreate(self)
    base.OnCreate(self)
    local btnRoot = self.rc:GetObject("ButtonRoot").transform
    local panelRoot = self.rc:GetObject("PanelRoot").transform
    local returnBtn = self.rc:GetObject("ReturnButton")

   
    self.func_tab = { [1] = VisitLogic.Init,[2] = ChangeLogic.Init,[3] = FuseLogic.Init,[4] = ResolveLogic.Init}
    self.btns = {}
    self.panels = {}

    for i = 0,btnRoot.childCount -1 do
        local child = btnRoot:GetChild(i).gameObject
        self.btns[i+1] = child 
        UIUtil.AddBtnEvent(child,function ()self:OpenPanel(i+1) end)
    end

    for i = 0,panelRoot.childCount -1 do
        local child = panelRoot:GetChild(i).gameObject
        self.panels[i+1] = child
    end

    UIUtil.AddBtnEvent(returnBtn,function()UIManager:GetInstance():DestroyWindowNoRecycle(UIWindowNames.UIFightSoulIntens) end)

    
    VisitLogic.OnCreate(self)
    ChangeLogic.OnCreate(self)
    FuseLogic.OnCreate(self)
    ResolveLogic.OnCreate(self)

    --新手引导
    local guide=Game.Scene:GetComponent("GuideComponent")
    local guideData = table.first(guide.GuideList,function (h) return h.Id == 13001  end)
    if guideData == nil or guideData.Step < 11 then
        guide:CheckStart(12,0)
    end
end

function this.OnEnable(self)
    base.OnEnable(self);
    self.player = Game.Scene.Player
    self.panel_id = self.model.panel_id
    self.cur_card = self.model.cur_card
    self:OnRefresh();
end

function this.OnRefresh(self)
    self.fightSouls = self.model.fight_soul_list
    self.cards = Game.Scene.Player:GetComponent("CardComponent").Cards
    self:OpenPanel(self.panel_id);
end

local function OnFightSoulChg(self)
    VisitLogic.OnFightSoulChg(self)
    ChangeLogic.OnFightSoulChg(self)
    FuseLogic.OnFightSoulChg(self)
    ResolveLogic.OnFightSoulChg(self)
end

--新手引导

local function ON_Guide_Click(self,cid,num,isrun,minStep)
        if cid==12 and isrun then
            if num==3 and minStep==3 then
                self:OpenPanel(2)
            elseif num==8 and minStep==1   then
                self:OpenPanel(3)
            elseif num==10 and minStep==2  then
                self:OpenPanel(4)
            end
        end
end

function this.OnAddListener(self)
    base.OnAddListener(self);
    self:AddUIListener(UIMessageNames.ON_FIGHTSOUL_INFO_CHG,OnFightSoulChg);
    self:AddUIListener(UIMessageNames.ON_Guide_Click,ON_Guide_Click)
end

function this.OnRemoveListener(self)
    base.OnRemoveListener(self);
    self:RemoveUIListener(UIMessageNames.ON_FIGHTSOUL_INFO_CHG);
    self:RemoveUIListener(UIMessageNames.ON_Guide_Click)
end

function this.OnViewTop(self)
    base.OnViewTop(self)
    UIManager:GetInstance():OpenWindow(UIWindowNames.UIComTop)
end

function this.OnDisViewTop(self)
    base.OnDisViewTop(self)
    UIManager:GetInstance():CloseWindow(UIWindowNames.UIComTop)
end

function this.OnDisable(self)
    base.OnDisable(self)
    VisitLogic.OnDisable(self)
    ChangeLogic.OnDisable(self)
    FuseLogic.OnDisable(self)
    ResolveLogic.OnDisable(self)
    local window = UIManager:GetInstance():GetWindow(UIWindowNames.UIFightSoulList)
    if window ~= nil then
        window.View:ResetOrder()
    end
end

function this.OnDestroy(self)
    base.OnDestroy(self);
    VisitLogic.OnDestroy(self)
    ChangeLogic.OnDestroy(self)
    FuseLogic.OnDestroy(self)
    ResolveLogic.OnDestroy(self)
end

return this
