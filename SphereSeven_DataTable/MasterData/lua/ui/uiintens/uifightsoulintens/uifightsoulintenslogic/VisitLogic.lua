---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by win 10.
--- DateTime: 2019/4/22 9:54
---

local VisitLogic = {};
local this = VisitLogic;
local pfbName = "FightVisitItem"

local recordOrder = {order = 1,kind = 1}  --是否正序  顺序类型
local screenTypes = {
    --- 职业
    abiliType = 0,
    --- 星级
    star = 0,
    --- 稀有度
    rare = 0,
    --- 是否装备
    isEquip = 0
}



local function InitFightSoulItemData(self,fightSoul,transform,isRefresh)
    UIPublic.InitVsFightSoulItem(fightSoul,transform,isRefresh)
end




local function OnFightSoulItem(self,id)
    local fightSoul = self.fightSouls[id]
    UIManager:GetInstance():OpenWindow(UIWindowNames.UIShowFightSoulProp,{fightSoul = fightSoul,
    callBack = function() self:OpenPanel(3)end})
end




local function OnScreen(self)
    local uiData = {}
    uiData.recordOrder = recordOrder
    uiData.screenTypes = screenTypes
    uiData.callBack = function(list,kind)
        screenTypes = table.clone(list)
        recordOrder.kind = kind
        this.InitFightSoulListData(self)
        this.InitFightSoulList(self)
        self.vs_scroll:MoveTop()
    end

    UIManager:GetInstance():OpenWindow(UIWindowNames.UIFightSoulSort,uiData)
end


local function InitSortButton(self)
    local txt = self.vs_sortBtn.transform:Find("Text"):GetComponent("Text")
    txt.text = (recordOrder.order == 1 and {LangUtil.GetSysLang(154)} or {LangUtil.GetSysLang(153)})[1]
end


function this.InitFightSoulListData(self)
    self.vs_list = {}
    for k,v in table.pairsByKeys(self.fightSouls) do
        table.insert(self.vs_list,v)
    end

    self.vs_list = UIPublic.FightSoulScreenFunc(self.vs_list,screenTypes)
    table.sort(self.vs_list, function(a,b) return UIPublic.FightSoulSortFunc(a,b,recordOrder)end )

    if recordOrder.order ~= 1 then
        self.vs_list = table.reverseTable(self.vs_list)
    end
end

function this.InitFightSoulList(self)
    self.vs_hint:SetActive(table.count(self.vs_list) == 0)
    self.vs_scroll:RefreshData(self.vs_list)
end

local function OnSort(self)
    recordOrder.order = (recordOrder.order == 1 and {2}or {1})[1]
    InitSortButton(self)
    this.InitFightSoulListData(self)
    this.InitFightSoulList(self)
end



function this.Init(self)
    InitSortButton(self)
    self.vs_holdTxt.text = table.count(self.fightSouls).."/"..Game.Scene.Player.FightSoulsMax
    this.InitFightSoulListData(self)
    this.InitFightSoulList(self)
    self.vs_init = true
end


function this.OnLangCreate(self,panel)
    -- LangUtil.LangTextByName(self.langRc:GetObject("NameTextRoot"),"Text")--.text = LangUtil.GetSysLang(88)
    local langRc = panel.transform:Find("LangControl"):GetComponent("ReferenceCollector")
    local holdNum = langRc:GetObject("HoldNum").transform
    local screenBtn = langRc:GetObject("ScreenButton").transform
    local sorBtn = langRc:GetObject("SortButton").transform
    
    LangUtil.BindText(screenBtn:Find("Text")).text =LangUtil.GetSysLang(155)
    LangUtil.BindText(sorBtn:Find("Text"))
    LangUtil.BindText(holdNum:Find("Text")).text = LangUtil.GetSysLang(354)
    LangUtil.BindText(holdNum:Find("Value"),FontType.All_Number)
end


function this.OnCreate(self)
    local rc = self.panels[1]:GetComponent("ReferenceCollector")
    self.vs_scroll = VerticalScroll.New()
    self.vs_scroll:SetUpdateCount(3)
    self.vs_scrollView = rc:GetObject("Scroll View"):GetComponent("ScrollRect")
    self.vs_list ={}
    self.vs_content = rc:GetObject("Content").transform
    self.vs_holdTxt = rc:GetObject("HoldNum"):GetComponent("Text")
    self.vs_screenBtn = rc:GetObject("ScreenButton")
    self.vs_sortBtn = rc:GetObject("SortButton")
    self.vs_hint = rc:GetObject("Hint")
    
    UIUtil.AddBtnEvent(self.vs_screenBtn,function() OnScreen(self)  end)
    UIUtil.AddBtnEvent(self.vs_sortBtn,function() OnSort(self)  end)
    self.vs_scroll:Clear()
    self.vs_scroll:ScrollInit(self.vs_list, self.vs_scrollView, pfbName, function (arg)
        local gameObject = arg.go
        local fightSoul = arg.data
        InitFightSoulItemData(self,fightSoul,gameObject.transform)
        UIUtil.AddBtnEvent(gameObject,function()OnFightSoulItem(self,fightSoul.Id)  end)
    end)
end

function this.OnFightSoulChg(self)
    if self.vs_init then
        this.Init(self)
    end
end

function this.OnDisable(self)
    if self.vs_init then
        self.vs_scroll:Dispose()
        self.vs_init = false
    end
    screenTypes = {star = 0, rare = 0, isEquip = 0}
    recordOrder.order = 1
end

function this.OnDestroy(self)
    self.vs_scroll:Dispose()
end

return this
