---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by win 10.
--- DateTime: 2019/4/22 9:52
---

local UIFightSoulIntensCtrl = BaseClass("UIFightSoulIntensCtrl",UIBaseCtrl);
local this = UIFightSoulIntensCtrl;
local base = UIBaseCtrl

function this.CloseSelf()
   UIManager:GetInstance():DestroyWindowNoRecycle(UIWindowNames.UIFightSoulIntens);
end

function this.SendLockRequest(gameObject)
    local data = gameObject:GetComponent("BindData"):Get("data");

    coroutine.start(function()
        local g2cFightSoulLock = coroutine.yieldstart(Game.Scene.Session.CoCall, nil,  Game.Scene.Session,
                OuterOpcode.Name2Code.ETModel_C2M_FightSoulLock, data);

        if g2cFightSoulLock.Error == ErrorCode.ERR_Success then
            
            local fightSoul = Game.Scene.Player:GetComponent("FightSoulComponent").FightSouls[data.FightSoulId];
            fightSoul.Lock = data.Lock;
            DataManager:GetInstance():Broadcast(DataMessageNames.ON_FIGHTSOUL_INFO_CHG);
            local str = (data.Lock == 1 and {LangUtil.GetSysLang(2022)} or {LangUtil.GetSysLang(2023)})[1];
            UIUtil.ToolTipFourth(str);
        end
    end)
end

function this.SendFuseRequest(self,data)
    local player = Game.Scene.Player;

    coroutine.start(function()
        local g2cFightSoulFuse = coroutine.yieldstart(Game.Scene.Session.CoCall, nil,  Game.Scene.Session,
                OuterOpcode.Name2Code.ETModel_C2M_FightSoulFuse, data);

        if g2cFightSoulFuse.Error == ErrorCode.ERR_Success then
            
            player.GoldCoin = player.GoldCoin - data.ExpendGoldCoin;
            local fightSoulComponent = player:GetComponent("FightSoulComponent");
            for k,v in pairs(data.FuseFightSoulList) do
                fightSoulComponent:Remove(v);
            end
            local fightSoul = fightSoulComponent.FightSouls[data.MainFuseFightSoulId]
            fightSoul.Star = data.Star
            UIManager:GetInstance():OpenWindow(UIWindowNames.UIFightSoulFuse,{fightSoul = fightSoul})
            coroutine.waitforseconds(3)
            
            DataManager:GetInstance():Broadcast(DataMessageNames.ON_PLAYER_INFO_CHG);
            DataManager:GetInstance():Broadcast(DataMessageNames.ON_FIGHTSOUL_INFO_CHG);
            
        end
    end)
end

function this.SendResolveRequest(self,data)
    local player = Game.Scene.Player;

    coroutine.start(function()
        local g2cFightSoulDecompose = coroutine.yieldstart(Game.Scene.Session.CoCall, nil,  Game.Scene.Session,
                OuterOpcode.Name2Code.ETModel_C2M_FightSoulDecompose, data);

        if g2cFightSoulDecompose.Error == ErrorCode.ERR_Success then
           
            player.StarSand = player.StarSand + data.AcquireStarSand;
            local fightSoulComponent =  player:GetComponent("FightSoulComponent");
            for k,v in pairs(data.FightSoulId) do
                fightSoulComponent:Remove(v);
            end
            --分解任务
            TaskData.AddModeTaskNum({type = 1007}, table.count(data.FightSoulId))

            DataManager:GetInstance():Broadcast(DataMessageNames.ON_PLAYER_INFO_CHG);
            DataManager:GetInstance():Broadcast(DataMessageNames.ON_FIGHTSOUL_INFO_CHG);

            local infos = {{rewardType = RewardType.StarSand,TemplateId = 4,num = data.AcquireStarSand}}
            local info = {rewards = infos,title = LangUtil.GetSysLang(3115)}
            UIManager:GetInstance():OpenWindow(UIWindowNames.UIReward,info)
        end
    end)
end


return this
