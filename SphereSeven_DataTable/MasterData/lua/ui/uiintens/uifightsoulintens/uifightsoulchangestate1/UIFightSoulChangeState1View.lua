---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by win 10.
--- DateTime: 2019/5/24 16:58
---

local UIFightSoulChangeState1View = BaseClass("UIFightSoulChangeState1View",UIBaseView);
local base = UIBaseView
local this = UIFightSoulChangeState1View


local function InitEquipInfo(self)
    local transform = self.FightSoulInfo
   
    local lock = transform:Find("Lock")
    local fightSoulName = transform:Find("Title/FightSoulName"):GetComponent("Text")
    local prop = transform:Find("PropImg/PropTxt"):GetComponent("Text")
    local desc = transform:Find("TextScroll/Viewport/Content/EffTxt"):GetComponent("Text")
    local holderAvatar = transform:Find("Holder/Avatar"):GetComponent("Image")
    local holderAvatar1 = transform:Find("Holder1/Avatar"):GetComponent("Image")
 
    local fightSoul = self.fightSoul
    local ZCard = Z_Card[self.card.TemplateId]
    local zFightSoul = Z_FightSoul[fightSoul.TemplateId]
    UIUtil.SetCardSprite(holderAvatar1,ZCard.Id,self.card.SkinId,CardPictureType.Little)
    UIUtil.AddBtnEvent(lock.gameObject,function()Game.Scene.Player:GetComponent("FightSoulComponent"):OnLock(fightSoul,lock)  end)
    UIPublic.InitEquipLock(lock, fightSoul.Lock == 1)
    UIPublic.InitFightSoulHolder(holderAvatar,fightSoul)
    fightSoulName.text = Z_Card[zFightSoul.CardId].Name
    UIPublic.InitFightSoulProp(prop,fightSoul)
    UIPublic.InitFightSoulEff(desc,zFightSoul)
    coroutine.start(function()
        UIPublic.InitVsFightSoulItem(fightSoul, self.fightSoulItem)
    end)
end

local function SendChangeReq(self,dataList,tipStr, isPlayMusic)
    PublicRequest.SendChangeFightSoulRequest(dataList,function()
        if self.state == 1 then
            UIManager:GetInstance():CloseWindow(UIWindowNames.UIFightSoulList)
        end
        UIManager:GetInstance():CloseWindow(UIWindowNames.UIFightSoulChangeState1)
        if not isPlayMusic then
            return
        end
        local cardId = Z_FightSoul[self.fightSoul.TemplateId].CardId
        Game.Scene:GetComponent("SoundComponent"):PlaySoulEquipSound(cardId)
    end)
end


local function OnChange(self)
    local IsEquipIds = Game.Scene.Player:GetComponent("FightSoulComponent"):OnEquipFightSoulId()
    
    local dataList = {}
    local data1 = {}

    data1.CardId = self.card.Id
    for k,v in pairs({ 1,2,3}) do
        data1["FightSoul"..v] = self.card["FightSoul"..v]
        if v == self.index then
            data1["FightSoul"..v] = self.fightSoul.Id
        end
    end
    table.insert(dataList,data1)
    
    if table.any(IsEquipIds,function(h) return h.Id == self.fightSoul.TemplateId  end)  then
        local holder = table.first(IsEquipIds,function(v) return v.Id == self.fightSoul.TemplateId  end).Card
        if self.card.Id == holder.Id then
            UIUtil.ToolTipFourth(LangUtil.GetSysLang(2036))
            return
        end
        local data2 = {}
        data2.CardId = holder.Id
        for k,v in pairs({ 1,2,3}) do
            data2["FightSoul"..v] = holder["FightSoul"..v]
            --local fightSoul = 
            if( holder["FightSoul"..v] ~=0 and Game.Scene.Player:GetComponent("FightSoulComponent").FightSouls[holder["FightSoul"..v]].TemplateId == self.fightSoul.TemplateId) then
                data2["FightSoul"..v] = 0
            end
            --if v == self.index then
            --    data2["FightSoul"..v] = 0
            --end
        end
        table.insert(dataList,data2)
        local tipData = {}
        tipData.title = LangUtil.GetSysLang(9)--"提示"
        tipData.message = LangUtil.GetSysLang(1030)--"此装备已被穿戴,确定更换？"
        tipData.callBack = function() SendChangeReq(self,dataList,LangUtil.GetSysLang(1031), true) end
        UIUtil.ToolTipFirst(tipData)
    else
        SendChangeReq(self,dataList,LangUtil.GetSysLang(1031), true)--"更换成功"
    end
end


local function OnDeEquip(self) --卸载装备
    local dataList = {}
    local data = {}
    data.CardId = self.card.Id
    for k,v in pairs({ 1,2,3} ) do
        data["FightSoul"..v] = self.card["FightSoul"..v]
        if v == self.index then
            data["FightSoul"..v] = 0
        end
    end
    table.insert(dataList,data)
    SendChangeReq(self,dataList,LangUtil.GetSysLang(1302), false)--"卸载成功"
    
end

local function OnFightSoulItemCallBack(self,fightSoulId)
    local uiData = {}
    uiData.fightSoul1 = self.fightSoul
    uiData.fightSoul2 = Game.Scene.Player:GetComponent("FightSoulComponent").FightSouls[fightSoulId]
    uiData.index = self.index
    UIManager:GetInstance():OpenWindow(UIWindowNames.UIFightSoulChangeState2,uiData)
end

local function OpenShowEquip(self)
    
    local fightSouls = Game.Scene.Player:GetComponent("FightSoulComponent"):OnEquipFightSoul(self.card)
   
    UIManager:GetInstance():OpenWindow(UIWindowNames.UIFightSoulList,
            {
                fightSouls= fightSouls,
                cur_card = self.card,
                callBack = function(fightSoulId) OnFightSoulItemCallBack(self,fightSoulId)  
            end})
    UIManager:GetInstance():CloseWindow(UIWindowNames.UIFightSoulChangeState1)
end

function this.OnLangCreate(self)
    local state1 = self.langRc:GetObject("State1").transform
    local state2 = self.langRc:GetObject("State2").transform
    
    LangUtil.BindText(self.FightSoulInfo:Find("Title/FightSoulName"))
    LangUtil.BindText(self.FightSoulInfo:Find("PropImg/PropTxt"))
    LangUtil.BindText(self.FightSoulInfo:Find("TextScroll/Viewport/Content/EffTxt"))

    LangUtil.BindText(state1:Find("ChangeButton/Text")).text = LangUtil.GetSysLang(263)
    LangUtil.BindText(state1:Find("CancelButton/Text")).text = LangUtil.GetSysLang(371)
    LangUtil.BindText(state2:Find("ExChangeButton/Text")).text = LangUtil.GetSysLang(263)
    LangUtil.BindText(state2:Find("DeEquipButton/Text")).text = LangUtil.GetSysLang(254)
    LangUtil.BindText(self.ButtonState.transform:Find("Text")).text = LangUtil.GetSysLang(3020)
end

function this.OnCreate(self)
    base.OnCreate(self)
    self.FightSoulInfo = self.rc:GetObject("FightSoulInfo").transform
    self.fightSoulItem = self.FightSoulInfo:Find("FightVisitItem")

    self.state1Root = self.rc:GetObject("State1")
    self.state2Root = self.rc:GetObject("State2")
    self.Holder1 = self.rc:GetObject("Holder1")
    local changeBtn = self.rc:GetObject("ChangeButton")
    local closeBtn = self.rc:GetObject("CancelButton")
    local eventBg = self.rc:GetObject("EventBg")
    
    local exChangeBtn = self.rc:GetObject("ExChangeButton")
    local deEquipBtn = self.rc:GetObject("DeEquipButton")
    self.ButtonState= self.rc:GetObject("ButtonState")

    UIUtil.AddBtnEvent(changeBtn,function()OnChange(self)  end)
    UIUtil.AddBtnEvent(exChangeBtn,function()OpenShowEquip(self)  end)
    UIUtil.AddBtnEvent(deEquipBtn,function()OnDeEquip(self) end)
    
    local func = function()UIManager:GetInstance():CloseWindow(UIWindowNames.UIFightSoulChangeState1) end
    UIUtil.AddBtnEvent(closeBtn,func)
    EventTriggerListener.Get(eventBg).onLuaClick = func
    UIUtil.AddBtnEvent(  self.ButtonState,function() UIManager:GetInstance():OpenWindow(UIWindowNames.UIBuffDetails) end)
end

function this.OnEnable(self)
    base.OnEnable(self);
    self:OnRefresh();
end



function this.OnRefresh(self)
    local info = self.model.info
    self.card = info.card 
    self.state = info.state -- 1 没有战魂 2 有战魂
    self.index = info.index  --第几个战魂
    self.fightSoul = info.fightSoul -- 
    
    self.state1Root:SetActive(self.state == 1)
    self.state2Root:SetActive(self.state == 2)
    self.Holder1:SetActive(self.state == 1)
    InitEquipInfo(self)
end

local function  OnFightSoulChg(self)
    InitEquipInfo(self)
end

function this.OnAddListener(self)
    base.OnAddListener(self)
    self:AddUIListener(UIMessageNames.ON_FIGHTSOUL_INFO_CHG,OnFightSoulChg);
end

function this.OnRemoveListener(self)
    base.OnRemoveListener(self);
    self:RemoveUIListener(UIMessageNames.ON_FIGHTSOUL_INFO_CHG);
end

function this.OnDisable(self)
    base.OnDisable(self);
    self.fightSoulItem:Find("Mask/Avatar"):GetComponent("Image").sprite = DeActiveSprite
    self.fightSoulItem:Find("Frame"):GetComponent("Image").sprite = DeActiveSprite
    self.fightSoulItem:Find("Sub"):GetComponent("Image").sprite = DeActiveSprite
end

function this.OnDestroy(self)
    base.OnDestroy(self);
end

return this;

