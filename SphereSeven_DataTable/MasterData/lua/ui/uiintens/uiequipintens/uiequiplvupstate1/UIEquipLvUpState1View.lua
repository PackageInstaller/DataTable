---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by win 10.
--- DateTime: 2019/5/24 16:58
---

local UIEquipLvUpState1View = BaseClass("UIEquipLvUpState1View",UIBaseView);
local base = UIBaseView
local this = UIEquipLvUpState1View

local maxLv = 5
local isBusing = false
local function PlayEffect(self)
    if isBusing == true then
        return 
    end

    UIPublic.PlayEffect(self.effect)
    self.audio:Play()
    isBusing = true
    coroutine.start(function()
        coroutine.waitforseconds(1.5)
        isBusing = false
    end)
end



local function InitEquipInfo(self)
    local transform = self.equipInfo
    local label = transform:Find("Label")
    local equipName = transform:Find("EquipName"):GetComponent("Text")
    local equipItem = transform:Find("EquipItemNew")
    local prop = transform:Find("PropNum")
    
    local equip = self.equip
    local zEquip = Z_Equip[equip.TemplateId]
    UIPublic.InitEquipLabel(label,zEquip)
    equipName.text = zEquip.Name
    UIPublic.InitEquipProp(prop,equip)
    coroutine.start(function()
        UIPublic.InitEquipItemNew(equipItem,equip)
    end)
end



local function OnSendReq(self) --点击强化
    UIPublic.InitButton(self.intensBtn,false,1,LangUtil.GetSysLang(402))
    local player = Game.Scene.Player
    local level = self.equip.Level
    local reqData = {EquipId = self.equip.Id,ExpendGoldCoin = self.goldNum,Level = self.finalLv}
    local items = player:GetComponent("ItemComponent").Items
    local item = table.first(items,function(v) return v.TemplateId == self.itemId  end)
    if item == nil  then
        UIUtil.ToolTipFourth(LangUtil.GetSysLang(1053),1.5)--"材料不足"
        UIPublic.InitButton(self.intensBtn,true,1,LangUtil.GetSysLang(402))
        return
    end
    reqData.ExpendMaterialList = {{MaterialId=item.Id,Amount=self.needNum,MaterialType=1}}
    local holdNum = UIPublic.GetItemAmount(self.itemId)
    if self.goldNum > Game.Scene.Player.GoldCoin then
        UIUtil.ToolTipFourth(LangUtil.GetSysLang(1033),1.5)--"金币不足"
        UIPublic.InitButton(self.intensBtn,true,1,LangUtil.GetSysLang(402))
        return
    elseif self.needNum > holdNum then
        UIUtil.ToolTipFourth(LangUtil.GetSysLang(1053),1.5)--"材料不足"
        UIPublic.InitButton(self.intensBtn,true,1,LangUtil.GetSysLang(402))
        return
    end
    self.intensifying = true
    local tipData = {}
    tipData.title = LangUtil.GetSysLang(9)--"提示"
    tipData.message = string.gsub(LangUtil.GetSysLang(790),"XX",Z_Item[item.TemplateId].Name.."x"..self.needNum)
    tipData.message = string.gsub(tipData.message,"Y",Z_Equip[self.equip.TemplateId].Name)
    tipData.message = string.gsub(tipData.message,"Z","LV"..self.finalLv)
    tipData.callBack = function()
        coroutine.start(function()
            local g2cEquipLevelUp = coroutine.yieldstart(Game.Scene.Session.CoCall, nil,  Game.Scene.Session,
                    OuterOpcode.Name2Code.ETModel_C2M_EquipLevelUp, reqData);

            if g2cEquipLevelUp.Error == ErrorCode.ERR_Success then
                local equip = self.equip
                local count = math.max(0, reqData.Level - equip.Level)
                equip.Level = reqData.Level;
                equip:GetComponent("EquipAttrComponent"):LevelUp(reqData.Level);
                player.GoldCoin = player.GoldCoin - reqData.ExpendGoldCoin;
                for k,v in pairs(reqData.ExpendMaterialList) do
                    UIUtil.RemoveItem(v.MaterialId,v.Amount);
                end

                DataManager:GetInstance():Broadcast(DataMessageNames.ON_EQUIP_INFO_CHG)
                DataManager:GetInstance():Broadcast(DataMessageNames.ON_PLAYER_INFO_CHG)

                PlayEffect(self)
                self.intensifying = false
                coroutine.waitforseconds(1.5)
                self:RefreshData()
            end
        end) 
    end
    tipData.cancelCallBack = function()
        UIPublic.InitButton(self.intensBtn,true,1,LangUtil.GetSysLang(402))
        self.intensifying = false
    end
    tipData.hideCloseBtn = true
    UIUtil.ToolTipFirst(tipData)
    


end



local function OnItem(self,id)
    self.itemId = id
    self.itemNameTxt.text = LangUtil.GetSysLang(2031)..":"..Z_Item[self.itemId].Name
    local holdNum = UIPublic.GetItemAmount(self.itemId)
    local holdNumText = ""
    if holdNum >999 then
        holdNumText = math.floor(holdNum/1000).."K"
    else
        holdNumText = holdNum
    end
    self.goldNumTxt.color = Color.New(1,1,1)
    for k,v in pairs(self.itemList) do
        v.gameObject:SetActive(id == k)
    end
    
    if self.equip.Level == 5 then
        self.goldNumTxt.text = 0
        self.itemNumTxt.text =  holdNumText.."/0"
        UIPublic.InitButton(self.intensBtn,false,1,"Max")
    else
        self.needNum = Z_EquipLevelUp[self.equip.Level+1].NeedNum
        self.goldNum = self.needNum *self.zEquipLevelUpExpend.GoldCoinPer
        self.finalLv = self.equip.Level + 1

        local color = (holdNum >= self.needNum and {"<color=#AAD2FF>"} or {"<color=#F41F42>"})[1]
        self.itemNumTxt.text =   color..holdNumText.."</color>".. "/" .. self.needNum 
        self.goldNumTxt.text = self.goldNum
        
        if self.goldNum > Game.Scene.Player.GoldCoin then
            self.goldNumTxt.color = Color.New(244/255,31/255,66/255)
            --UIPublic.InitButton(self.intensBtn,true,1,LangUtil.GetSysLang(402))
        --elseif self.needNum > holdNum then
        --    UIPublic.InitButton(self.intensBtn,true,1,LangUtil.GetSysLang(402))
        --else
        --    UIPublic.InitButton(self.intensBtn,true,1,LangUtil.GetSysLang(402))
        end
        UIPublic.InitButton(self.intensBtn,true,1,LangUtil.GetSysLang(402))
    end
   
end


function this.OnLangCreate(self)
    local equipInfo = self.langRc:GetObject("EquipInfo").transform
    local intensBtn = self.langRc:GetObject("IntensButton").transform
    local spendGold = self.langRc:GetObject("SpendGold").transform
    self.AddValue = LangUtil.BindText(self.langRc:GetObject("AddValue"),FontType.All_Number)
    self.itemNumTxt = LangUtil.BindText(self.langRc:GetObject("ItemNum"))
    self.itemNameTxt = LangUtil.BindText(self.langRc:GetObject("ItemName"))
    LangUtil.BindText(equipInfo:Find("Label/Text"))
    LangUtil.BindText(equipInfo:Find("EquipName"))
    LangUtil.BindText(equipInfo:Find("Title/EquipName")).text = LangUtil.GetSysLang(135)
    LangUtil.BindText(equipInfo:Find("PropNum/Text"))
    LangUtil.BindText(equipInfo:Find("PropNum/Value"),FontType.All_Number)
    
    LangUtil.BindText(intensBtn:Find("Text")).text = LangUtil.GetSysLang(84)
    LangUtil.BindText(spendGold:Find("GoldNum/Txt")).text =LangUtil.GetSysLang(73)
    LangUtil.BindText(spendGold:Find("GoldNum"),FontType.All_Number)
end

function this.OnCreate(self)
    base.OnCreate(self)
    local eventBg = self.rc:GetObject("EventBg")
    self.audio = self.gameObject:GetComponent(typeof(AudioSource))
    self.intensBtn = self.rc:GetObject("IntensButton")
    self.goldNumTxt = self.rc:GetObject("GoldNum"):GetComponent("Text")
    self.equipInfo = self.rc:GetObject("EquipInfo").transform
    self.effect = self.rc:GetObject("Effect")
    
    EventTriggerListener.Get(eventBg).onLuaClick = function()
        if not self.intensifying then 
            UIManager:GetInstance():CloseWindow(UIWindowNames.UIEquipLvUpState1)
        end
    end
    
    local itemRoot = self.rc:GetObject("ItemRoot").transform

    UIUtil.AddBtnEvent(self.intensBtn,function() OnSendReq(self) end)
    
    self.itemList = {}
    for i = 0,itemRoot.childCount -1 do
        local id = 1046 + i 
        local child = itemRoot:GetChild(i)
        local avatar = child:Find("Avatar"):GetComponent("Image")
        local bg = child:Find("Image"):GetComponent("Image")
        UIUtil.SetSprite(avatar,AtlasConfig.Item,GetItemIcon(Z_Item[id]))
        UIUtil.SetSprite(bg,AtlasConfig.ItemBg,Z_Item[id].IconBg..".png")
        self.itemList[id] = child
    end
    
end

function this.OnEnable(self)
    base.OnEnable(self);
    self.audio.volume = ClientData:GetInstance():GetVolume("SoundVolume")
    self:OnRefresh()
    
end

local function  NextLevelAttr(self,equip)
    local equip1 = Game.Registry:NewObject("Equip",equip)
    equip1.Level = equip1.Level + 1
    equip1:AddComponent("EquipAttrComponent")
    local NextAttr =  equip1:GetComponent("EquipAttrComponent"):GetAttr()
    local Attr =  self.equip:GetComponent("EquipAttrComponent"):GetAttr()
    local AddAttr = math.modf(NextAttr) - math.modf(Attr)
    return AddAttr
end

function this.OnRefresh(self)
    self.intensifying = false
    self.equip = self.model.info.equip
    --self.attrOriginal = self.equip:GetComponent("EquipAttrComponent"):GetAttr()
    if self.equip.Level >= 5 then
        self.AddValue.gameObject:SetActive(false)
    else
        self.AddValue.text = NextLevelAttr(self,self.equip)
        self.AddValue.gameObject:SetActive(true)
    end
    
    local star
    local zEquip = Z_Equip[self.equip.TemplateId]

    if zEquip.Exclusive == 0 then
        star = zEquip.Star
    else
        star = self.equip.Star
    end

    self.zEquipLevelUpExpend = table.first(Z_EquipLevelUpExpend,function(v)
        return table.first(v.Stars,function(a) return  a == star  end) ~= nil
    end)
    InitEquipInfo(self)
    OnItem(self,self.zEquipLevelUpExpend.ItemId)
    
end

function this.RefreshData(self)
    local star
    local zEquip = Z_Equip[self.equip.TemplateId]
    
    if zEquip.Exclusive == 0 then
        star = zEquip.Star
    else
        star = self.equip.Star
    end

    self.zEquipLevelUpExpend = table.first(Z_EquipLevelUpExpend,function(v)
        return table.first(v.Stars,function(a) return  a == star  end) ~= nil
    end)
    OnItem(self,self.zEquipLevelUpExpend.ItemId)
    local transform = self.equipInfo
    local prop = transform:Find("PropNum")
    transform:Find("EquipItemNew/IconRoot/Level"):GetComponent("Text").text = "Lv."..self.equip.Level
    UIPublic.InitEquipProp(prop,self.equip)
    if self.equip.Level >= 5 then
        self.AddValue.gameObject:SetActive(false)
    else
        self.AddValue.text = NextLevelAttr(self,self.equip)
        self.AddValue.gameObject:SetActive(true)
    end
end


function this.OnAddListener(self)
    base.OnAddListener(self)
end

function this.OnRemoveListener(self)
    base.OnRemoveListener(self);
end

function this.OnDisable(self)
    base.OnDisable(self);
end

function this.OnDestroy(self)
    base.OnDestroy(self);
end

return this;

