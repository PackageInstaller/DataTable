---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by win 10.
--- DateTime: 2019/5/24 16:58
---

local UIEquipChangeState1View = BaseClass("UIEquipChangeState1View",UIBaseView);
local base = UIBaseView
local this = UIEquipChangeState1View

local portNames = {"Hand1Equip","Hand2Equip","BodyEquip","HeadEquip","FootEquip","AdornEquip",}

local function InitEquipInfo(self)
    local transform = self.equipInfo
    local label = transform:Find("Label")
    local lock = transform:Find("Lock")
    local equipName = transform:Find("EquipName"):GetComponent("Text")
    local equipItem = transform:Find("EquipItemNew")
    local prop = transform:Find("PropNum")
    local desc = transform:Find("Desc"):GetComponent("Text")
    local holderAvatar = transform:Find("Holder/Avatar"):GetComponent("Image")
    local holderName = transform:Find("HolderName"):GetComponent("Text")

    local equip = self.equip
    local zEquip = Z_Equip[equip.TemplateId]
    UIPublic.InitEquipLabel(label,zEquip)
    UIPublic.InitEquipLock(lock,equip.Lock == 1)
    UIPublic.InitEquipHolder(holderAvatar,equip,holderName)
    equipName.text = zEquip.Name
    UIPublic.InitEquipDesc(desc,zEquip)
    UIPublic.InitEquipProp(prop,equip)
    --local holder = UIPublic.GetEquipHolder(self.equip)
    --if holder == nil  then
    --    holderAvatar.gameObject:SetActive(false)
    --    holderAvatar.transform.parent.gameObject:SetActive(true)
    --else
    --    holderAvatar.gameObject:SetActive(true)
    --    --holderAvatar.transform.parent.gameObject:SetActive(true)
    --end
    coroutine.start(function()
        UIPublic.InitEquipItemNew(equipItem,equip)
    end)
end

local function SendChangeReq(self,dataList,tipStr)
    PublicRequest.SendChangeEquipRequest(dataList,function()
        if self.state == 1 then
            UIManager:GetInstance():CloseWindow(UIWindowNames.UIShowEquip)
        end
        UIManager:GetInstance():CloseWindow(UIWindowNames.UIEquipChangeState1)
        UIUtil.ToolTipFourth(tipStr)
    end)
end


local function OnChange(self)
    local holder = UIPublic.GetEquipHolder(self.equip)
    local dataList = {}
    local data1 = {}

    data1.CardId = self.card.Id
    for k,v in pairs(portNames) do
        data1[v] = self.card[v]
    end
    table.insert(dataList,data1)
    local zEquip = Z_Equip[self.equip.TemplateId]
    data1[portNames[zEquip.Part]] = self.equip.Id
    
    if holder ~= nil then
        local data2 = {}
        data2.CardId = holder.Id
        for k,v in pairs(portNames) do
            data2[v] = holder[v]
            if holder[v] == self.equip.Id then
                data2[v] = 0
            end
        end
        table.insert(dataList,data2)
        local tipData = {}
        tipData.title = LangUtil.GetSysLang(9)--"提示"
        tipData.message = LangUtil.GetSysLang(1030)--"此装备已被穿戴,确定更换？"
        tipData.callBack = function() SendChangeReq(self,dataList) end
        UIUtil.ToolTipFirst(tipData)
    else
        SendChangeReq(self,dataList,LangUtil.GetSysLang(1031))--更换成功
    end
end


local function OnDeEquip(self) --卸载装备
    local dataList = {}
    local data = {}
    data.CardId = self.card.Id
    for k,v in pairs(portNames) do
        data[v] = self.card[v]
        if k == self.part then
            data[v] = 0
        end
    end
    table.insert(dataList,data)
    SendChangeReq(self,dataList,LangUtil.GetSysLang(1032))--"卸载成功"
    
end

local function OpenShowEquip(self)
    local equips = Game.Scene.Player:GetComponent("EquipComponent").Equips
    local uiData = {}
    uiData.card = self.card
    uiData.equip = self.equip
    uiData.part = self.part
    uiData.equipList = table.choose(equips,function(k,v)
        local zEquip = Z_Equip[v.TemplateId]
        return zEquip.Part == self.part and v.Id ~= self.equip.Id
    end)
    UIManager:GetInstance():CloseWindow(UIWindowNames.UIEquipChangeState1)
    UIManager:GetInstance():OpenWindow(UIWindowNames.UIShowEquip,uiData)
end

local function OnIntens(self) --强化装备
    UIManager:GetInstance():CloseWindow(UIWindowNames.UIEquipChangeState1)
    UIManager:GetInstance():OpenWindow(UIWindowNames.UIEquipLvUpState2,{equip = self.equip,card = self.card})
end

function this.OnLangCreate(self)
    local equipInfo = self.langRc:GetObject("EquipInfo").transform
    local state1 = self.langRc:GetObject("State1").transform
    local state2 = self.langRc:GetObject("State2").transform

    LangUtil.BindText(equipInfo:Find("Label/Text"))
    LangUtil.BindText(equipInfo:Find("EquipName"))
    LangUtil.BindText(equipInfo:Find("PropNum/Text"))
    LangUtil.BindText(equipInfo:Find("PropNum/Value"),FontType.All_Number)
    LangUtil.BindText(equipInfo:Find("Desc"))
    LangUtil.BindText(equipInfo:Find("HolderName"))

    LangUtil.BindText(state1:Find("ChangeButton/Text")).text = LangUtil.GetSysLang(253)
    LangUtil.BindText(state1:Find("CancelButton/Text")).text = LangUtil.GetSysLang(146)

    LangUtil.BindText(state2:Find("ChangeButton/Text")).text = LangUtil.GetSysLang(253)
    LangUtil.BindText(state2:Find("IntensButton/Text")).text = LangUtil.GetSysLang(84)
    LangUtil.BindText(state2:Find("DeEquipButton/Text")).text = LangUtil.GetSysLang(254)
end

function this.OnCreate(self)
    base.OnCreate(self)
    self.equipInfo = self.rc:GetObject("EquipInfo").transform
    self.state1Root = self.rc:GetObject("State1")
    self.state2Root = self.rc:GetObject("State2")
    
    local changeBtn1 = self.rc:GetObject("ChangeButton1")
    local closeBtn = self.rc:GetObject("CancelButton")
    local eventBg = self.rc:GetObject("EventBg")
    
    local changeBtn2 = self.rc:GetObject("ChangeButton2")
    local deEquipBtn = self.rc:GetObject("DeEquipButton")
    local intensBtn = self.rc:GetObject("IntensButton")

    UIUtil.AddBtnEvent(changeBtn1,function()OnChange(self)  end)
    UIUtil.AddBtnEvent(changeBtn2,function()OpenShowEquip(self)  end)
    UIUtil.AddBtnEvent(deEquipBtn,function()OnDeEquip(self) end)
    UIUtil.AddBtnEvent(intensBtn,function()OnIntens(self)  end)
    
    local func = function()UIManager:GetInstance():CloseWindow(UIWindowNames.UIEquipChangeState1) end
    UIUtil.AddBtnEvent(closeBtn,func)
    EventTriggerListener.Get(eventBg).onLuaClick = func
    
end

function this.OnEnable(self)
    base.OnEnable(self);
    self:OnRefresh();
end



function this.OnRefresh(self)
    local info = self.model.info
    self.equip = info.equip
    self.card = info.card
    self.state = info.state 
    self.part = info.part
    
    self.state1Root:SetActive(self.state == 1)
    self.state2Root:SetActive(self.state == 2)
    
    InitEquipInfo(self)
end


function this.OnAddListener(self)
    base.OnAddListener(self)
end

function this.OnRemoveListener(self)
    base.OnRemoveListener(self);
end

function this.OnDisable(self)
    base.OnDisable(self);
end

function this.OnDestroy(self)
    base.OnDestroy(self);
end

return this;

