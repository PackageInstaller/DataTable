---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by win 10.
--- DateTime: 2019/8/8 15:31
---

local SortLogic = {};
local this = SortLogic;

local function SortEquipObject(self)
    for k,v in table.pairsByKeys(self.sort_Tab) do
        v.Obj.transform:SetAsLastSibling();
    end
end

local function ScreenWithStar(self)
    for k,v in pairs(self.toggle_Tab[1]) do
        if v.isOn == false then
            local tab = table.choose(self.sort_Tab,function(a,b)
                local equip = self.equips[b.Id]
                local zEquip = Z_Equip[equip.TemplateId];
                local star;
                if zEquip.Exclusive == 0 then
                    star = zEquip.Star;
                else
                    star = equip.Star;
                end
                return star == k;
            end)
            for _,g in pairs(tab) do
                g.Obj:SetActive(v.isOn);
            end
        end
    end
end

local function ScreenWithKind(self)
    if self.toggle_Tab[2][1].isOn == false then --武器
        local tab = table.choose(self.sort_Tab,function(a,b)
            local zEquip = Z_Equip[self.equips[b.Id].TemplateId]
            return zEquip.Kind == 1;
        end)
        for _,g in pairs(tab) do g.Obj:SetActive(false); end
    end
    if self.toggle_Tab[2][2].isOn == false then --防具
        local tab = table.choose(self.sort_Tab,function(a,b)
            local zEquip = Z_Equip[self.equips[b.Id].TemplateId]
            return zEquip.Kind == 2;
        end)
        for _,g in pairs(tab) do g.Obj:SetActive(false); end
    end
    if self.toggle_Tab[2][3].isOn == false then --饰品
        local tab = table.choose(self.sort_Tab,function(a,b)
            local zEquip = Z_Equip[self.equips[b.Id].TemplateId]
            return zEquip.Kind == 3;
        end)
        for _,g in pairs(tab) do g.Obj:SetActive(false); end
    end
    if self.toggle_Tab[2][4].isOn == false then --共通
        local tab = table.choose(self.sort_Tab,function(a,b)
            local zEquip = Z_Equip[self.equips[b.Id].TemplateId]
            return zEquip.Exclusive == 0;
        end)
        for _,g in pairs(tab) do g.Obj:SetActive(false); end
    end
    if self.toggle_Tab[2][5].isOn == false then --专属
        local tab = table.choose(self.sort_Tab,function(a,b)
            local zEquip = Z_Equip[self.equips[b.Id].TemplateId]
            return zEquip.Exclusive ~= 0;
        end)
        for _,g in pairs(tab) do g.Obj:SetActive(false); end
    end
    if self.toggle_Tab[2][6].isOn == false then --已装备
        local tab = table.choose(self.sort_Tab,function(a,b)
            local equip = self.equips[b.Id];
            return UIPublic.GetEquipHolder(equip) ~= nil
        end)
        for _,g in pairs(tab) do g.Obj:SetActive(false); end
    end
    if self.toggle_Tab[2][7].isOn == false then --未装备
        local tab = table.choose(self.sort_Tab,function(a,b)
            local equip = self.equips[b.Id];
            return UIPublic.GetEquipHolder(equip) == nil
        end)
        for _,g in pairs(tab) do g.Obj:SetActive(false); end
    end
end


local function SortWithKind(self)
    table.sort(self.sort_Tab,function(a,b)
        local kind1 = Z_Equip[self.equips[a.Id].TemplateId].Kind;
        local kind2 = Z_Equip[self.equips[b.Id].TemplateId].Kind;
        return kind1 < kind2;
    end)
end

local function SortWithLevel(self)
    table.sort(self.sort_Tab,function(a,b)
        local level1 = self.equips[a.Id].Level
        local level2 = self.equips[b.Id].Level
        return level1 > level2;
    end)
end

local function SortWithStar(self)
    table.sort(self.sort_Tab,function(a,b)
        local Star1 = self.equips[a.Id].Star
        local Star2 = self.equips[b.Id].Star
        return Star1 > Star2;
    end)
end

local function SortWithDefault(self)
    local tmpTab = {};
    local count = 0;
    for k,v in table.pairsByKeys(self.equips) do
        count = count + 1;
        local t = {};
        t.index = count
        tmpTab[k] = t;
    end

    table.sort(self.sort_Tab,function(a,b)
        return tmpTab[a.Id].index < tmpTab[b.Id].index
    end)
end

function this.OnToggleValueChg(self,toggle)
    print("点击toggle") -- ignoreCN
    if toggle ~= nil then toggle.isOn = not toggle.isOn; end
    self.sort_Tab = {};
    for k,v in pairs(self.object_list) do
        local t = {};
        t.Id = k;
        t.Obj = v;
        table.insert(self.sort_Tab,t);

        if self.panel_id == 5   then
            if table.first(self.resolve_data.equip_list,function(a) return a.Id == k end) == nil then
                v:SetActive(true)
            end
        else
            v:SetActive(true)
        end
    end

    ScreenWithStar(self)
    ScreenWithKind(self)
end

function this.OnClickSortBtn(self,id)
    for k,v in pairs(self.sort_BtnTab) do
        v:GetComponent("Image").color = (k == id and {Color.New(1,1,0)} or {Color.New(1,1,1)})[1]
    end

    self.sort_Tab = {};
    for k,v in pairs(self.object_list) do
        local t = {};
        t.Id = k;
        t.Obj = v;
        table.insert(self.sort_Tab,t);
    end

    self.sort_BtnFuncTab[id](self);
    SortEquipObject(self);
    
end


function this.OnRefresh(self)
    for k,v in pairs(self.toggle_Tab) do
        for _,a in pairs(v) do
            a.isOn = true;
        end
    end

    for k,v in pairs(self.sort_BtnTab) do
        v:GetComponent("Image").color = Color.New(1,1,1);
    end
end

function this.OnCreate(self)
    self.sort_Panel = self.rc:GetObject("SortPanel");
    self.sort_BtnCtrl = self.sort_Panel.transform:Find("UseArea/BtnCtrl");
    self.sort_ToggleCtrl = self.sort_Panel.transform:Find("UseArea/ToggleArea");
    self.sort_Bg = self.sort_Panel.transform:Find("Bg").gameObject;
    self.sort_BtnTab = {};
    self.toggle_Tab = {};
    self.sort_BtnFuncTab = {SortWithKind,SortWithLevel,SortWithStar,SortWithDefault};
    for i = 0,self.sort_ToggleCtrl.childCount - 1 do
        local toggleParent = self.sort_ToggleCtrl:GetChild(i);
        self.toggle_Tab[i+1] = {};
        for j = 1,toggleParent.childCount -1 do
            local toggle = toggleParent:GetChild(j):GetComponent("Toggle");
            self.toggle_Tab[i+1][j] = toggle;
            EventTriggerListener.Get(toggle.transform:Find("Background").gameObject).onLuaClick = function(v) this.OnToggleValueChg(self,toggle) end
        end
    end

    for i = 0,self.sort_BtnCtrl.childCount - 1 do
        local btn = self.sort_BtnCtrl:GetChild(i).gameObject;
        self.sort_BtnTab[i + 1] = btn
        ButtonListener.Get(btn).OnClickHandler = function(v) this.OnClickSortBtn(self,i+1) end
        UIUtil.AddBtnSound(btn);
    end
    
    EventTriggerListener.Get(self.sort_Bg).onLuaClick = function(v) self.sort_Panel:SetActive(false)  end
    
end

return this;