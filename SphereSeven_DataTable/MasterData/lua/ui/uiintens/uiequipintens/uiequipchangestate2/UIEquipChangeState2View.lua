---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by win 10.
--- DateTime: 2019/5/24 16:58
---

local UIEquipChangeState2View = BaseClass("UIEquipChangeState2View",UIBaseView);
local base = UIBaseView
local this = UIEquipChangeState2View

local portNames = {"Hand1Equip","Hand2Equip","BodyEquip","HeadEquip","FootEquip","AdornEquip",}

local function InitEquipInfo(self,equip,equipInfo)
    local transform = equipInfo
    local label = transform:Find("Label")
    local lock = transform:Find("Lock")
    local equipName = transform:Find("EquipName"):GetComponent("Text")
    local equipItem = transform:Find("EquipItemNew")
    local prop = transform:Find("PropNum")
    local desc = transform:Find("Desc"):GetComponent("Text")
    local holderAvatar = transform:Find("Holder/Avatar"):GetComponent("Image")
    local holderName = transform:Find("HolderName"):GetComponent("Text")
    
    local zEquip = Z_Equip[equip.TemplateId]
    UIPublic.InitEquipLabel(label,zEquip)
    UIPublic.InitEquipLock(lock,equip.Lock == 1)
    UIPublic.InitEquipHolder(holderAvatar,equip,holderName)
    equipName.text = zEquip.Name
    UIPublic.InitEquipDesc(desc,zEquip)
    UIPublic.InitEquipProp(prop,equip)
    --local holder = UIPublic.GetEquipHolder(equip)
    --if holder == nil  then
    --    holderAvatar.gameObject:SetActive(false)
    --    holderAvatar.transform.parent.gameObject:SetActive(true)
    --else
    --    holderAvatar.gameObject:SetActive(true)
    --    --holderAvatar.transform.parent.gameObject:SetActive(true)
    --end
    coroutine.start(function()
        UIPublic.InitEquipItemNew(equipItem,equip)
    end)
end

local function SendChangeReq(self,dataList,tipStr)
    PublicRequest.SendChangeEquipRequest(dataList,function()
        UIManager:GetInstance():CloseWindow(UIWindowNames.UIShowEquip)
        UIManager:GetInstance():CloseWindow(UIWindowNames.UIEquipChangeState2)
        UIUtil.ToolTipFourth(tipStr)
    end)
end


local function OnChange(self)
    local holder = UIPublic.GetEquipHolder(self.equip2)
    local dataList = {}
    local data1 = {}
    
    local card = UIPublic.GetEquipHolder(self.equip1)

    data1.CardId = card.Id
    for k,v in pairs(portNames) do
        data1[v] = card[v]
    end
    table.insert(dataList,data1)
    local zEquip = Z_Equip[self.equip2.TemplateId]
    data1[portNames[zEquip.Part]] = self.equip2.Id
    
    if holder ~= nil then
        local data2 = {}
        data2.CardId = holder.Id
        for k,v in pairs(portNames) do
            data2[v] = holder[v]
            if holder[v] == self.equip2.Id then
                data2[v] = 0
            end
        end
        table.insert(dataList,data2)
        local tipData = {}
        tipData.title = LangUtil.GetSysLang(9)--"提示"
        tipData.message = LangUtil.GetSysLang(1030)--"此装备已被穿戴,确定更换？"
        tipData.callBack = function() SendChangeReq(self,dataList) end
        UIUtil.ToolTipFirst(tipData)
    else
        SendChangeReq(self,dataList,LangUtil.GetSysLang(1031))--"更换成功"
    end
end


function this.OnLangCreate(self)
    local equipInfo1 = self.langRc:GetObject("Equip1Info").transform
    local equipInfo2 = self.langRc:GetObject("Equip2Info").transform
    local cancelButton = self.langRc:GetObject("CancelButtonText").transform
    local confirmButton = self.langRc:GetObject("ConfirmButtonText").transform

    LangUtil.BindText(cancelButton).text= LangUtil.GetSysLang(371)
    LangUtil.BindText(confirmButton).text= LangUtil.GetSysLang(370)

    LangUtil.BindText(equipInfo1:Find("Label/Text"))
    LangUtil.BindText(equipInfo1:Find("EquipName"))
    LangUtil.BindText(equipInfo1:Find("PropNum/Text"))
    LangUtil.BindText(equipInfo1:Find("PropNum/Value"),FontType.All_Number)
    LangUtil.BindText(equipInfo1:Find("Desc"))
    LangUtil.BindText(equipInfo1:Find("HolderName"))

    LangUtil.BindText(equipInfo2:Find("Label/Text"))
    LangUtil.BindText(equipInfo2:Find("EquipName"))
    LangUtil.BindText(equipInfo2:Find("PropNum/Text"))
    LangUtil.BindText(equipInfo2:Find("PropNum/Value"),FontType.All_Number)
    LangUtil.BindText(equipInfo2:Find("Desc"))
    LangUtil.BindText(equipInfo2:Find("HolderName"))

   
end

function this.OnCreate(self)
    base.OnCreate(self)
    self.equip1Info = self.rc:GetObject("Equip1Info").transform
    self.equip2Info = self.rc:GetObject("Equip2Info").transform
    
    local eventBg = self.rc:GetObject("EventBg")
    
    local confirmBtn = self.rc:GetObject("ConfirmButton").gameObject
    local cancelBtn = self.rc:GetObject("CancelButton").gameObject

    UIUtil.AddBtnEvent(confirmBtn,function()OnChange(self)  end)
    
    local func = function()UIManager:GetInstance():CloseWindow(UIWindowNames.UIEquipChangeState2) end
   
    EventTriggerListener.Get(eventBg).onLuaClick = func
    UIUtil.AddBtnEvent(cancelBtn,func)
    
end

function this.OnEnable(self)
    base.OnEnable(self);
    self:OnRefresh();
end



function this.OnRefresh(self)
    local info = self.model.info
    self.equip1 = info.equip1
    self.equip2 = info.equip2
    self.part = info.part

    InitEquipInfo(self,self.equip1,self.equip1Info)
    InitEquipInfo(self,self.equip2,self.equip2Info)
    
end


function this.OnAddListener(self)
    base.OnAddListener(self)
end

function this.OnRemoveListener(self)
    base.OnRemoveListener(self);
end

function this.OnDisable(self)
    base.OnDisable(self);
end

function this.OnDestroy(self)
    base.OnDestroy(self);
end

return this;

