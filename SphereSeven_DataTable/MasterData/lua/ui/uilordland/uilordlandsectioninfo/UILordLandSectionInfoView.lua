---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by win 10.
--- DateTime: 2019/5/24 16:58
---

local UILordLandSectionInfoView = BaseClass("UILordLandSectionInfoView", UIBaseView);
local base = UIBaseView
local this = UILordLandSectionInfoView

local function OnClickBattle(self)
    local zStoryLevel = self.model.info
    local launchAtkData = {}
    launchAtkData.CurLevelId = zStoryLevel.Id;
    launchAtkData.CurLevelDifficulty = zStoryLevel.DiffLv
    launchAtkData.LevelType = LevelType.LordLand
    launchAtkData.EnergyExpend = zStoryLevel.EnergyExpend

    UIUtil.OpenFormat(launchAtkData)
    UIManager:GetInstance():CloseWindow(UIWindowNames.UILordLandSectionInfo)
end

local function JudgeIsGet(self)
    local storyComponent =  Game.Scene.Player:GetComponent("StoryComponent")
    local completedLayerServer = storyComponent.CompletedLordLandLayer
    local completedLayerClient = ClientData:GetInstance().CompletedLordLandLayer
    local currLayer = completedLayerServer ~= 0 and completedLayerServer + 1  or completedLayerClient;
    local zStoryLevel = self.model.info
    local bool = zStoryLevel.Id < currLayer
    for i = 0,self.mustContent.transform.childCount - 1 do
        self.mustContent.transform:GetChild(i).transform:Find("Panel/IsGet").gameObject:SetActive(bool)
        self.mustContent.transform:GetChild(i).transform:Find("Panel/FirstReword").gameObject:SetActive(false)
        if bool then
            local mat = ResourcesManager:GetInstance():CoLoadAsync("UI/Materials/UI-GreyDefault.mat", typeof(Material))
            self.mustContent.transform:GetChild(i).transform:Find("Panel/Bg_1").transform:GetComponent("Image").material = mat
            self.mustContent.transform:GetChild(i).transform:Find("Panel/Avatar").transform:GetComponent("Image").material = mat
        else
            self.mustContent.transform:GetChild(i).transform:Find("Panel/Bg_1").transform:GetComponent("Image").material = nil
            self.mustContent.transform:GetChild(i).transform:Find("Panel/Avatar").transform:GetComponent("Image").material = nil
        end
    end
    self.firstText.gameObject:SetActive(not bool);
end

local function InitMonsterArea(self, zStoryLevel)
    local launchAtkData = {}
    launchAtkData.CurLevelId = zStoryLevel.Id
    launchAtkData.CurLevelDifficulty = zStoryLevel.DiffLv
    launchAtkData.LevelType = LevelType.LordLand
    UIBattelModeInfo.InitMonsterArea(self.enemyRoot.transform, zStoryLevel, launchAtkData)                      --敌人 
end

local function InitFirstPassArea(self, zStoryLevel)
    local firstPassRewards = loadtable(zStoryLevel.FirstPassRewards)
    UIBattelModeInfo.InitFirstPassArea(self.mustContent.transform, nil, firstPassRewards, 1) --奖励
    JudgeIsGet(self)
end

local function InitConditionsArea(self, zStoryLevel)
    local conditionRewards = loadtable(zStoryLevel.ConditionRewards)
    UIBattelModeInfo.InitConditionsArea(self.conditionsContent.transform, conditionRewards, nil)      --条件
    local txt = self.conditionText.transform:GetComponent("Text").text
    local tab = string.split(txt,".");
    local tab2 = string.split(tab[2],"<");
    self.conditionText.transform:GetComponent("Text").text = tab2[1]
    self.conditionText.transform:GetComponent("Text").color = Color.white
end

function this.OnLangCreate(self)
    local zStoryLevel = self.model.info
    self.titleTxt.text =  LangUtil.GetSysLang(233)
    self.layerText.text = Z_LordLand[zStoryLevel.Id]["Name_"..LangUtil.GetLangType()]
    self.monsterText.text = LangUtil.GetSysLang(661)             --敌人情报
    self.conditionTitleText.text = LangUtil.GetSysLang(1140)     --达成条件
    self.mustTitleText.text = LangUtil.GetSysLang(1141)          --达成奖励
    self.firstText.text =  LangUtil.GetSysLang(499)              --初回

    self.aktButtonText.text = LangUtil.GetSysLang(92)            --出击
    self.needEnergyTxt.text = string.format("AP %s",zStoryLevel.EnergyExpend )  --AP

end

function this.OnCreate(self)
    base.OnCreate(self);
    local closeBtn = self.rc:GetObject("CloseButton")
    local eventBg = self.rc:GetObject("EventBg")
    self.conditionText = LangUtil.BindText(self.rc:GetObject("ConditionText"))
    self.titleTxt = LangUtil.BindText(self.rc:GetObject("TittleText"))
    self.layerText = LangUtil.BindText(self.rc:GetObject("LayerText"))
    self.aktButton = self.rc:GetObject("AktButton")
    self.mustContent = self.rc:GetObject("MustContent")
    self.firstText =  LangUtil.BindText(self.rc:GetObject("FirstText"))
    self.mustTitleText =  LangUtil.BindText(self.rc:GetObject("MustTitleText"))
    self.conditionTitleText =  LangUtil.BindText(self.rc:GetObject("ConditionTitleText"))
    self.enemyRoot = self.rc:GetObject("EnemyRoot")
    self.monsterText =  LangUtil.BindText(self.rc:GetObject("MonsterText"))
    self.aktButtonText =  LangUtil.BindText(self.rc:GetObject("AktButtonText"))
    self.needEnergyTxt = LangUtil.BindText(self.rc:GetObject("ApTxt"))

    self.conditionsContent = self.rc:GetObject("ConditionsContent")

    UIUtil.AddBtnEvent(self.aktButton, function()
        OnClickBattle(self)
    end)

    local func = function()
        UIManager:GetInstance():CloseWindow(UIWindowNames.UILordLandSectionInfo)
    end
    EventTriggerListener.Get(eventBg).onLuaClick = function()
        func()
    end
    UIUtil.AddBtnEvent(closeBtn, function()
        func()
    end)

end

function this.OnEnable(self)
    base.OnEnable(self);
    self:OnRefresh();
end

function this.OnDisable(self)
    base.OnDisable(self);
end

function this.OnRefresh(self)
    local zStoryLevel = self.model.info
    InitMonsterArea(self, zStoryLevel)
    InitFirstPassArea(self, zStoryLevel)
    InitConditionsArea(self, zStoryLevel)
end

return this;

