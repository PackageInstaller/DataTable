---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by wwj.
--- DateTime: 2022/8/17 11:26
---

local ToolTipGiftBagView = BaseClass("ToolTipGiftBagView",UIBaseView)
local base = UIBaseView
local this = ToolTipGiftBagView
local langSprite = {[33] = 344 ,[34] = 345}

function this.OnClickCloseButton(self)
    -- 发送触发礼包、开启计时
    local story = Game.Scene.Player:GetComponent("StoryComponent").StoryChapters
    ---@type GameEventComponent
    local activityCom = Game.Scene.Player:GetComponent("GameEventComponent")
    local storyChapter = table.first(story,function (a) return a.LevelType == LevelType.LevelTypeStory end)
    -- 打开显示礼包页面
    if storyChapter.CompletedSections[1].CompletedId >= 103 and table.first(activityCom.ActivityGifts,function (a) return a.Id == 33 end) == nil  then
        UIManager:GetInstance():OpenWindow(UIWindowNames.ToolTipGiftBag,{ModeId = 33})
    elseif storyChapter.CompletedSections[1].CompletedId >= 110 and table.first(activityCom.ActivityGifts,function (a) return a.Id == 34 end) == nil then
        UIManager:GetInstance():OpenWindow(UIWindowNames.ToolTipGiftBag,{ModeId = 34})
    else
        UIManager:GetInstance():CloseWindow(UIWindowNames.ToolTipGiftBag)
    end
end

function this.PayClick()
    
end

function this.OnCreate(self)
    base.OnCreate(self);
    self.modeId = 33
    self.bgEvent = self.rc:GetObject("BgEvent")
    self.bg34 = self.rc:GetObject("Bg34"):GetComponent("Image")
    self.bg33 = self.rc:GetObject("Bg33"):GetComponent("Image")

    self.bg34.gameObject:SetActive(false)
    self.bg33.gameObject:SetActive(false)
    
   
    UIUtil.AddBtnEvent(self.bgEvent,function()self:OnClickCloseButton() end)
    
end

function this.OnLangCreate(self)
   
end

function this.OnEnable(self)
    base.OnEnable(self);
    self:OnRefresh();
end

function this.init(self)
    self.payBut = self.rc:GetObject("Pay"..self.modeId);
    self.bg =  self.rc:GetObject("Bg"..self.modeId):GetComponent("Image");
    self.time = LangUtil.BindText(self.rc:GetObject("time"..self.modeId))
    self.payButText = LangUtil.BindText(self.payBut.transform:Find("Text"),FontType.All_Number)
    self.closeBut = self.rc:GetObject("CloseButton"..self.modeId);
    UIUtil.AddBtnEvent(self.closeBut,function()self:OnClickCloseButton() end)
    UIUtil.AddBtnEvent(self.payBut,function()
        -- 测试服测试购买用
        if ChannelManager:GetInstance():IsChannel(ChannelType.Test) then
            local productId = ChannelManager:GetInstance():GetFullId(self.modeId)
            local platform = ChannelManager:GetInstance():GetPlatform()
            local tab = {}
            tab.ProductId = productId
            tab.Token = productId
            tab.Platform = platform

            ChannelManager:GetInstance():PurchaseVerify(cjson.encode(tab))
            return
        end
        ChannelManager:GetInstance():Purchase(self.modeId)
        self.payBut:SetActive(false)
    end)
end

function this.OnRefresh(self)
    self.data = self.model.data
    self.modeId = self.model.data.ModeId
    self:init()
    self.payBut:SetActive(false)
    ---@type GameEventComponent
    local activityCom = Game.Scene.Player:GetComponent("GameEventComponent")
    
    if table.first(activityCom.ActivityGifts,function (a) return a.Id == self.modeId end) == nil then
        activityCom:GetGiftBag( self.modeId,function ()
            self.payBut:SetActive(true)
            local tb = TimeUtil.ConvertTimeForm(os.difftime(activityCom.ActivityGifts[self.modeId].LimitDate, TimeUtil.OSTime()))
            self.time.text = string.format("%02d:%02d:%02d"..LangUtil.GetSysLang(884), tb.hour, tb.minute, tb.second) 
        end)
    else
        self.payBut:SetActive(true)
        local tb = TimeUtil.ConvertTimeForm(os.difftime(activityCom.ActivityGifts[self.modeId].LimitDate, TimeUtil.OSTime()))
        self.time.text = string.format("%02d:%02d:%02d"..LangUtil.GetSysLang(884), tb.hour, tb.minute, tb.second)
    end
    local money = ""
    local currencyType = ChannelManager:GetInstance():GetCurrencyType()
    if currencyType == ChannelCurrency.JA then
        money = "￥ " .. Z_StarLightStoneShop[self.modeId].Price
    elseif currencyType == ChannelCurrency.US then
        money = "$ " .. Z_StarLightStoneShop[self.modeId].Dollar
    end
    self.payButText.text = money
    LangUtil.GetSpriteLang(langSprite[self.modeId], function(sprite)
        self.bg.sprite = sprite
    end)
    self.bg34.gameObject:SetActive(self.modeId==34)
    self.bg33.gameObject:SetActive(self.modeId==33)
end

function this.Update(self)
    ---@type GameEventComponent
    local activityCom = Game.Scene.Player:GetComponent("GameEventComponent")
    if activityCom.ActivityGifts[self.modeId] ~= nil then
        local tb = TimeUtil.ConvertTimeForm(os.difftime(activityCom.ActivityGifts[self.modeId].LimitDate, TimeUtil.OSTime()))
        self.time.text = string.format(LangUtil.GetSysLang(420).. "%02d:%02d:%02d", tb.hour, tb.minute, tb.second)
    end
    
end

function this.OnAddListener(self)
    base.OnAddListener(self);
end

function this.OnRemoveListener(self)
    base.OnRemoveListener(self);
    
end

function this.OnDisable(self)
    base.OnDisable(self)
    UIManager:GetInstance():GetWindow(UIWindowNames.UIHome).View:InitActiveBtn()
end

function this.OnDestroy(self)
    base.OnDestroy(self);
end


return this
