---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by win 10.
--- DateTime: 2019/5/24 16:58
---

local UISevenStarSectionInfoView = BaseClass("UISevenStarSectionInfoView",UIBaseView);
local base = UIBaseView
local this = UISevenStarSectionInfoView
local maxCount = 10

local function OnClickBattle(self)
    local num = self.sevenStarComponent.Days[self.selectDay]["Diff"..(self.selectDiff).."Num"]
    if num >= maxCount then
        UIUtil.ToolTipFourth(LangUtil.GetSysLang(3075))
        return
    end
    local zStoryLevel = UIUtil.GetSevenStarConfig(self.selectDay,self.selectDiff)
    local launchAtkData = {}
    launchAtkData.Skip = true
    launchAtkData.Day = self.selectDay
    launchAtkData.CompletedDayNum = maxCount - self.sevenStarComponent.Days[self.selectDay]["Diff"..self.selectDiff.."Num"]
    launchAtkData.Diff = self.selectDiff
    launchAtkData.LevelType = LevelType.LevelTypeSevenStar
    launchAtkData.EnergyExpend = zStoryLevel.EnergyExpend
    UIUtil.OpenFormat(launchAtkData)
    UIManager:GetInstance():CloseWindow(UIWindowNames.UISevenStarSectionInfo)
end

local function InitBot(self,zStoryLevel)
    self.needEnergyTxt.text = "AP" .." " .. zStoryLevel.EnergyExpend
    self.needEnergyTxt1.text = "AP".." ".. zStoryLevel.EnergyExpend
end

local function InitLeft(self,zStoryLevel)
    local enemyRoot = self.left:Find("MonsterPanel/EnemyRoot")
    local enemyArray = self.left:Find("ArrayPanel/EnemyArray")
    local playerArray = self.left:Find("ArrayPanel/PlayerArray")
    local launchAtkData = {}
    launchAtkData.Day = self.selectDay
    launchAtkData.Diff = self.selectDiff
    launchAtkData.LevelType = LevelType.LevelTypeSevenStar
    UIBattelModeInfo.InitMonsterArea(enemyRoot, zStoryLevel, launchAtkData)
end

local function InitRight(self,zStoryLevel)
    local conditionRoot = self.right:Find("Conditions/Condition")
    local drop = self.right:Find("Drop/Content")
    local must = self.right:Find("Must/Content")
    UIBattelModeInfo.InitOddObtainArea(drop) --初始化几率奖励
    local ConditionRewards = loadtable(zStoryLevel.ConditionRewards)
    UIBattelModeInfo.InitMustObtainArea(must, loadtable(zStoryLevel.FirstPassRewards), ConditionRewards[1].reward,1) --初始化必定奖励
    UIBattelModeInfo.InitConditionsArea(conditionRoot, ConditionRewards)--条件
end

local function OnClickRestButton(self)
    local num = self.sevenStarComponent.Days[self.selectDay]["Diff"..(self.selectDiff).."Num"]
    if num <= 0 then
        UIUtil.ToolTipFourth(LangUtil.GetSysLang(4041))
        return
    end
    UIUtil.OpenBattleModel(self.selectDiff,self.selectDay)
end

local function OnChallengeCountChg(self)
    self.challengeCountTxt.text = LangUtil.GetSysLang(526).."："..(maxCount - self.sevenStarComponent.Days[self.selectDay]["Diff"..(self.selectDiff).."Num"]).."/"..maxCount
end

local function OnClickMop(self)
    local num = self.sevenStarComponent.Days[self.selectDay]["Diff"..(self.selectDiff).."Num"]
    if num >= maxCount then
        UIUtil.ToolTipFourth(LangUtil.GetSysLang(3075))
        return
    end
    local item = table.first(Game.Scene.Player:GetComponent("ItemComponent").Items,function(v) return v.TemplateId == 3013 end)
    local zStoryLevel = UIUtil.GetSevenStarConfig(self.selectDay,self.selectDiff)
    local KilEnemyNum = UIBattelModeInfo.GetMonsterTotalNum(zStoryLevel)

    local launchAtkData = {}
    launchAtkData.Skip = true
    launchAtkData.Day = self.selectDay
    launchAtkData.CompletedDayNum = maxCount - self.sevenStarComponent.Days[self.selectDay]["Diff"..self.selectDiff.."Num"]
    launchAtkData.Diff = self.selectDiff
    launchAtkData.LevelType = LevelType.LevelTypeSevenStar
    launchAtkData.EnergyExpend = zStoryLevel.EnergyExpend
    Game.Scene:GetComponent("AgainstComponent"):SetCurLevel(launchAtkData)
    local sendData ={Energy = zStoryLevel.EnergyExpend, info = "UISevenStarSectionInfo", maxNum = maxCount - num}
    Game.Scene.Player:GetComponent("StoryComponent"):SendFastPass(sendData,function(itemNum)
        coroutine.start(function()
            local reqData = {}
            reqData.LevelTypeInfo = 1
            reqData.LevelId = tonumber(self.selectDay..self.selectDiff)
            reqData.IsReachRewardCond1 = 1
            reqData.IsSweep = itemNum
            local g2cBattleSettle = coroutine.yieldstart(Game.Scene.Session.CoCall, nil,  Game.Scene.Session,
                    OuterOpcode.Name2Code.ETModel_C2M_BattleSettle, reqData);
            if g2cBattleSettle.Error == ErrorCode.ERR_Success then
                OnChallengeCountChg(self)
                Game.Scene.Player.Energy=g2cBattleSettle.PlayerEnergy
                UIUtil.RemoveItem(item.Id,itemNum)
                UIUtil.BattleSettle(g2cBattleSettle, reqData)

            else
                UIUtil.ToolTipFourth(LangUtil.GetServerError(g2cBattleSettle.Error))
            end
            --end
        end)
    end)
end

function this.OnCreate(self)
    base.OnCreate(self);
    local rc = self.rc
    local closeBtn = rc:GetObject("CloseButton")
    local eventBg = rc:GetObject("EventBg")
    local resetBtn = rc:GetObject("ResetButton")
    self.left = rc:GetObject("Left").transform
    self.right = rc:GetObject("Right").transform
    local bot = rc:GetObject("Bot").transform

    self.battleBtn = bot:Find("BattleButton")
    self.mopBtn = bot:Find("MopButton")
    UIUtil.AddBtnEvent(self.mopBtn,function()OnClickMop(self)end)
    
    UIUtil.AddBtnEvent(self.battleBtn,function()OnClickBattle(self)end)

    local func = function()UIManager:GetInstance():CloseWindow(UIWindowNames.UISevenStarSectionInfo)  end
    EventTriggerListener.Get(eventBg).onLuaClick = function()func() end
    UIUtil.AddBtnEvent(closeBtn,function()func() end)
    UIUtil.AddBtnEvent(resetBtn,function()OnClickRestButton(self)  end)
end

function this.OnLangCreate(self)
    self.titleTxt = LangUtil.BindText(self.langRc:GetObject("Title3Text"))
    self.LevelText = LangUtil.BindText(self.langRc:GetObject("LevelText"))
    self.needEnergyTxt = LangUtil.BindText(self.battleBtn:Find("NeedEnegy/NeedEnegyText"))
    self.needEnergyTxt1 = LangUtil.BindText(self.mopBtn:Find("NeedEnegy/NeedEnegyText"))
    self.challengeCountTxt = LangUtil.BindText(self.langRc:GetObject("ChallengeCountTxt"))
    LangUtil.BindText(self.mopBtn:Find("Text")).text = LangUtil.GetSysLang(872)--速戦
    LangUtil.BindText(self.battleBtn:Find("Text")).text = LangUtil.GetSysLang(92)--出击

    LangUtil.BindText(self.langRc:GetObject("ConditionTitleText")).text = LangUtil.GetSysLang(129)--通关条件
    LangUtil.BindText(self.langRc:GetObject("MustTitleText")).text = LangUtil.GetSysLang(130)--必掉物品
    LangUtil.BindText(self.langRc:GetObject("DropTitleText")).text = LangUtil.GetSysLang(131)--掉落物品
    LangUtil.BindText(self.langRc:GetObject("VSText2")).text = LangUtil.GetSysLang(132)--战阵 我方
    LangUtil.BindText(self.langRc:GetObject("VSText1")).text = LangUtil.GetSysLang(133)--战阵 敌方
    LangUtil.BindText(self.langRc:GetObject("Title1Text")).text = LangUtil.GetSysLang(134)--敌人情报
    LangUtil.BindText(self.langRc:GetObject("ResetBtnText")).text = LangUtil.GetSysLang(643)--重置
    
    local conditionRoot = self.langRc:GetObject("Condition").transform
    for i = 0,conditionRoot.childCount - 1 do
        LangUtil.BindText(conditionRoot:GetChild(i):Find("Text"))
    end
end

function this.OnEnable(self)
    base.OnEnable(self);
    self.gameObject:SetActive(false)
    self.clientData = ClientData:GetInstance()
    self.player = Game.Scene.Player
    self.sevenStarComponent = self.player:GetComponent("SevenStarComponent")
    self.againstComponent = Game.Scene:GetComponent("AgainstComponent")
    local info = self.model.info
    self.selectDay = info.selectDay
    self.selectDiff = info.selectDiff
    local enable = self.sevenStarComponent.Days[self.model.info.type][self.selectDay].OpenDiff > self.selectDiff
    self.mopBtn:GetComponent("Button").enabled = enable
    UIPublic.InitButton(self.mopBtn, enable, 2)
    self:OnRefresh()
    self.gameObject:SetActive(true)
end

function this.OnRefresh(self)
    local sectionId = tonumber(self.selectDay..self.selectDiff)
    local zStorySection = Z_SevenStar[sectionId]
    local zStoryLevel = UIUtil.GetSevenStarConfig(self.selectDay,self.selectDiff)
    self.titleTxt.text = zStorySection.LevelTitle 
    self.LevelText.text = LangUtil.GetSysLang(500) .. zStoryLevel.HintLevel
    --self.challengeCountTxt.text = LangUtil.GetSysLang(526).."："..(maxCount - self.sevenStarComponent.Days[self.selectDay]["Diff"..(self.selectDiff).."Num"]).."/"..maxCount
    coroutine.start(function()
        InitBot(self,zStoryLevel)
        InitLeft(self,zStoryLevel)
        InitRight(self,zStoryLevel)
    end)
end

function this.OnAddListener(self)
    base.OnAddListener(self)
    self:AddUIListener(UIMessageNames.ON_SEVEN_STAR_COUNT_CHG,OnChallengeCountChg)
end

function this.OnRemoveListener(self)
    base.OnRemoveListener(self)
    self:RemoveUIListener(UIMessageNames.ON_SEVEN_STAR_COUNT_CHG)
end

function this.OnDisable(self)
    base.OnDisable(self);
end

function this.OnDestroy(self)
    base.OnDestroy(self);
end

return this;

