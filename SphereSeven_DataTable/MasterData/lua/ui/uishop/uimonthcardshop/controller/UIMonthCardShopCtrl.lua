---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by win 10.
--- DateTime: 2019/4/12 21:12
---

---@class UIMonthCardShopCtrl : UIBaseCtrl
local UIMonthCardShopCtrl = BaseClass("UIMonthCardShopCtrl",UIBaseCtrl)
local this = UIMonthCardShopCtrl

---@param monthCard MonthCard
function this:BuyMonthCard(monthCard)
    ---@param response protocol.BuyPaymentGoodsResp
    PublicRequest.SendRequest(
        PROTOCOL.BuyPaymentGoodsReq,
        {
            goods_id = monthCard.config.ShopId
        },
        function(response, error)
            ---@type MonthCard
            local newMonthCardData = Game.Scene.Player:GetComponent("MonthCardComponent"):GetMonthCard(monthCard.id)
            ---@type ToolTipFirstData
            local toolTipFirstData = {}
            toolTipFirstData.hideBackBtn = true
            toolTipFirstData.hideConfirmBtn = true
            toolTipFirstData.title = ""
            toolTipFirstData.message = string.gsub("购买月卡成功, 当前剩余时间XX天", "XX", TimeUtil.ConvertTimeForm(newMonthCardData:GetLastTime()).day)

            -- 这里自动领取了月卡奖励, response中包含奖励 和 月卡 这个reward, 所以不显示月卡.
            local rewardResults = {}
            for key, value in pairs(response.reward_result) do
                if value.type ~= RewardType.RewardTypeMonthlyCard then
                    table.insert(rewardResults, value)
                end
            end
            toolTipFirstData.closeCallBack = function()
                UIPublic.OpenRewardUI(rewardResults)
            end

            UIUtil.ToolTipFirst(toolTipFirstData)
        end
    )
end

function this.SendTopUpRequest(self)
    --coroutine.start(function()
    --    --TOdo 暂时没有充值接口，提示未开放
    --    --if true then
    --    --    UIUtil.ToolTipFourth(LangUtil.GetSysLang(541));
    --    --    return
    --    --end
    --    local g2cBuyMonthCard = coroutine.yieldstart(Game.Scene.Session.CoCall, nil,  Game.Scene.Session,
    --            OuterOpcode.Name2Code.ETModel_C2G_BuyMonthCard, {})
    --    if g2cBuyMonthCard.Error == ErrorCode.ERR_Success then
    --        
    --        local monthCardComponent = Game.Scene.Player:GetComponent("MonthCardComponent");
    --        monthCardComponent.CurDay = 1;
    --        DataManager:GetInstance():Broadcast(DataMessageNames.ON_MONTH_CARD_INFO_CHG);
    --        UIUtil.ToolTipFourth(LangUtil.GetSysLang(1081));--"够买月卡成功"
    --    else
    --        UIUtil.ToolTipFourth(LangUtil.GetServerError(g2cBuyMonthCard.Error));
    --    end
    --end)
end

return this