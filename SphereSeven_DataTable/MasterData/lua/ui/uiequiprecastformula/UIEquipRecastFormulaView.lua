---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by win 10.
--- DateTime: 2019/5/24 16:58
---

local UIEquipRecastFormulaView = BaseClass("UIEquipRecastFormulaView",UIBaseView);
local base = UIBaseView
local this = UIEquipRecastFormulaView

local color1 = Color.New(103/255,111/255,126/255)

local pfbName1 = "EquipRecastItem1"
local pfbName2 = "EquipRecastItem2"
local pfbName3 = "EquipRecastItem3"
local pfbName4 = "EquipRecastItem4"
function this.OnLangCreate(self)
    LangUtil.BindText(self.langRc:GetObject("Title")).text = LangUtil.GetSysLang(593)--593
    LangUtil.BindText(self.EquipRecastText).text = LangUtil.GetSysLang(752)
    LangUtil.GetSpriteLang(55,function(sprite)
        self.EquipRecastImage.sprite = sprite
    end)
    self.Name = LangUtil.BindText(self.rc:GetObject("Name"))
    self.nameTxt = LangUtil.BindText(self.rc:GetObject("equipName").transform:Find("Value"))
    self.desc = LangUtil.BindText(self.rc:GetObject("Desc"))
    LangUtil.BindText(self.rc:GetObject("AttrText")).text = LangUtil.GetSysLang(912)
    self.desc1 = LangUtil.BindText(self.rc:GetObject("Desc1"))
    self.prop = LangUtil.BindText(self.rc:GetObject("Prop").transform:Find("Value"))
    self.target = LangUtil.BindText(self.rc:GetObject("Target").transform:Find("Value"))
    self.type = LangUtil.BindText(self.rc:GetObject("Type").transform:Find("Value"))
    self.part = LangUtil.BindText(self.rc:GetObject("Part").transform:Find("Value"))
    self.department = LangUtil.BindText(self.rc:GetObject("Department").transform:Find("Value"))
    self.kind = LangUtil.BindText(self.rc:GetObject("Kind").transform:Find("Value"))
    self.level = LangUtil.BindText(self.rc:GetObject("Level").transform:Find("Value"))

    LangUtil.BindText(self.rc:GetObject("equipName").transform:Find("Name").transform).text = LangUtil.GetSysLang(810)
    LangUtil.BindText(self.rc:GetObject("Prop").transform:Find("Name").transform).text = LangUtil.GetSysLang(683)
    LangUtil.BindText(self.rc:GetObject("Target").transform:Find("Name").transform).text = LangUtil.GetSysLang(682)
    LangUtil.BindText(self.rc:GetObject("Type").transform:Find("Name").transform).text = LangUtil.GetSysLang(681)
    LangUtil.BindText(self.rc:GetObject("Part").transform:Find("Name").transform).text = LangUtil.GetSysLang(680)
    LangUtil.BindText(self.rc:GetObject("Department").transform:Find("Name").transform).text = LangUtil.GetSysLang(679)
    LangUtil.BindText(self.rc:GetObject("Kind").transform:Find("Name").transform).text = LangUtil.GetSysLang(678)
    LangUtil.BindText(self.rc:GetObject("Level").transform:Find("Name").transform).text = LangUtil.GetSysLang(751)
end

local function InitEquipInfo(self,Equip)

    local zEquip = Equip
   -- local mEquip = Equip
    self.nameTxt.text = zEquip.Name
    self.type.text = self.atkRangeNames[zEquip.AtkRange]
    self.part.text = self.partNames[zEquip.Part]
    self.kind.text = self.kindNames[zEquip.Kind]
    self.desc1.text = zEquip.Desc
    local star = 1
    local level = 1
    local descStr
    if zEquip.Exclusive == 0 then
        star = zEquip.Star
        self.level.text = "1"
        descStr = zEquip.AdditionEfx
        if zEquip.BaseAttrVal[2] == nil  then
            self.prop.text = self.baseAttrTypeNames[zEquip.BaseAttrType[1]].."+"..zEquip.BaseAttrVal[1]
        else
            self.prop.text = self.baseAttrTypeNames[zEquip.BaseAttrType[1]].."+"..zEquip.BaseAttrVal[1].."~"..zEquip.BaseAttrVal[2]
        end

        self.target.text = self.targetNames[zEquip.AtkType]
        self.department.text = self.departmentData[zEquip.Series]
    else
        level = 5
        self.level.text = "5"
        descStr = zEquip.ExclusiveEfx
        self.prop.text = self.baseAttrTypeNames[zEquip.BaseAttrType[1]].."+"..zEquip.BaseAttrVal[1]
        self.target.text = Z_Card[zEquip.Exclusive].Name
        self.department.text = LangUtil.GetSysLang(287)
    end
    if string.IsNullOrEmpty(descStr) then
        self.desc.color = color1
        self.desc.text = LangUtil.GetSysLang(911)
    else
        self.desc.color = Color.white
        self.desc.text = descStr
    end
    
    for i, v in pairs(self.rc_listGo) do
        local select = v.transform:Find("IconRoot2/Select").gameObject
        select:SetActive( self.cur_equip.Id  == Equip.Id )
    end
    --if mEquip ~= nil then
    --    local attr = mEquip:GetComponent("EquipAttrComponent"):GetAttr()
    --    self.prop.text = self.baseAttrTypeNames[zEquip.BaseAttrType[1]].."+"..math.modf(attr)
    --    UIPublic.InitEquipItemNew(self.equipItem,mEquip)
    --else
    --    local equip = {TemplateId = zEquip.Id,Id = -1,Lock = 0,Star = star,Level = level,}
    --    UIPublic.InitEquipItemNew(self.equipItem,equip)
    --end

    

end


function this.InitEquipItem(self,go,equip)
    local zEquip = equip
    
    local StarBg = go.transform:Find("IconRoot2/StarBg"):GetComponent("Image")
    local Avatar = go.transform:Find("IconRoot2/Avatar"):GetComponent("Image")
    local StarRoot = go.transform:Find("IconRoot2/StarRoot")
    LangUtil.BindText( go.transform:Find("IconRoot2/Image/Name")).text = zEquip.Name
    for j = 0,StarRoot.childCount - 1 do
        local child = StarRoot:GetChild(j).gameObject
        child:SetActive((j+1) <= zEquip.Star)
    end
    
    UIPublic.InitEquipBg(zEquip,StarBg)
    UIUtil.SetSprite(Avatar,AtlasConfig.Equip,zEquip.EquipIcon)
end

function this.showItem(self)
    ListChildPool:GetInstance():ClearContent(self.plane1Content)
    for i, v in pairs(self.rc_list) do
        ListChildPool:GetInstance():GetChild(pfbName3,self.plane1Content,function(go)
            local gameObject = go
            local equip = v
            local select = gameObject.transform:Find("IconRoot2/Select").gameObject
            local IconRoot = gameObject.transform:Find("IconRoot2").gameObject
            IconRoot:SetActive(true)
            self:InitEquipItem(gameObject.transform,equip)
            select:SetActive( self.cur_equip.Id  == equip.Id )
            table.insert(self.rc_listGo,go)
            --local mask = gameObject.transform:Find("Mask").gameObject
            --mask:SetActive(false)
            UIUtil.AddBtnEvent(gameObject,function() InitEquipInfo(self,equip) self.cur_equip.Id = equip.Id   end)
        end)
    end
    ListChildPool:GetInstance():GetChild(pfbName3,self.plane1Content,function(go)
        local gameObject = go
        local IconRoot = gameObject.transform:Find("IconRoot2").gameObject
        IconRoot:SetActive(false)
        UIUtil.AddBtnEvent(gameObject,function() end)
    end)
end

function this.OnCreate(self)
    base.OnCreate(self);
    self.rc_list = {}
    self.rc_listGo = {}
    --self.rc_scroll = VerticalScroll.New()
    --self.rc_scroll:SetUpdateCount(3)
    self.rc_scrollView = self.rc:GetObject("Plane1Scroll View"):GetComponent("ScrollRect")
    self.PropWindow1 = self.rc:GetObject("BG1")
    self.PropWindow1:SetActive(false)
    self.plane1Content = self.rc:GetObject("plane1Content")
    self.EventBg1 = self.rc:GetObject("EventBg1")
    --self.rc_scroll:Clear()
    --self.rc_scroll:ScrollInit(self.rc_list, self.rc_scrollView, pfbName3, function (arg)
    --    local gameObject = arg.go
    --    local equip = arg.data
    --    local select = gameObject.transform:Find("IconRoot2/Select").gameObject
    --    self:InitEquipItem(gameObject.transform,equip)
    --    select:SetActive( self.cur_equip.Id  == equip.Id )
    --    --local mask = gameObject.transform:Find("Mask").gameObject
    --    --mask:SetActive(false)
    --    UIUtil.AddBtnEvent(gameObject,function() InitEquipInfo(self,equip) self.cur_equip.Id = equip.Id  self.rc_scroll:RefreshData(self.rc_list)  end)
    --end)
    self.Content = self.rc:GetObject("Content")
    self.EquipRecastImage = self.rc:GetObject("EquipRecastImage"):GetComponent("Image")
    self.EquipRecastText = self.rc:GetObject("EquipRecastText")
    self.ItemRoot = self.rc:GetObject("ItemRoot")
    local eventBg = self.rc:GetObject("EventBg")
    local closeBtn = self.rc:GetObject("CloseButton")
    UIUtil.AddBtnEvent(closeBtn,function() UIManager:GetInstance():CloseWindow(UIWindowNames.UIEquipRecastFormula)   end)
    EventTriggerListener.Get(eventBg).onLuaClick = function() 
        UIManager:GetInstance():CloseWindow(UIWindowNames.UIEquipRecastFormula) 
    end
    UIUtil.AddBtnEvent(self.EventBg1,function() self.PropWindow1:SetActive(false) self.EventBg1:SetActive(false)  end)
end

function this.OnEnable(self)
    base.OnEnable(self);
    
    self:OnRefresh();
    
    self.targetNames = {LangUtil.GetSysLang(175),LangUtil.GetSysLang(176),LangUtil.GetSysLang(675),}
    self.baseAttrTypeNames = {"HP","ATK","DEF","SPD","HP%","ATK%","DEF%","SPD%"}
    self.atkRangeNames = {LangUtil.GetSysLang(185),LangUtil.GetSysLang(186),LangUtil.GetSysLang(675)}
    self.partNames = {LangUtil.GetSysLang(243),LangUtil.GetSysLang(244),LangUtil.GetSysLang(245),LangUtil.GetSysLang(246),
                      LangUtil.GetSysLang(247),LangUtil.GetSysLang(248),}
    self. kindNames = {LangUtil.GetSysLang(676),LangUtil.GetSysLang(677),LangUtil.GetSysLang(248)}

    self.departmentData = {}
    for i = 753,786 do
        table.insert(self.departmentData,LangUtil.GetSysLang(i))
    end
end



function this.OnRefresh(self)
    self.gameObject:SetActive(false)
    self.Content.transform:DOLocalMoveX(9999,0)
    self.cur_equip = nil
    local pfb2Name = nil
    ListChildPool:GetInstance():ClearContent(self.ItemRoot)
    local objects = {}
    for i = 1, #Z_EquipFormula do
        coroutine.start(function ()
            local v = Z_EquipFormula[i]
            local EquipList = {}
            local zEquip1 = nil
            local zEquip2 = nil
            if table.count(v.Formula2)>2 then
                table.insert(EquipList,Z_Equip[v.EquipId])
                for b = 1, #v.Formula2 do
                    table.insert(EquipList,Z_Equip[v.Formula2[b]])
                end
                pfb2Name = pfbName4
                ListChildPool:GetInstance():GetChild(pfb2Name,self.ItemRoot,function(go)
                    objects[i] = go
                    local transform = go.transform
                    transform:GetComponent("Image").enabled = i%2==0
                    for k = 1, 6 do
                        coroutine.start(function ()
                            local root = transform:Find("IconRoot"..k)
                            local StarBg = root:Find("StarBg"):GetComponent("Image")
                            local Avatar = root:Find("Avatar"):GetComponent("Image")
                            --local Frame = root:Find("Frame"):GetComponent("Image")
                            local StarRoot = root:Find("StarRoot")
                            --LangUtil.BindText( root:Find("Level")).text = (i == 1 and {"LV.1"} or {"LV.5"})[1]
                            if k ==1 then
                                LangUtil.BindText( root:Find("Name")).text = string.gsub(v.name[k], "XX", EquipList[k].Name)
                            else
                                LangUtil.BindText( root:Find("Name")).text = "<color=#fff2aa>x1</color>"
                            end

                            for j = 0,StarRoot.childCount - 1 do
                                local child = StarRoot:GetChild(j).gameObject
                                child:SetActive((j+1) <= EquipList[k].Star)
                            end
                            UIPublic.InitEquipBg(EquipList[k],StarBg)
                            UIUtil.SetSprite(Avatar,AtlasConfig.Equip,EquipList[k].EquipIcon)
                            UIUtil.AddBtnEvent(root.gameObject, function()
                                UIManager:GetInstance():OpenWindow(UIWindowNames.UIEquipProp,{TemplateId = EquipList[k].Id })
                            end)
                        end)
                    end
                end)
            else
                if table.count(v.Formula1) > 1 or table.count(v.Formula2) > 1  then
                    if table.count(v.Formula1) > 1 then
                        zEquip1 = table.first(Z_Equip,function(h) return h.Series == v.Formula1[1] and h.Star == v.Num[1] + v.Num[2] - 1  end)
                        zEquip2 = table.first(Z_Equip,function(h) return h.Series == v.Formula1[2] and h.Star == v.Num[1] + v.Num[2] - 1  end)
                        table.insert(EquipList,Z_Equip[v.EquipId])
                        table.insert(EquipList,zEquip1)
                        table.insert(EquipList,zEquip2)
                    else
                        zEquip1 = Z_Equip[v.Formula2[1]]
                        zEquip2 = Z_Equip[v.Formula2[2]]
                        table.insert(EquipList,Z_Equip[v.EquipId])
                        table.insert(EquipList,zEquip1)
                        table.insert(EquipList,zEquip2)
                    end

                    if zEquip1 ~= nil and zEquip2 ~= nil and Z_Equip[v.EquipId] ~= nil  then
                        pfb2Name = pfbName1
                        ListChildPool:GetInstance():GetChild(pfb2Name,self.ItemRoot,function(go)
                            objects[i] = go
                            local transform = go.transform
                            transform:GetComponent("Image").enabled = i%2==0
                            for k = 1, 3 do
                                coroutine.start(function ()
                                    local root = transform:Find("IconRoot"..k)
                                    local StarBg = root:Find("StarBg"):GetComponent("Image")
                                    local Avatar = root:Find("Avatar"):GetComponent("Image")
                                    --local Frame = root:Find("Frame"):GetComponent("Image")
                                    local StarRoot = root:Find("StarRoot")
                                    --LangUtil.BindText( root:Find("Level")).text = (i == 1 and {"LV.1"} or {"LV.5"})[1]
                                    LangUtil.BindText( root:Find("Name")).text = string.gsub(v.name[k], "XX", EquipList[k].Name)
                                    for j = 0,StarRoot.childCount - 1 do
                                        local child = StarRoot:GetChild(j).gameObject
                                        child:SetActive((j+1) <= EquipList[k].Star)
                                    end
                                    UIPublic.InitEquipBg(EquipList[k],StarBg)
                                    UIUtil.SetSprite(Avatar,AtlasConfig.Equip,EquipList[k].EquipIcon)
                                    if table.count(v.Formula1) > 1 then
                                        if k > 1 then
                                            UIUtil.AddBtnEvent(root.gameObject, function()
                                                --local equips  =Game.Scene.Player:GetComponent("EquipComponent").Equips
                                                self.rc_list = table.choose(Z_Equip,function(a,b) return b.Series == EquipList[k].Series and b.Star == EquipList[k].Star  end)
                                                self.cur_equip = table.first(self.rc_list,function(a) return a.Id ~= 0  end)
                                                InitEquipInfo(self,self.cur_equip)
                                                this.showItem(self)
                                                LangUtil.BindText(self.Name).text = v.Series[k-1]
                                                self.PropWindow1:SetActive(true)
                                                self.plane1Content.transform:DOLocalMoveY(0,0)
                                                self.EventBg1:SetActive(true)
                                            end)
                                        else
                                            UIUtil.AddBtnEvent(root.gameObject, function()
                                                UIManager:GetInstance():OpenWindow(UIWindowNames.UIEquipProp,{TemplateId = EquipList[k].Id })
                                            end)
                                        end
                                    else
                                        UIUtil.AddBtnEvent(root.gameObject, function()
                                            UIManager:GetInstance():OpenWindow(UIWindowNames.UIEquipProp,{TemplateId = EquipList[k].Id })
                                        end)
                                    end
                                end)
                            end
                        end)
                    end
                else
                    table.insert(EquipList,Z_Equip[v.EquipId])
                    table.insert(EquipList,Z_Equip[v.Formula2[1]])
                    pfb2Name = pfbName2
                    ListChildPool:GetInstance():GetChild(pfb2Name,self.ItemRoot,function(go)
                        objects[i] = go
                        local transform = go.transform
                        transform:GetComponent("Image").enabled = i%2==0
                        for k = 1, 2 do
                            coroutine.start(function ()
                                local root = transform:Find("IconRoot"..k)
                                local StarBg = root:Find("StarBg"):GetComponent("Image")
                                local Avatar = root:Find("Avatar"):GetComponent("Image")
                                --local Frame = root:Find("Frame"):GetComponent("Image")
                                local StarRoot = root:Find("StarRoot")
                                --LangUtil.BindText( root:Find("Level")).text = (i == 1 and {"LV.1"} or {"LV.5"})[1]
                                LangUtil.BindText( root:Find("Name")).text = string.gsub(v.name[k], "XX", EquipList[k].Name)
                                for j = 0,StarRoot.childCount - 1 do
                                    local child = StarRoot:GetChild(j).gameObject
                                    child:SetActive((j+1) <= EquipList[k].Star)
                                end
                                UIPublic.InitEquipBg(EquipList[k],StarBg)
                                UIUtil.SetSprite(Avatar,AtlasConfig.Equip,EquipList[k].EquipIcon)
                                UIUtil.AddBtnEvent(root.gameObject, function()
                                    UIManager:GetInstance():OpenWindow(UIWindowNames.UIEquipProp,{TemplateId = EquipList[k].Id })
                                end)
                            end)
                        end
                    end)
                end
            end
        end)
    end
    coroutine.waituntil(function () return table.count(objects) >= #Z_EquipFormula end)
    table.walk(objects, function (k, v) 
        v.transform:SetAsLastSibling()
    end)
    self.gameObject:SetActive(true)
    LayoutRebuilder.ForceRebuildLayoutImmediate(self.Content:GetComponent("RectTransform"))
    coroutine.waitforframes(1)
    self.Content.transform:DOLocalMoveX(0, 0)
    self.Content.transform:DOLocalMoveY(0, 0)
end




function this.OnAddListener(self)
    base.OnAddListener(self)
end

function this.OnRemoveListener(self)
    base.OnRemoveListener(self);
end

function this.OnDisable(self)
    base.OnDisable(self);
end

function this.OnDestroy(self)
    base.OnDestroy(self);
    --self.rc_scroll:Dispose()
end

return this;

