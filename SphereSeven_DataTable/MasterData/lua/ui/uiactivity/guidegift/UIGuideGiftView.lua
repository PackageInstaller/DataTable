---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by wwj.
--- DateTime: 2022/9/13 15:35
---
local UIGuideGiftView = BaseClass("UIGuideGiftView",UIBaseView);
local base = UIBaseView
local this = UIGuideGiftView

local item_prefab_path = "GuideGiftItem"
local fuck = {[2]=355,[3]=357,[7]=358,[50]=356}  -- 角色  战魂   装备  皮肤  353bg   354 btn
local toUISkinShop = false

function this.OnCreate(self)
    base.OnCreate(self);
    self.content =  self.rc:GetObject("Content")
    self.close = self.rc:GetObject("Close")
    self.event = self.rc:GetObject("event")
    self.Bg = self.rc:GetObject("Bg"):GetComponent("Image")
    self.Button = self.rc:GetObject("Button"):GetComponent("Image")
    UIUtil.AddBtnEvent(self.event, function () UIManager:GetInstance():CloseWindow(UIWindowNames.UIGuideGift)  end)
    UIUtil.AddBtnEvent(self.close, function () UIManager:GetInstance():CloseWindow(UIWindowNames.UIGuideGift)  end)
    UIUtil.AddBtnEvent(self.Button, function ()
        toUISkinShop = true
        UIManager:GetInstance():OpenWindow(UIWindowNames.UISkinShop)
        UIManager:GetInstance():CloseWindow(UIWindowNames.UIGuideGift)
    end)
end

function this.OnEnable(self)
    base.OnEnable(self)
    self:OnRefresh()
end

function this.OnLangCreate(self)
    LangUtil.GetSpriteLang(353, function(sprite) self.Bg.sprite = sprite end)
    LangUtil.GetSpriteLang(354, function(sprite) self.Button.sprite = sprite end)
end

function this.OnRefresh(self)
    toUISkinShop = false
    self.activityCom = Game.Scene.Player:GetComponent("GameEventComponent")
    local info = table.choose(Z_ActivityLoginInfo,function(k,v) return v.ActivityId == 1002  end)
    self:InitContent1(info)
    
    
end

function this.InitContent1(self,shop_data)
    ListChildPool:GetInstance():ClearContent(self.content);
    local rootList = {}
    coroutine.start(function()
        for k,v in table.pairsByKeys(shop_data) do
            ListChildPool:GetInstance():GetChild(item_prefab_path,self.content,function(object)
                local transform = object.transform:Find("bg/root/root1");
                local root = object.transform:Find("bg/root");
                table.insert(rootList,root)
                local day_text = LangUtil.BindText(object.transform:Find("title"))
                local received = object.transform:Find("Received").gameObject;
                local root1 = transform:Find("root2")
                local root2 = transform:Find("root3")
                --local day = string.sub(tostring(k),4,-1)
               
                day_text.text = string.gsub(LangUtil.GetSysLang(722),"X",k-20)
                
                received:SetActive(true);
                local num = v.ItemNum%2
                local root1Num = math.floor(v.ItemNum/2)+num
                local root2Num = math.floor(v.ItemNum/2)

               
                    for i = 0,root1.transform.childCount-1 do

                        if root1Num<i +1 then
                            root1:GetChild(i).gameObject:SetActive(false)
                        else
                            local num_text = LangUtil.BindText(root1:GetChild(i):Find("NumText"),"Number")
                            local avatar = root1:GetChild(i):Find("mask/avatar"):GetComponent("Image");
                            local rewardInfo = {}
                            rewardInfo.TemplateId = v.TemplateId[i+1]
                            rewardInfo.RewardTypeInfo = RewardTypeComm[v.RewardType[i+1]]
                            rewardInfo.Num = v.Num[i+1]
                            local cfg = UIUtil.SetRewardInfo(rewardInfo,avatar,{numText = num_text},true)

                            root1:GetChild(i).gameObject:SetActive(true)
                        end
                        
                    end
                
                     for i = 0,root2.transform.childCount-1 do
                         if root2Num<i +1 then
                             root2:GetChild(i).gameObject:SetActive(false)
                         else
                             local num_text = LangUtil.BindText(root2:GetChild(i):Find("NumText"),"Number")
                             local avatar = root2:GetChild(i):Find("mask/avatar"):GetComponent("Image");
                             local rewardInfo = {}
                             rewardInfo.TemplateId = v.TemplateId[root1Num+1+i]
                             rewardInfo.RewardTypeInfo = RewardTypeComm[v.RewardType[root1Num+1+i]]
                             rewardInfo.Num = v.Num[root1Num+1+i]
                             local cfg = UIUtil.SetRewardInfo(rewardInfo,avatar,{numText = num_text},true)

                             root2:GetChild(i).gameObject:SetActive(true)
                         end
                        
                    end
                root.transform:GetChild(4).gameObject:SetActive(false)
                for i = 1 , root.transform.childCount-2 do
                    if v.RewardType[v.ItemNum+i] == 50 then
                        local image =  root.transform:GetChild(4):Find("Image"):GetComponent("Image")
                        LangUtil.GetSpriteLang(fuck[50], function(sprite) image.sprite = sprite end)
                        root.transform:GetChild(4).gameObject:SetActive(true)
                    end
                    if table.count(v.RewardType) - v.ItemNum >= i and v.RewardType[v.ItemNum+i] ~= 50 then
                        local image =  root.transform:GetChild(i):Find("Image"):GetComponent("Image")
                        LangUtil.GetSpriteLang(fuck[v.RewardType[v.ItemNum+i]], function(sprite) image.sprite = sprite end)
                        root.transform:GetChild(i).gameObject:SetActive(true)
                    else
                        root.transform:GetChild(i).gameObject:SetActive(false)
                    end
                end
                

                if (not table.any(self.activityCom.ActivityLogins[1002].Records, function(a) return a == k - 20 end) ) then
                    received:SetActive(false)
                else
                    received:SetActive(true)
                end
                coroutine.waitforframes(1)
                LayoutRebuilder.ForceRebuildLayoutImmediate(root:GetComponent("RectTransform"))
            end)
        end
        for  k = 1 , self.activityCom.ActivityLogins[1002].LoginNum  do
            if not table.any(self.activityCom.ActivityLogins[1002].Records, function(v) return v == k end) then
                table.insert(self.activityCom.ActivityLogins[1002].Records, k)
                if k ~= self.activityCom.ActivityLogins[1002].LoginNum then
                    self.activityCom:ReceiveLoginReward(1002,k + 20)
                else
                    self.activityCom:ReceiveLoginReward(1002,k + 20,self:OnRefresh())
                end
                
            end
        end
        
        
    end)
end

function this.OnAddListener(self)
    base.OnAddListener(self)
end

function this.OnRemoveListener(self)
    base.OnRemoveListener(self);
end

function this.OnDisable(self)
    base.OnDisable(self);
    coroutine.start(function()
        local monthCardComponent = Game.Scene.Player:GetComponent("MonthCardComponent");
        local story = Game.Scene.Player:GetComponent("StoryComponent").StoryChapters
        local activityCom = Game.Scene.Player:GetComponent("GameEventComponent")
        local storyChapter = table.first(story, function(a)
            return a.LevelType == LevelType.LevelTypeStory 
        end)
        local AwardDay = monthCardComponent.AwardDay;
        local day = monthCardComponent.CurDay
        local SevenAwardDay = monthCardComponent.SevenAwardDay
        local SevenCurDay = monthCardComponent.SevenCurDay
        local ThreeAwardDay = monthCardComponent.ThreeAwardDay
        local ThreeCurDay = monthCardComponent.ThreeCurDay
        if toUISkinShop then
            return
        end
        if Game.Scene.Player.SigninToday == 0 then
            coroutine.waitforseconds(1.5)
            
            UIManager:GetInstance():OpenWindow(UIWindowNames.UIDailyReward)
        elseif Game.Scene.Player.NewToday == 0 and Game.Scene.Player.NewNum < 14 then

            coroutine.waitforseconds(1.5)
            UIManager:GetInstance():OpenWindow(UIWindowNames.UIActivityPop)
        elseif day > AwardDay or SevenCurDay > SevenAwardDay or ThreeCurDay > ThreeAwardDay then

            coroutine.waitforseconds(1.5)
            if Game.Scene:GetComponent("SceneComponent"):GetCurrentScene() ~= SceneConfig.HomeScene.Name then
                return
            end
            monthCardComponent:OpenMonthlyCardUI()

        else
            UIManager:GetInstance():GetWindow(UIWindowNames.UIHome).View.eventImg:SetActive(false)

            coroutine.waitforseconds(1.5)
            if Game.Scene:GetComponent("SceneComponent"):GetCurrentScene() ~= SceneConfig.HomeScene.Name then
                return
            end
            local GuideComplete, GuideStep, run = Game.Scene:GetComponent("GuideComponent"):GetCurrentData()
            if run == false and UIManager:GetInstance():GetLastBgWindowName() == UIWindowNames.UIHome then
                --local faceId = Game.Scene:GetComponent("SoundComponent"):PlayFirstLoginSound()
                local home = UIManager:GetInstance():GetWindow(UIWindowNames.UIHome)
                if home ~= nil and home.View ~= nil then
                    home.View.uiDrawing:CoPlay(SoundType.Main)
                end
            end
            coroutine.waitforseconds(0.5)
            UIManager:GetInstance():GetWindow(UIWindowNames.UIHome).View.eventImg:SetActive(false)
            if storyChapter ~= nil then
                if storyChapter.CompletedSections[1].CompletedId >= 103 and table.first(activityCom.ActivityGifts, function(a)
                    return a.Id == 33
                end) == nil then
                    UIManager:GetInstance():OpenWindow(UIWindowNames.ToolTipGiftBag, { ModeId = 33 })
                elseif storyChapter.CompletedSections[1].CompletedId >= 110 and table.first(activityCom.ActivityGifts, function(a)
                    return a.Id == 34
                end) == nil then
                    UIManager:GetInstance():OpenWindow(UIWindowNames.ToolTipGiftBag, { ModeId = 34 })
                end

            end

        end

    end)
end
function this.OnDestroy(self)
    base.OnDestroy(self);
end

return this