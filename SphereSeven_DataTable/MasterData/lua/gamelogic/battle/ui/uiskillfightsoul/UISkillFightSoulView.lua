---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by daiyi.
--- DateTime: 2019/6/21 17:53
---
local UISkillFightSoulView = BaseClass("UISkillFightSoulView", UIBaseView)
local this = UISkillFightSoulView
local base = UIBaseView

local function GetSkillStr(self)
    local zSkill = Z_Skill[self.zCard.PassiveSkill]
    local SkillDesc = loadtable(zSkill.SkillDesc);
    local stage1s = { LangUtil.GetSysLang(150),
                      LangUtil.GetSysLang(151), LangUtil.GetSysLang(152), }

    local id = tonumber(string.sub(tostring(zSkill.Id), -1))
    local isMonster = self.zCard.IsMonster
    local colorLs = "</color>"
    local str_Lock = LangUtil.GetSysLang(148)--已解锁
    local str_DeLock = LangUtil.GetSysLang(149)--未解锁
    local str = ""

    if isMonster ~= 1 then
        local tempId = 0
        if id < 4 then
            tempId = 1
        elseif id < 5 then
            tempId = 2
        else
            tempId = 3
        end

        for k, v in table.pairsByKeys(SkillDesc) do
            if self.model.card.Star >= 5 then
                str = str .. "<color=#FFF2AA>" .. stage1s[tempId] .. ":\u{00A0}" .. colorLs .. "<color=#4CEC9E>" .. "(" .. str_Lock .. ")" .. colorLs .. v .. "\n"
            elseif self.model.card.Star >= 3 and tempId == 2 then
                str = str .. "<color=#FFF2AA>" .. stage1s[tempId] .. ":\u{00A0}" .. colorLs .. "<color=#4CEC9E>" .. "(" .. str_Lock .. ")" .. colorLs .. v .. "\n"
            elseif tempId == 1 then
                str = str .. "<color=#FFF2AA>" .. stage1s[tempId] .. ":\u{00A0}" .. colorLs .. "<color=#4CEC9E>" .. "(" .. str_Lock .. ")" .. colorLs .. v .. "\n"
            else
                str = str .. "<color=#FFF2AA>" .. stage1s[tempId] .. ":\u{00A0}" .. colorLs .. "<color=#F41F42>" .. "(" .. str_DeLock .. ")" .. colorLs .. v .. "\n"
            end
            tempId = tempId + 1
        end

        if id == 2 or id == 1 then
            if self.model.card.CloseDegree >= 100 then
                str = str .. "<color=#FFF2AA>" .. LangUtil.GetSysLang(625) .. "Max:\u{00A0}" .. colorLs .. "<color=#4CEC9E>" .. "(" .. str_Lock .. ")" .. colorLs .. zSkill.CloseFullEfx .. "\n"
            else
                str = str .. "<color=#FFF2AA>" .. LangUtil.GetSysLang(625) .. "Max:\u{00A0}" .. colorLs .. "<color=#F41F42>" .. "(" .. str_DeLock .. ")" .. colorLs .. zSkill.CloseFullEfx .. "\n"
            end
        end
        
    end

    return str
end

local function InitSkillPanel(self)
    local skill = Z_Skill[self.zCard.PassiveSkill]
    self.desc.text = GetSkillStr(self)
    self.name.text = skill.Name
    UIUtil.SetSprite(self.icon, AtlasConfig.SkillIcon, skill.SkillIcon, true)
end

local function InitFightSoulPanel(self)

    local fightSoulTab = { { id = self.model.card.FightSoul1, soul = self.soulList[1] },
                           { id = self.model.card.FightSoul2, soul = self.soulList[2] },
                           { id = self.model.card.FightSoul3, soul = self.soulList[3]} }
    for k, v in pairs(fightSoulTab) do
        local transform = v.soul
        local fightSoul = table.first(self.FightComp, function(a)
            return v.id == a.Id
        end)
        if v.id ~= 0 then
            fightSoul = self.FightComp[v.id]
        end

        if fightSoul == nil then
            transform.gameObject:SetActive(false)
            self.textList[k].text  = ""
        else
            transform.gameObject:SetActive(true)
            local zFightSoul = Z_FightSoul[fightSoul.TemplateId]
            local avatar = transform:Find("Mask/Avatar"):GetComponent("Image")
            local frame = transform:Find("Frame"):GetComponent("Image")
            local sub = transform:Find("Sub"):GetComponent("Image")
            local name = transform:Find("NameTextRoot/Name")
            local starRoot = transform:Find("StarRoot")
            local star = fightSoul.Star
            LangUtil.BindText(name).text = zFightSoul.Name
            avatar:DOFade(1, 0)
            coroutine.start(function()
                UIUtil.SetFightSoulSprite(avatar, zFightSoul.Id, FightSoulPictureType.Little)
                frame.sprite = AtlasManager:GetInstance():CoLoadImageAsync("UI/FightSoulFrame/" .. UIPublic.RareNames[zFightSoul.Rare] .. "_2.png")
                sub.sprite = AtlasManager:GetInstance():CoLoadImageAsync(AtlasConfig.FightSoulSub.AtlasPath .. "/" .. zFightSoul.Id .. ".png")
                LangUtil.BindText(sub.transform:Find("Text")).text = zFightSoul.Desc
            end)
            self.textList[k].text = zFightSoul.EquipEfx
            for i = 0, starRoot.childCount - 1 do
                starRoot:GetChild(i).gameObject:SetActive(star >= (i + 1))
            end
        end

    end
end

function this.OnCreate(self)
    base.OnCreate(self)
    EventTriggerListener.Get(self.rc:GetObject("EventBg")).onLuaClick = function()
        self.ctrl:CloseSelf()
    end
    self.icon = self.rc:GetObject("Icon"):GetComponent("Image")
    self.soulList = {}
    self.textList = {}

end

function this.OnLangCreate(self)
    LangUtil.BindText(self.rc:GetObject("RightTitle")).text = LangUtil.GetSysLang(140)--被动
    LangUtil.BindText(self.rc:GetObject("LeftTitle")).text = LangUtil.GetSysLang(629)--战魂装备
    self.name = LangUtil.BindText(self.rc:GetObject("SkillName"))
    self.desc = LangUtil.BindText(self.rc:GetObject("Desc"))

    local panel = self.rc:GetObject("FightSoulList").transform
    for i = 0, panel.childCount - 1 do
        local child = panel:GetChild(i)
        self.soulList[i + 1] = child:Find("FightVisitItemMid")
        self.textList[i + 1] = LangUtil.BindText(child:Find("Text"):GetComponent("Text"))
    end
end

function this.OnEnable(self)
    base.OnEnable(self)
    self.zCard = Z_Card[self.model.card.TemplateId]
    self.FightComp = Game.Scene.Player:GetComponent("FightSoulComponent").FightSouls
    self.desc.transform.localPosition = Vector3.zero

    self:OnRefresh()
end

function this.OnRefresh(self)
    InitSkillPanel(self)
    InitFightSoulPanel(self)
end

return this