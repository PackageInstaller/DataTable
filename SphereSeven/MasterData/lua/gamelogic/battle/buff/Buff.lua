---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by daiyi.
--- DateTime: 2019/4/19 15:12
---
local Buff = BaseClass("Buff")

local function __init(self,buffId,fromSkillId,srcUnit,targetUnit,isDeBuff,name)
    self.BuffId = buffId
    self.FromSkillId = fromSkillId
    self.battle_component = Game.Scene:GetComponent("BattleComponent")
    if self.battle_component then
        self.uuid = self.battle_component:GenUUID()
    end
    if srcUnit ~= nil then
        self.SrcUnit = srcUnit
        self.__snc = srcUnit:GetComponent("NumericComponent")
    end
    self.TargetUnit = targetUnit
    self.__tcc = targetUnit:GetComponent("CharacterComponent")
    self.__tnc = targetUnit:GetComponent("NumericComponent")
    self.__tbc = targetUnit:GetComponent("BuffComponent")
    self.__tsc = targetUnit:GetComponent("SkillComponent")
    self.__tec = targetUnit:GetComponent("SsUnitEffectComponent")
    self.IsDeBuff = isDeBuff
    --自身是否可叠加
    self.IsSelfMultiply = false
    --互相是否不可叠加
    self.IsEachNotMultiply = false
    self.IsCannotDispelled = false
    self.Name = name
    -- 不限制回合数
    self.IsNotTurnBuff = false
    self.LeftTurn = 0
    self.IsRemoved = false
    self.NumericType = nil
    self.NumericVal = 0
    self.Icon = nil
    self.Desc = nil
    self.Kind = 0
    self.Efx = nil
    self.EfxSp=nil
    self.Forever = false
    self.Data = {}
    self.Tags = {}
end

local function __log_header(self)
    local tgroup = self.TargetUnit.IsPlayer and "--我方" or "--敌方"
    local twho = self.TargetUnit.Name
        return "["..tgroup.." "..twho.." --获得 "..self.Name.." Buff]"
end

local function GetDesc(self)
    local desc = self.Desc
    if self.NumericVal > 0 then
        if not self.IsDeBuff then
            desc = desc.."+"..math.modf(self.NumericVal)
        else
            desc = desc.."-"..math.modf(self.NumericVal)
        end
        if (self.BuffId >= 3005 and self.BuffId <= 3010) or (self.BuffId >= 4005 and self.BuffId <= 4010) then
            -- 不是百分比加成
        else
            desc = desc.."%"
        end
    end
    return desc
end

local function PlayEffect(self)
    if self.__tec == nil then
        return
    end
    if self.LeftTurn > 0 then
        --print(__log_header(self).."--持续"..self.LeftTurn.."--回合")
    end
    local delayTime = 0
    if self.SrcUnit~=nil and self.FromSkillId~=nil and self.FromSkillId~=0 then
        local sk=self.SrcUnit:GetComponent("SkillComponent").ActiveSkills[self.FromSkillId]
        if sk~=nil then
            if sk.ZSkill.BuffEfxDelay~=nil and sk.ZSkill.BuffEfxDelay~=0 then
                delayTime=sk.ZSkill.BuffEfxDelay
            end
        end
    end
    self.__tec:CoPlayBuff(self.Kind,self.Efx,delayTime)
    if self.EfxSp==nil then return end
    if self.EfxSp[1]==nil then return end
    table.walk(self.EfxSp,function(_,efxsp)
        if efxsp.target~=nil and efxsp.target == self.TargetUnit.ZSsUnit.Id then
            if efxsp.handle==1 then
                self.__tec:CoPlayBuffHandle(self.Kind,efxsp.efx,self.TargetUnit.HandleTrans)
            else
                self.__tec:CoPlayBuffHandle(self.Kind,efxsp.efx,self.TargetUnit.Handle2Trans)
            end
        end
    end)
end

--Buff被添加到一个角色身上时
local function OnOccur(self)
    self.__tsc:OnBuffAdd(self)
    PlayEffect(self)
    self.battle_component:OnBuffAddEvent(self)
end

local function OnMultiply(self, val, Data)
    PlayEffect(self)
    self.NumericVal = self.NumericVal + val

    self.__tsc:OnBuffMultiply(self, val, Data)

    if val > 0 then
        self.battle_component:OnBuffAddEvent(self)
    end
end

--移除Buff时
local function OnRemoved(self)
    self.__tsc:OnBuffRemove(self)
    if self.__tec == nil then
        return
    end
    if self.IsRemoved then return end
    self.IsRemoved = true
    self.__tec:RecycleBuff(self.Kind,self.Efx)
    if self.EfxSp==nil then return end
    if self.EfxSp[1]==nil then return end
    table.walk(self.EfxSp,function(_,efxsp)
        if efxsp.target~=nil and efxsp.target ~=self.TargetUnit.ZSsUnit.Id then return end
        if efxsp.handle==1 then
            self.__tec:RecycleBuffHandle(self.Kind,efxsp.efx,self.TargetUnit.HandleTrans)
        else
            self.__tec:RecycleBuffHandle(self.Kind,efxsp.efx,self.TargetUnit.Handle2Trans)
        end
    end)

    self.battle_component:OnBuffRemoveEvent(self)
end

--当回合开始时
local function OnRoundStart(self)
    
end


--单位回合开始时
local function OnUnitSelfTurnStart(self)

end

--单位回合开始时
local function OnUnitTurnStartEvent(self, unit)
    
end

--当行动开始时
local function OnActStart(self)
    
end

--当攻击开始时
local function OnAtkStart(self)
    
end

local function BeforeHit(self,activeSkillResult)

end

local function BeforeHitEvent(self, activeSkillResult, atkUnit, targetUnit)
end

local function BeforeBeHit(self, activeSkillResult, atkUnit)
    
end

---攻击命中时
local function OnHit(self,activeSkillResult)

end

--受到一段伤害之后
local function AfterHurt(self, activeSkillResult, atkUnit)
    
end

--受到全部伤害之后
local function AfterAllHurt(self, atkUnit, activeSkillResult)
    
end

--受到攻击之后
local function AfterAllHurtByNothing(self, atkUnit, activeSkillResult)
    
end

---受到闪避的全部伤害之后
local function AfterAllHurtByPry(self, atkUnit, activeSkillResult)

end

--- 被技能攻击且结算之后
local function AfterBeHitAll(self, atkUnit, activeSkillResult)
end

--- 技能结算之后
local function AfterOneTargetAllHit(self, targetUnit, activeSkillResult)
end


--当攻击结束时
local function OnAtkEnd(self)

end

--当行动结束时
local function OnActEnd(self)
    
end

local function OnUnitSelfTurnEnd(self)
    self:DecLeftTurn()
end

--单位回合结束时
local function OnUnitTurnEndEvent(self, unit)
    
end

--当回合结束时
local function OnRoundEnd(self)

end

--闪避成功
local function OnPrySuccess(self, activeSkillResult)
    
end

--死亡之前
local function BeforeKilled(self)
    
end

--死亡之后
local function AfterKilled(self)
    
end

local function DecLeftTurn(self, num)
    if self.IsNotTurnBuff or (self.LeftTurn == 0) then
        return
    end
    num = num or 1
    self.LeftTurn = self.LeftTurn - num
    if self.LeftTurn <= 0 then
        self:OnRemoved()
    end    
end

local function IncLeftTurn(self, num)
    if self.IsNotTurnBuff or (self.LeftTurn == 0) then
        return
    end    
    num = num or 1
    self.LeftTurn = self.LeftTurn + num
end

local function HasAnyTag(self, tags)
    return table.any(self.Tags, function(tag) table.contains(tags, tag) end)
end

Buff.__init = __init
Buff.__log_header = __log_header
Buff.GetDesc = GetDesc
Buff.OnOccur = OnOccur 
Buff.OnMultiply = OnMultiply 
Buff.OnRemoved = OnRemoved

Buff.OnRoundStart = OnRoundStart
Buff.OnUnitSelfTurnStart = OnUnitSelfTurnStart
Buff.OnUnitTurnStartEvent = OnUnitTurnStartEvent
Buff.OnActStart = OnActStart
Buff.OnAtkStart = OnAtkStart
Buff.BeforeHit = BeforeHit
Buff.BeforeHitEvent = BeforeHitEvent
Buff.BeforeBeHit = BeforeBeHit
Buff.OnHit = OnHit
Buff.AfterHurt = AfterHurt
Buff.AfterAllHurt = AfterAllHurt
Buff.AfterAllHurtByPry = AfterAllHurtByPry
Buff.AfterBeHitAll = AfterBeHitAll
Buff.AfterOneTargetAllHit = AfterOneTargetAllHit
Buff.OnAtkEnd = OnAtkEnd
Buff.OnActEnd = OnActEnd
Buff.OnUnitSelfTurnEnd = OnUnitSelfTurnEnd
Buff.OnUnitTurnEndEvent = OnUnitTurnEndEvent
Buff.OnRoundEnd = OnRoundEnd 
Buff.AfterAllHurtByNothing = AfterAllHurtByNothing 

Buff.OnPrySuccess = OnPrySuccess
Buff.BeforeKilled = BeforeKilled
Buff.AfterKilled = AfterKilled

Buff.DecLeftTurn = DecLeftTurn
Buff.IncLeftTurn = IncLeftTurn

Buff.HasAnyTag = HasAnyTag

return Buff