---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by daiyi.
--- DateTime: 2019/8/2 18:12
---
local SsUnitVoiceComponent = BaseClass("SsUnitVoiceComponent",Component);
local base = Component

local function doLoad(zs,stype,resPath)
    local soundList= zs[stype]
    if soundList==nil then return end
    if type(soundList) == "string" then
        if not string.IsNullOrEmpty(soundList) then
            ResourcesManager:GetInstance():CoLoadAsync(resPath..soundList..".mp3",typeof(AudioClip))
        end
    else
       table.walk(soundList,function (_,v)
           if not string.IsNullOrEmpty(v) then
               ResourcesManager:GetInstance():CoLoadAsync(resPath..v..".mp3",typeof(AudioClip))
           end
       end)
    end
end

--缓存角色战斗中的音效
local function CoPreLoadVoice(self)
    local zs=Z_CardSound[self.__entity.BattleCharacter.TemplateId]
    if zs==nil then return end
    local resPath="Sound/"..self.__entity.BattleCharacter.TemplateId.."/N/"
    doLoad(zs,SoundType.Attack,resPath)
    doLoad(zs,SoundType.AttackBreak,resPath)
    doLoad(zs,SoundType.Hurt,resPath)
    doLoad(zs,SoundType.HurtSkill,resPath)
    doLoad(zs,SoundType.HurtSpSkill,resPath)
    doLoad(zs,SoundType.Unable,resPath)
    doLoad(zs,SoundType.Relife,resPath)
    doLoad(zs,SoundType.Skill1,resPath)
    doLoad(zs,SoundType.Skill2,resPath)
    doLoad(zs,SoundType.Skill2Fast,resPath)
    doLoad(zs,SoundType.BattleStart,resPath)
end

local function Awake(self)
    base.Awake(self)
    self.audio_source = self.__entity.GameObject:AddComponent(typeof(AudioSource))
    self.audio_source_effect = self.__entity.GameObject:AddComponent(typeof(AudioSource))
    self.battle_component = Game.Scene:GetComponent("BattleComponent")
    self.soundComp=Game.Scene:GetComponent("SoundComponent")
    --CoPreLoadVoice(self)
end

-- 逻辑整理：
-- 1.人声：战斗开始人声，战斗胜利人声，死亡人声，受伤人声，复活人声，普攻人声，技能1人声，技能2人声，技能3（两种人声） ==> 人声都未加速
-- 2.特效声：被动特效声，普攻特效声，技能1特效声，技能2特效声，技能3特效声，帝王风暴特效声，信条特效声  ==> 特效声根据实际速度加速
-- 3.其他：格挡，buff, debuff，闪避，虚弱等等 ==> 未加速

---受伤语音
local function CoPlayHit(self,typeName)
    if typeName==nil then
        self.soundComp:CoPlayBattleVoice(SoundType.HurtSkill,self.__entity.BattleCharacter,self.audio_source)
        return
    end
    if typeName=="Atk" then
        self.soundComp:CoPlayBattleVoice(SoundType.Hurt,self.__entity.BattleCharacter,self.audio_source)
    elseif typeName=="Skl03" then
        self.soundComp:CoPlayBattleVoice(SoundType.HurtSpSkill,self.__entity.BattleCharacter,self.audio_source)
    else
        self.soundComp:CoPlayBattleVoice(SoundType.HurtSkill,self.__entity.BattleCharacter,self.audio_source)
    end
end
---战斗不能
local function CoPlayDead(self)
    self.soundComp:CoPlayBattleVoice(SoundType.Unable,self.__entity.BattleCharacter,self.audio_source)
end
---复活
local function CoPlayReLife(self)
    self.soundComp:CoPlayBattleVoice(SoundType.Relife,self.__entity.BattleCharacter,self.audio_source)
end
local function CoPlayBattleStart(self)
    self.soundComp:CoPlayBattleVoice(SoundType.BattleStart,self.__entity.BattleCharacter,self.audio_source)
end
local function CoPlayBattleWin(self)
    self.soundComp:CoPlayBattleVoice(SoundType.Win,self.__entity.BattleCharacter,self.audio_source)
end
local function CoPlayAtk(self)
    if self.battle_component.BattleSkip then
        return
    end
    self.soundComp:CoPlayBattleVoice(SoundType.Attack,self.__entity.BattleCharacter,self.audio_source)
end
local function CoPlayAtkBreak(self)
    if self.battle_component.BattleSkip then
        return
    end
    self.soundComp:CoPlayBattleVoice(SoundType.AttackBreak,self.__entity.BattleCharacter,self.audio_source)
end
local function CoPlaySkl1(self)
    if self.battle_component.BattleSkip then
        return
    end
    self.soundComp:CoPlayBattleVoice(SoundType.Skill1,self.__entity.BattleCharacter,self.audio_source)
end
local function CoPlaySkl2(self)
    if self.battle_component.BattleSkip then
        return
    end
    self.soundComp:CoPlayBattleVoice(SoundType.Skill2,self.__entity.BattleCharacter,self.audio_source)
end
local function CoPlaySkl3(self)
    if self.battle_component.BattleSkip then
        return
    end
    if self.battle_component.BattleSpeed == BattleSpeedMode.Low then
        self.soundComp:CoPlayBattleVoice(SoundType.Skill2,self.__entity.BattleCharacter,self.audio_source)
    else
        self.soundComp:CoPlayBattleVoice(SoundType.Skill2Fast,self.__entity.BattleCharacter,self.audio_source)
    end
end
-- 扎尔的觉醒用
local function CoPlayByPath(self, path)
    if not self.battle_component.BattleSkip then
        self.soundComp:CoCardPlay(path, self.audio_source)
    end
end
--播放指定的人声
local function CoPlay(self, v_name)
    local resPath="Sound/"..self.__entity.BattleCharacter.TemplateId.."/N/"..v_name..".mp3"
    coroutine.start(function()
        local asset = ResourcesManager:GetInstance():CoLoadAsync(resPath,typeof(AudioClip))
        self.audio_source.clip = asset
        self.audio_source.volume = ClientData:GetInstance():GetVolume("CardVolume")
        self.audio_source:Play()
    end)
end

----------------------------------------------以下是特效声--------------------------------------------------
local function CoPlayPassivityEffect(self)
    if self.battle_component.BattleSkip then
        return
    end
    self.audio_source_effect.pitch = Game.Scene:GetComponent("BattleComponent").BattleSpeed
    self.soundComp:CoPlayCardEffect(SoundType.PassivityEffect, self.__entity.BattleCharacter, self.audio_source_effect)
end

local function CoPlayAtkEffect(self)
    if self.battle_component.BattleSkip then
        return
    end
    self.audio_source_effect.pitch = Game.Scene:GetComponent("BattleComponent").BattleSpeed
    self.soundComp:CoPlayCardEffect(SoundType.AttackEffect, self.__entity.BattleCharacter, self.audio_source_effect)
end

local function CoPlaySkl1Effect(self)
    if self.battle_component.BattleSkip then
        return
    end
    self.audio_source_effect.pitch = Game.Scene:GetComponent("BattleComponent").BattleSpeed
    self.soundComp:CoPlayCardEffect(SoundType.Skill1Effect, self.__entity.BattleCharacter, self.audio_source_effect)
end

local function CoPlaySkl2Effect(self)
    if self.battle_component.BattleSkip then
        return
    end
    self.audio_source_effect.pitch = Game.Scene:GetComponent("BattleComponent").BattleSpeed
    self.soundComp:CoPlayCardEffect(SoundType.Skill2Effect, self.__entity.BattleCharacter, self.audio_source_effect)
end

local function CoPlaySkl3Effect(self)
    if self.battle_component.BattleSkip then
        return
    end
    self.audio_source_effect.pitch = Game.Scene:GetComponent("BattleComponent").BattleSpeed
    self.soundComp:CoPlayCardEffect(SoundType.Skill3Effect, self.__entity.BattleCharacter, self.audio_source_effect)
end

local function CoPlayCutInEffect(self, soundName)
    if self.battle_component.BattleSkip then
        return
    end
    self.audio_source_effect.pitch = Game.Scene:GetComponent("BattleComponent").BattleSpeed
    self.soundComp:CoPlayCardEffect(SoundType.CutInEffect, self.__entity.BattleCharacter, self.audio_source_effect, soundName)
end

local function CoPlayEmperorStorm(self, soundName)
    self.audio_source_effect.pitch = Game.Scene:GetComponent("BattleComponent").BattleSpeed
    self.soundComp:CoPlayEmperorStorm(self.audio_source_effect, soundName)
end

local function SetVoiceSpeed(self, battleSpeed)
    if not IsNull(self.audio_source_effect) and not IsNull(self.audio_source) then
        self.audio_source_effect.pitch = battleSpeed
        self.audio_source.pitch = battleSpeed == BattleSpeedMode.Pause and 0 or 1 -- 人声要么暂停要么1倍速
    end
end

local function VoiceSkip(self)
    if self.audio_source_effect ~= nil and self.audio_source ~= nil then
        self.audio_source_effect:Stop()
        self.audio_source:Stop()
    end
end

local function Dispose(self)
    base.Dispose(self)
end

SsUnitVoiceComponent.Awake = Awake
SsUnitVoiceComponent.CoPlayHit = CoPlayHit
SsUnitVoiceComponent.CoPlayDead = CoPlayDead
SsUnitVoiceComponent.CoPlayReLife= CoPlayReLife
SsUnitVoiceComponent.CoPlayAtk = CoPlayAtk
SsUnitVoiceComponent.CoPlayAtkBreak=CoPlayAtkBreak
SsUnitVoiceComponent.CoPlaySkl1 = CoPlaySkl1
SsUnitVoiceComponent.CoPlaySkl2 = CoPlaySkl2
SsUnitVoiceComponent.CoPlaySkl3 = CoPlaySkl3
SsUnitVoiceComponent.CoPlayPassivityEffect = CoPlayPassivityEffect
SsUnitVoiceComponent.CoPlayAtkEffect = CoPlayAtkEffect
SsUnitVoiceComponent.CoPlaySkl1Effect = CoPlaySkl1Effect
SsUnitVoiceComponent.CoPlaySkl2Effect = CoPlaySkl2Effect
SsUnitVoiceComponent.CoPlaySkl3Effect = CoPlaySkl3Effect
SsUnitVoiceComponent.CoPlayCutInEffect = CoPlayCutInEffect
SsUnitVoiceComponent.Dispose = Dispose
SsUnitVoiceComponent.CoPlayBattleStart=CoPlayBattleStart
SsUnitVoiceComponent.CoPlayBattleWin=CoPlayBattleWin
SsUnitVoiceComponent.CoPreLoadVoice=CoPreLoadVoice
SsUnitVoiceComponent.CoPlay=CoPlay
SsUnitVoiceComponent.SetVoiceSpeed=SetVoiceSpeed 
SsUnitVoiceComponent.VoiceSkip=VoiceSkip
SsUnitVoiceComponent.CoPlayEmperorStorm=CoPlayEmperorStorm 
SsUnitVoiceComponent.CoPlayByPath=CoPlayByPath

return SsUnitVoiceComponent