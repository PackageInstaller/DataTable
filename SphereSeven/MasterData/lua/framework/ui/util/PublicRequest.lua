---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by win 10.
--- DateTime: 2019/4/13 11:52
---
---@class PublicRequest
local PublicRequest = {};
local this = PublicRequest;

function this.SendBuyItemRequest(zStore,num) --发送购买物品的的请求
    
    local player = Game.Scene.Player;
    local shopComponent = player:GetComponent("ShopComponent");
    local send_data = {};
    send_data.StoreTemplateId = zStore.Id;
    send_data.Num = num
    if zStore.PriceType == 2 then
        if UIUtil.GetPlayerCurrency(zStore.PriceType) + UIUtil.GetPlayerCurrency(1) < zStore.TotalPrice * num then
            --UIUtil.ToolTipFourth(UIUtil.currencyType[zStore.PriceType]..LangUtil.GetSysLang(1066));
            return;
        end
    else
        if UIUtil.GetPlayerCurrency(zStore.PriceType)  < zStore.TotalPrice * num then
            --UIUtil.ToolTipFourth(UIUtil.currencyType[zStore.PriceType]..LangUtil.GetSysLang(1066));
            return;
        end
    end
    coroutine.start(function()
        local g2cStorePurchase = coroutine.yieldstart(Game.Scene.Session.CoCall, nil,  Game.Scene.Session,
                OuterOpcode.Name2Code.ETModel_C2M_StorePurchase, send_data)
        if g2cStorePurchase.Error == ErrorCode.ERR_Success then
            local final_num = UIUtil.GetPlayerCurrency(zStore.PriceType) - zStore.TotalPrice * num;
            if zStore.PriceType == 2 then
                if  UIUtil.GetPlayerCurrency(2) - zStore.TotalPrice * num >=0 then
                    UIUtil.SetPlayerCurrency(2,final_num);
                elseif UIUtil.GetPlayerCurrency(2) - zStore.TotalPrice * num < 0  then
                    local P_num = UIUtil.GetPlayerCurrency(1) - (zStore.TotalPrice * num - UIUtil.GetPlayerCurrency(2))
                    UIUtil.SetPlayerCurrency(2,0);
                    UIUtil.SetPlayerCurrency(1,P_num);
                end
            else
                UIUtil.SetPlayerCurrency(zStore.PriceType,final_num);
            end
            
            if zStore.QuotaPeriod ~= 0 then
                shopComponent:ChangeDetail(zStore.Id,num);
            end
            
            Game.Scene.Player:GetComponent("ItemComponent"):SendPurchaseUseRequest()
            if g2cStorePurchase.ItemBean ~= nil then
                UIPublic.AddItem(g2cStorePurchase.ItemBean);
                DataManager:GetInstance():Broadcast(DataMessageNames.ON_ITEM_INFO_CHG);
                --local func = function()
                    local infos = {}
                    table.insert(infos,{rewardType = RewardType.Item,
                                        templateId = g2cStorePurchase.ItemBean.TemplateId, num = g2cStorePurchase.ItemBean.Amount})
                    local info = {rewards = infos, title = LangUtil.GetSysLang(1081)}
                    UIManager:GetInstance():OpenWindow(UIWindowNames.UIReward, info)
                --end
                UIUtil.ToolTipFourth(LangUtil.GetSysLang(1081)) --购买成功
            end

            local recordIds = {}
            if g2cStorePurchase.CardBeans ~= nil and table.count(g2cStorePurchase.CardBeans) ~= 0 then
                for k,v in pairs(g2cStorePurchase.CardBeans) do
                    table.insert(recordIds,v.TemplateId)
                    local card = Game.Registry:NewObject("Card",v)
                    card:InitCardComponent()
                    player:GetComponent("CardComponent"):Add(card,true)
                    local infoC = {resultList = { {card = card} },newCardList = { card },newFightSoulList = { },type = 1}
                    DataManager:GetInstance():Broadcast(DataMessageNames.ON_SUMMON_INFO_CHG,infoC)
                    UIManager:GetInstance():OpenWindow(UIWindowNames.UISummonStage1,infoC)
                end
            end

            if g2cStorePurchase.EquipBeans ~= nil and table.count(g2cStorePurchase.EquipBeans) ~= 0 then
                local equipIds = {}
                local infos = {}
                for k,v in pairs(g2cStorePurchase.EquipBeans) do
                    local equip = Game.Registry:NewObject("Equip",v)
                    table.insert(equipIds,v.TemplateId)
                    equip:AddComponent("EquipAttrComponent");
                    player:GetComponent("EquipComponent"):Add(equip);
                    table.insert(infos,{rewardType = RewardType.Equip,
                                        templateId = equip.TemplateId, num = 1})
                end
                local info = {rewards = infos, title = LangUtil.GetSysLang(1081)}--购买成功
                UIManager:GetInstance():OpenWindow(UIWindowNames.UIReward, info)
                DataManager:GetInstance():Broadcast(DataMessageNames.ON_EQUIP_INFO_CHG);
            end
        else
            UIUtil.ToolTipFourth(LangUtil.GetServerError(g2cStorePurchase.Error))
        end
    end)
end

function this.SendChangeEquipRequest(data,callBack)

    local tempData = {};
    for k,v in pairs(data) do
        if tempData[v.CardId] == nil then
            tempData[v.CardId] = v;
        else
            if v.Hand1Equip == 0 then tempData[v.CardId].Hand1Equip = 0 end
            if v.Hand2Equip == 0 then tempData[v.CardId].Hand2Equip = 0 end
            if v.BodyEquip == 0 then tempData[v.CardId].BodyEquip = 0 end
            if v.HeadEquip == 0 then tempData[v.CardId].HeadEquip = 0 end
            if v.FootEquip == 0 then tempData[v.CardId].FootEquip = 0 end
            if v.AdornEquip == 0 then tempData[v.CardId].AdornEquip = 0 end

        end
    end
    data = {};
    for k,v in pairs(tempData) do
        table.insert(data,v);
    end
    
    
    coroutine.start(function()
        local count = 0;
        for i = 1,#data do
            local g2cCardEquipChange = coroutine.yieldstart(Game.Scene.Session.CoCall, nil,  Game.Scene.Session,
                    OuterOpcode.Name2Code.ETModel_C2M_CardEquipChange, data[i]);
            if g2cCardEquipChange.Error == ErrorCode.ERR_Success then
                count = count + 1;
                local newEquipIdTab = {[1] = data[i].Hand1Equip,[2] = data[i].Hand2Equip,[3] =data[i].BodyEquip,[4] =data[i].HeadEquip,[5] =data[i].FootEquip,[6] =data[i].AdornEquip};
                UIPublic.ReFreshEquip(data[i].CardId,newEquipIdTab)
                local info = {cardInfoChgType = CardInfoChgType.Equip,
                              cardId = data[i].CardId
                }
                DataManager:GetInstance():Broadcast(DataMessageNames.ON_CARD_INFO_CHG,info)
            end
            if count == #data then
                if callBack ~= nil then
                    callBack()
                end
                DataManager:GetInstance():Broadcast(DataMessageNames.ON_EQUIP_INFO_CHG)
            end
        end
    end)
end

function this.SendChangeFightSoulRequest(data,callBack)
    coroutine.start(function()
        local count = 0;
        for i = 1,#data do
            local g2cCardFightSoulChange = coroutine.yieldstart(Game.Scene.Session.CoCall, nil,  Game.Scene.Session,
                    OuterOpcode.Name2Code.ETModel_C2M_CardFightSoulChange, data[i]);
            if g2cCardFightSoulChange.Error == ErrorCode.ERR_Success then
                count = count + 1;
                local newEquipIdTab = {[1] = data[i].FightSoul1,[2] = data[i].FightSoul2,[3] =data[i].FightSoul3};
                UIPublic.ReFreshFightSoul(data[i].CardId,newEquipIdTab)
                local info = {cardInfoChgType = CardInfoChgType.FightSoul,
                              cardId = data[i].CardId
                }
                DataManager:GetInstance():Broadcast(DataMessageNames.ON_CARD_INFO_CHG,info)
            end
            if count == #data then
                if callBack ~= nil then
                    callBack();
                end
                DataManager:GetInstance():Broadcast(DataMessageNames.ON_FIGHTSOUL_INFO_CHG)
            end
        end
    end)
end

function this.SendGetCurrencyRequest(data,callBack)
    local str="52GM 1000 "..data.CurrencyTypeVal.." "..data.CurrencyCount
    GMUtil.Send(str,callBack)
end

function this.SendLockRequest(card) --角色锁定解锁请求
    local send_data = {};
    local lock = (card.Lock == 1 and {2} or {1})[1]
    send_data.CardId = card.Id;
    send_data.Lock = lock;
    coroutine.start(function()
        local g2cCardLock = coroutine.yieldstart(Game.Scene.Session.CoCall, nil,  Game.Scene.Session,
                OuterOpcode.Name2Code.ETModel_C2M_CardLock, send_data);
        if g2cCardLock.Error == ErrorCode.ERR_Success then
            
            card.Lock = lock;
            local info = {cardInfoChgType = CardInfoChgType.Lock,
                          cardId = data[i].CardId
            }
            DataManager:GetInstance():Broadcast(DataMessageNames.ON_CARD_INFO_CHG,info)
            local str = (card.Lock == 1 and {"Lock"} or {"UnLock"})[1]
            UIUtil.ToolTipFourth(str);
        end
    end)
end


function this.SendOpenBattleModeRequest(expendStarStone,isItem,diff,day)
    local player = Game.Scene.Player
    local reqData = {}
    reqData.ExpendPaidStarStone = 0
    reqData.ExpendFreeStarStone = 0
    reqData.ExpendMaterialList = {}
    reqData.SevenStarDay = day
    reqData.SevenStarDif = diff
    if isItem then --使用物品
        local Material = {}
        Material.MaterialId = table.first(player:GetComponent("ItemComponent").Items,function(v) return v.TemplateId == 3014  end).Id
        Material.Amount = 1
        Material.MaterialType = 0
        table.insert(reqData.ExpendMaterialList,Material)
    else --使用星石
        local surplusStarStone = player.FreeStarStone - expendStarStone
        if surplusStarStone < 0 then
            reqData.ExpendPaidStarStone = -surplusStarStone
            reqData.ExpendFreeStarStone = player.FreeStarStone
        else
            reqData.ExpendPaidStarStone = 0
            reqData.ExpendFreeStarStone = expendStarStone
        end

        if player.PaidStarStone < reqData.ExpendPaidStarStone then
            local tipData = {}
            tipData.title = LangUtil.GetSysLang(9)--"提示"
            tipData.message = LangUtil.GetSysLang(546)--"星石不足,是否前往充值"
            tipData.callBack = function()
                UIUtil.ToolTipFourth(LangUtil.GetSysLang(541))
            end
            UIUtil.ToolTipFirst(tipData)
            return
        end
    end
    coroutine.start(function()
        local response =coroutine.yieldstart(Game.Scene.Session.CoCall,nil,Game.Scene.Session,
                OuterOpcode.Name2Code.ETModel_C2M_SevenStarAddNum,reqData)
        if response.Error == ErrorCode.ERR_Success then
            player.FreeStarStone = player.FreeStarStone - reqData.ExpendFreeStarStone
            player.PaidStarStone = player.PaidStarStone - reqData.ExpendPaidStarStone
            player:GetComponent("SevenStarComponent").Days[day]["Diff"..diff.."Num"] = response.SevenStarNum
            for k ,v in pairs(reqData.ExpendMaterialList) do
                UIUtil.RemoveItem(v.MaterialId,v.Amount)
            end
            DataManager:GetInstance():Broadcast(DataMessageNames.ON_SEVEN_STAR_COUNT_CHG)
            DataManager:GetInstance():Broadcast(DataMessageNames.ON_PLAYER_INFO_CHG)
        end
    end)
end


function this.SendRequest(proto, msg, callBack, errorCallBack)
	coroutine.start(function()
        local response, errorCode = coroutine.yieldstart(Game.Scene.Session.CoCall, nil, Game.Scene.Session,
			proto, msg)
        if errorCode ~= 0 and errorCode ~= nil and errorCallBack ~= nil then
            errorCallBack(errorCode)
            return
        end
		if callBack ~= nil then
			callBack(response, errorCode)
		end
    end)
end

return this
    
    