---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by daiyi.
--- DateTime: 2019/4/11 14:29
---
---@class CardComponent
---@field Cards Card[]
local CardComponent = BaseClass("CardComponent", Component)
local base = Component

---@param self CardComponent
local function Awake(self)
    base.Awake(self)
    self.Cards = {}
    self.ZCardSkins = {}
    self.UnLockSkinList = {}

    ---@type HintComponent
    local hintComponent = Game.Scene:GetComponent("HintComponent")
    self.cardHint = hintComponent.Card
    self.cardHint:SetCount(0)
    self.cardHint:AddChild("Cards")
    self.cardHint:AddChild("Intens")
end

---@param self CardComponent
---@param card Card
local function Add(self,card,isHint,noRecord)
    -- if card.Star == 0 or card.Star == nil  or card.Level == 0 or card.Level == nil then
    --    return
    -- end
    self.Cards[card.Id] = card
    if not noRecord then
        self:InitZCardsSkins()
    else

    end

    if self.cardHint:GetChild("Cards"):GetChild(card.Id) == nil then
        self.cardHint:GetChild("Cards"):AddChild(card.Id, 1, true)
    end

    DataManager:GetInstance():Broadcast(DataMessageNames.ON_CARD_INFO_CHG,
            {
                cardInfoChgType = CardInfoChgType.Add,
                cardId = card.Id
            }
    )
end

local function AddSkin(self,skinId)
    self.UnLockSkinList[skinId] = Z_Skin[skinId]
end

local function Get(self,cardId)
    return self.Cards[cardId]
end

local function Remove(self,cardId)
    self.Cards[cardId] = nil;
end

local function GetStageByStar(self,star)
    
    if star <= 2 then
        return 1
    elseif star <= 4 then
        return 2
    elseif star == 5 then
        return 3
    end
end

local function GetZCardMaxStar(self,cardId)
    local star = 1
    for k,v in pairs(self.Cards) do
        if v.Star > star then
            star = v.Star
        end
        if star == 5 then
            break
        end
    end
    
    return star
end


local function GetZCardSkin(self,zCard)
    local skins = Game.Scene.Player:GetComponent("SkinComponent").Skins
    local t = {}
    local maxStage = 0
    local cards = table.choose(self.Cards,function(k,v ) return v.TemplateId == zCard.Id  end)

    if table.count(cards) > 0 then
        for k,v in pairs(cards) do
            local stage = v.Star
            if stage > maxStage then
                maxStage = stage
                if maxStage == 3 then
                    break
                end
            end
        end
    end

    for i = 1,maxStage do
        table.insert(t,i)
    end

    for i = 4,6 do
        local zSkin = UIPublic.GetSkin(zCard.Id, i)
        --local zSkin = Z_Skin[zCard.Id *100 + i]
        if zSkin ~= nil then
            if table.first(skins,function(v)  return v.TemplateId == zSkin.Id end) then
                if not table.first(t,function(v) return v == i  end) then
                    table.insert(t,i)
                end
            end
        end
    end

    return t

end

local function InitZCardsSkins(self) --初始化已解锁的皮肤
    self.ZCardSkins = {}
    for _,zCard in table.pairsByKeys(Z_Card) do
        if zCard.IsMonster == 0 and zCard.SsUnitId ~= 0 then
            self.ZCardSkins[zCard.Id] = GetZCardSkin(self,zCard)
        end
    end
    
end

local function GetZCardSkins(self,templateId) --获取该角色已解锁的皮肤
    self.ZCardSkins[templateId] = GetZCardSkin(self,Z_Card[templateId])
    return self.ZCardSkins[templateId]
end

local function Dispose(self)
    base.Dispose(self)
    for _,v in pairs(self.Cards) do
        v:Dispose()
    end
end
--从一个Id创建一个单位
local function CreatUnitByTemplateId(self,templateId,isBattle,figureAssetId)
    local modelName = Z_FigureAsset[figureAssetId].SsUnitName
    
    local zCard = Z_Card[templateId];
    local zSsUnit = Z_SsUnit:GetConfig(zCard.SsUnitId) -- 单位的配置文件
    local isNewBattleSpine = Z_FigureAsset[figureAssetId].IsNewBattleSpine

    local path
    local unitName -- 单位的名字：旧资源会有前面编号  新资源没有编号
    if isNewBattleSpine == 1 then
        unitName = modelName
        path = zSsUnit.AbDir.."/"..unitName.."/BattleSpine/"..unitName..".prefab"
    else
        if zSsUnit.NewRes == 1 then
            local unitSplits = string.split(zSsUnit.AbDir, "_")
            unitName = modelName--unitSplits[#unitSplits]..stage
            path = zSsUnit.AbDir.."/"..unitName.."/Model/"..unitName..".prefab"
        else
            local unitSplits = string.split(zSsUnit.AbDir, "/")
            unitName = unitSplits[#unitSplits]
            path = zSsUnit.AbDir.."/Model/"..unitName..".prefab"
        end
    end
    
    local go = GameObjectPool:GetInstance():CoGetGameObjectAsync(path)
    local animator = go:GetComponent(typeof(CS.UnityEngine.Animator))
    if animator == nil then return end
    if animator.runtimeAnimatorController == nil then
        local resPath
        if isBattle then
            if zSsUnit.NewRes == 1 then
                resPath = zSsUnit.AbDir.."/"..unitName.."/Battle/"..unitName..".controller"
            elseif isNewBattleSpine == 1 then
                resPath = zSsUnit.AbDir.."/"..unitName.."/BattleSpine/"..unitName..".controller"
            else
                resPath = zSsUnit.AbDir.. "/Battle/SsUnitAnimator"..".controller"
            end
        else
            if zSsUnit.NewRes == 1 then
                resPath = zSsUnit.AbDir.."/"..unitName.."/UI/"..unitName..".controller"
            elseif isNewBattleSpine == 1 then
                resPath = zSsUnit.AbDir.."/"..unitName.."/BattleSpine/"..unitName..".controller"
            else
                resPath = zSsUnit.AbDir.."/UI/AnimatorController"..".controller"
            end
        end
        local asset = ResourcesManager:GetInstance():CoLoadAsync(resPath,typeof(RuntimeAnimatorController))
        animator.runtimeAnimatorController=asset
    end
    return go
end
--从一个card的数据创建一个单位
local function CreatUnitByCard(self,card,isBattle)
    local figureAssetId
    if card.IsMonster then
        figureAssetId = card.Config.CardId
    else
        figureAssetId = card.SkinId
    end
    return self:CreatUnitByTemplateId(card.TemplateId,isBattle,figureAssetId)
end

local function GetAllCardKindCount(self)
    return table.count(table.choose(Z_Character,function(k,v) return v.Enable == 1 end))
end

CardComponent.Awake = Awake
CardComponent.Add = Add
CardComponent.AddSkin = AddSkin
CardComponent.Get = Get
CardComponent.Remove = Remove
CardComponent.GetStageByStar = GetStageByStar
CardComponent.Dispose = Dispose
CardComponent.CreatUnitByCard=CreatUnitByCard
CardComponent.CreatUnitByTemplateId=CreatUnitByTemplateId
CardComponent.InitZCardsSkins=InitZCardsSkins
CardComponent.GetZCardSkins = GetZCardSkins
CardComponent.GetZCardMaxStar = GetZCardMaxStar
CardComponent.GetAllCardKindCount = GetAllCardKindCount
return CardComponent