---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by win 10.
--- DateTime: 2019/7/11 9:54
--- 自宅功能

local PostBoxComponent = BaseClass("PostBoxComponent", Component)
local base = Component
local this = PostBoxComponent

this.announcementData = {}

function this.Awake(self)
    base.Awake(self)
    self.Posts = {}
    ---@type HintComponent
    local hintComponent = Game.Scene:GetComponent("HintComponent")
    self.PostHint = hintComponent.Post
    self.PostHint:SetCount(0)
    self.SkinIds = {}--邮箱里面的皮肤，避免皮肤重复购买
    this.AddAnnouncementdata()
end

function this.Add(self,Post)
    --table.insert(self.Posts, Post)
    -- if UIUtil.CheakRewardInfo(Post.RewardInfoList) then
    --     if Post.State == 0 then
    --         self.PostHint:AddCount(1)
    --         --elseif Post.State == 1 then
    --         --    if table.count(Post.RewardInfoList) > 0 then
    --         --        self.PostHint:AddCount(1)
    --         --    end
    --     end
    --     for _, v in pairs(Post.RewardInfoList) do
    --         if v.RewardTypeInfo == "Skin" then
    --             table.insert(self.SkinIds, {Id = v.TemplateId, Time = Post.Time})
    --         end
    --     end
    --     self.Posts[Post.MailId] = Post
    -- else
    --     coroutine.start(function()
    --         coroutine.waitforseconds(3)
    --         coroutine.yieldstart(Game.Scene.Session.CoCall,nil,Game.Scene.Session,
    --                 OuterOpcode.Name2Code.ETModel_C2M_OperationMail, {MailId = Post.MailId,Type = 2})
    --     end)
    -- end
end

function this.AddAnnouncementdata()
    local client_data = ClientData:GetInstance()
    local announcementUrl = client_data.feixiao_announcement_url--"http://152.32.190.152:18180/notice/query"
    
    if announcementUrl == nil then
        return
    end
    print("announcementUrl = "..announcementUrl)

    local requestPost = CS.HttpPost(announcementUrl, function(httpRequest)

    if not httpRequest.Success or httpRequest.Success == nil then
        return
    end

    if httpRequest.Text == nil then
        return
    end

    local urlData = cjson.decode(string.sub(httpRequest.Text, 1, -1) )
    if urlData == nil then
        return
    end
    this.announcementData = urlData.notices
        
   end, "{}"):Send()
end

function this.InitPost(self, MailInfoList)
    self.PostHint:RemoveAllChildren()
    self.SkinIds = {}
    for _,v in pairs(MailInfoList) do
        --self:Add(Game.Registry:NewObject("Post",v))
        self.Posts[v.mid] = v
        local hintCount = 0
        if v.status == MailStatus.MailStatusUnread or v.status == MailStatus.MailStatusReadNotReceived then
            hintCount = 1
        end
        self.PostHint:AddChild(v.mid, hintCount)
    end
end

function this.Remove(self,Id)
    self.Posts[Id] = nil
end


function this.Dispose(self)
    base.Dispose(self)
end


return this