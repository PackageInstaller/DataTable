---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by wwj.
--- DateTime: 2021/3/23 15:03
---
local TestInterface = BaseClass("TestInterface", Component)
local base = Component
local this = TestInterface

function this.Awake(self)
    base.Awake(self)
    self.TextInfos={}
    self.loginKey={}
end


function this.EnterGame(self)
    for i, v in pairs(self.loginKey) do
        coroutine.start(function ()
            self:CoConnect2("wenweijun"..i,v)--账号

        end)
    end
end
function this.login(self)
    for i = 1, 300 do  --登入最大同时可以接受消息678

            coroutine.start(function ()
                --if i<=679 then
                    self:CoConnect("wenweijun"..i)--账号
                    --self:Register("wenweijun"..i)
                --end
            end)  


    end
    
    
end
function this.login2(self)
    --for i = 301, 394 do  --游戏服同时接受消息上次最大 +8
    --        coroutine.start(function ()
    --                self:CoConnect("wenweijun"..i)--账号
    --                --self:Register("wenweijun"..i)
    --
    --        end)
    --end

end



function this.Register(self,uid)
    self.IsDisConnect = false
    local isTimeOut = false
    local tmpSession = Game.Scene:OpenSession(RealmConfig.Address)
    coroutine.start(function ()
        coroutine.waitforseconds(5)
        isTimeOut = true
    end)
    coroutine.waituntil(function ()
        return isTimeOut or self.IsDisConnect or tmpSession:IsConnected()
    end)
    if isTimeOut or self.IsDisConnect then return false end
    local r2CRegister = coroutine.yieldstart(tmpSession.CoCall,nil,tmpSession,
            OuterOpcode.Name2Code.ETModel_C2R_Register,{
                Username = uid,
                Password = "123456"
            })
    if(r2CRegister.Error ~= ErrorCode.ERR_Success) then
        Logger.Log(LangUtil.GetSysLang(9),r2CRegister.Message);--换弹框或提示框
        Logger.LogError("--注册失败"..uid)
        tmpSession:Dispose()
        return
    end
    Logger.LogError("--注册成功"..uid)
end


function this.CoConnect(self,uid)
    self.IsDisConnect = false
    local tmpSession = Game.Scene:OpenSession(RealmConfig.Address)
    local isTimeOut = false
    coroutine.start(function ()
        coroutine.waitforseconds(5)
        isTimeOut = true
    end)
    coroutine.waituntil(function ()
        return isTimeOut or self.IsDisConnect or tmpSession:IsConnected()
    end)
    if isTimeOut or self.IsDisConnect then return false end
    local r2CLogin = coroutine.yieldstart(tmpSession.CoCall,nil,tmpSession,
            OuterOpcode.Name2Code.ETModel_C2R_Login,{
                Username = uid,
                Password = "123456"
            })
    if (r2CLogin.Error == ErrorCode.ERR_LoginError) then
        UIUtil.ToolTipThird(LangUtil.GetSysLang(9), LangUtil.GetServerError(r2CLogin.Error))--"登录失败,账号或密码错误")
        tmpSession:Dispose()
        return false
    elseif(r2CLogin.Error ~= ErrorCode.ERR_Success) then
        UIUtil.ToolTipThird(LangUtil.GetSysLang(9), LangUtil.GetServerError(r2CLogin.Error))
        tmpSession:Dispose()
        return false
    end
    table.insert(self.loginKey,r2CLogin.Key);
    tmpSession:Dispose()
    --local r2CServers = coroutine.yieldstart(tmpSession.CoCall,nil,tmpSession,
    --        OuterOpcode.Name2Code.ETModel_C2R_Servers,{
    --            Key = r2CLogin.Key;
    --        })
    --if r2CServers.Error ~= ErrorCode.ERR_Success then
    --    UIUtil.ToolTipThird(LangUtil.GetSysLang(9),r2CServers.Message)
    --    tmpSession:Dispose()
    --    return false
    --end
    --DataManager:GetInstance():Broadcast(DataMessageNames.ON_LOGIN_ACCOUNT_SERVER_SUCCEED,r2CServers);
end

function this.Write(self,t)
    file = io.open("D:\\SevenSphere1\\Test.txt","a")
    io.output(file)
    --io.output("D:\SevenSphere1\test.lua")
    io.write(t,",\n")
    --io.write(cjson.encode(t))
    io.close(file)
end

 function this.Read(self,info)
    file = io.open("D:\\SevenSphere1\\Test.txt","r")
    io.input(file)
    --io.output("D:\SevenSphere1\test.lua")
    local t =  io.read("*all")
    io.close(file)
    local readInfo = cjson.decode(t)
    
     for i, v in pairs(readInfo) do
         if v.Nickname ==  info.Nickname then
             if v.Level==info.Level and
                     v.AccountId == info.AccountId and
                     v.GoldCoin==info.GoldCoin and
                     v.PaidStarStone==info.PaidStarStone and
                     v.FreeStarStone==info.FreeStarStone and
                     v.StarLightGem==info.StarLightGem and
                     v.StarSand==info.StarSand and
                     v.MagicCrystal==info.MagicCrystal and
                     v.EmperorStarPoint==info.EmperorStarPoint  then
                 Logger.LogError("--!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!匹配成功")
             else
                 Logger.LogError("--!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!匹配失败")
             end
         end
     end
     
end

function this.CoConnect2(self, uid, loginKey)
    self.IsDisConnect = false
    --local tmpSession = Game.Scene:OpenSession("121.196.125.246:10003")
    local tmpSession = Game.Scene:OpenSession("192.168.1.109:10003")
    local isTimeOut = false
    coroutine.start(function ()
        coroutine.waitforseconds(5)
        isTimeOut = true
    end)
    coroutine.waituntil(function ()
        return isTimeOut or self.IsDisConnect or tmpSession:IsConnected()
    end)
    
    if isTimeOut or self.IsDisConnect then return false end
    --超时断线直接退出
    if isTimeOut or self.IsDisConnect then return false end
    local g2CLoginGate =coroutine.yieldstart(tmpSession.CoCall,nil,tmpSession,
            OuterOpcode.Name2Code.ETModel_C2G_LoginGate, {
                Key = loginKey;
            })
    if (g2CLoginGate.Error ~= ErrorCode.ERR_Success)then
        Logger.LogError("--请重新登陆"..uid)
        --UIUtil.ToolTipThird(LangUtil.GetSysLang(9),g2CLoginGate.Message.." ,"..LangUtil.GetSysLang(1008))--请重新登陆")
        tmpSession:Dispose()
        return false
    end
    --tmpSession:AddComponent("HeartBeatComponent")
   
    --if Game.Scene.Player ~= nil then
    --    Game.Scene.Player:Dispose()
    --end
    local g2CPlayerInfo = coroutine.yieldstart(tmpSession.CoCall,nil,tmpSession,
            OuterOpcode.Name2Code.ETModel_C2M_PlayerInfo, {})
    local player = Game.Registry:NewObject("Player",g2CPlayerInfo.PlayerInfo)
    local PlayerInfo = {}
    PlayerInfo.Nickname=g2CPlayerInfo.PlayerInfo.Nickname
    PlayerInfo.Level=g2CPlayerInfo.PlayerInfo.Level
    PlayerInfo.AccountId = g2CPlayerInfo.PlayerInfo.AccountId
    PlayerInfo.GoldCoin=g2CPlayerInfo.PlayerInfo.GoldCoin
    PlayerInfo.PaidStarStone=g2CPlayerInfo.PlayerInfo.PaidStarStone
    PlayerInfo.FreeStarStone=g2CPlayerInfo.PlayerInfo.FreeStarStone
    PlayerInfo.StarLightGem=g2CPlayerInfo.PlayerInfo.StarLightGem
    PlayerInfo.StarSand=g2CPlayerInfo.PlayerInfo.StarSand
    PlayerInfo.MagicCrystal=g2CPlayerInfo.PlayerInfo.MagicCrystal
    PlayerInfo.EmperorStarPoint=g2CPlayerInfo.PlayerInfo.EmperorStarPoint
    self:Write(cjson.encode(PlayerInfo) )
    local TextInfo = {["session"] = tmpSession,["player"] = player  }
    print("--添加的帐号昵称："..player.Nickname)
    
    table.insert(self.TextInfos,TextInfo)
    return true
end

return this