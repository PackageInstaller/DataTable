---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by win 10.
--- DateTime: 2019/7/11 9:54
--- 公告功能

local AfficheComponent = BaseClass("AfficheComponent", Component)
local base = Component
local this = AfficheComponent
local GetAfficheTime = -1000


function this.CoLoadData(self)
    --获取公告接口
    if Time.time - GetAfficheTime > 30 then
        GetAfficheTime = Time.time
        local rr = coroutine.yieldstart(Game.Scene.Session.CoCall, nil, Game.Scene.Session,
                OuterOpcode.Name2Code.ETModel_C2M_GetAffiche, { Num = 0 })--0所有公告不然就是获取的条数
        if rr.Error == ErrorCode.ERR_Success then
            for k, v in pairs(rr.AfficheList) do
                if not table.any(self.Affiches, function(h) return h.Id == v.Id end) then
                    self:Add(v)
                end
            end

            for i = table.count(self.Affiches), 1, -1 do--移除，删除的公告
                if not table.any(rr.AfficheList, function(h) return h.Id == self.Affiches[i].Id end) then
                    table.remove(self.Affiches, i)
                end
            end
            self:InformHintCount()
        else
            Logger.LogError("ETModel_C2M_StoreRestrict:" .. rr.Message)
        end
        --rr.AfficheList   公告列表
        --Title  标题
        --Subtitle 副标题
        --Content   内容
        --Date   日期
        --RedPoint 红点提示
        --Index 排序大小
    end
    return coroutine.yieldbreak(true)
end

function this.Awake(self)
    base.Awake(self)
    self.Affiches = {}
    self.Inform = Game.Scene:GetComponent("HintComponent").Inform
end

function this.Add(self, AfficheInfo)
    local affiche = Game.Registry:NewObject("Affiche", AfficheInfo)
    table.insert(self.Affiches, affiche)
    table.sort(self.Affiches, function(a, b)
        if a.Index == b.Index then
            return a.Date > b.Date
        else
            return a.Index > b.Index 
        end  
    end)
end

function this.CheckAfficheList(self, affiche)
    for i = table.count(self.Affiches), 1, -1 do--移除标题 副标题一致的
        if affiche.Title == self.Affiches[i].Title and affiche.Subtitle == self.Affiches[i].Subtitle then
            table.remove(self.Affiches, i)
            break
        end
    end
end

function this.InformHintCount(self)
    local informList = ClientData:GetInstance():GetInformState()
    local count = 0
    for _, v in pairs(self.Affiches) do
        if not table.any(informList, function(f) return f == v.Id  end)  and v.RedPoint == true then
            count = count + 1
        end
    end
    if self.Inform.Count ~= count then
        self.Inform:SetCount(count)
    end
    ClientData:GetInstance():SetInformState(nil, self.Affiches)
end

function this.Dispose(self)
    base.Dispose(self)
    GetAfficheTime = 0
end




return this