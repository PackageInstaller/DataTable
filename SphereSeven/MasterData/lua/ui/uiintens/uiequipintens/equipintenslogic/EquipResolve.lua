---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by win 10.
--- DateTime: 2019/4/18 11:30
---

local EquipResolve = {};
local this= EquipResolve;
local pfbName = "EquipItemNew"
local recordOrder = {order = 1,kind = 1}  --是否正序  顺序类型
local screenTypes = {star = 0,Part = 0,exclusive = 0,isEquip = 0}



local function InitNumTxt(self)
    self.rs_starSandNumTxt.text = UIUtil.ScientificCount(self.rs_sand)
    self.rs_goldNumTxt.text = UIUtil.ScientificCount(self.rs_gold)
    self.choseValue.text = table.count(self.rs_IdList).."/"..30
end

local function CountGetNum(self,id,isAdd)
    local equip = self.equips[id]
    local zEquip = Z_Equip[equip.TemplateId]
    local isEquipType = (zEquip.Exclusive ~=0 and {2} or {1})[1]
    local star = (zEquip.Exclusive ~=0 and {equip.Star} or {zEquip.Star})[1] 

    local zEquipDecompose = table.first(Z_EquipDecompose,function(v)
        return v.EquipType == isEquipType and v.Star == star
    end)

    if isAdd then
        self.rs_gold = self.rs_gold + zEquipDecompose.GoldCoinPer
        self.rs_sand = self.rs_sand + zEquipDecompose.StarSandPer
    else
        self.rs_gold = self.rs_gold - zEquipDecompose.GoldCoinPer
        self.rs_sand = self.rs_sand - zEquipDecompose.StarSandPer
    end

    InitNumTxt(self)
end

local function RemoveEquip(self,id)
    table.removebyvalue(self.rs_IdList,id)
    CountGetNum(self,id,false)
end

local function AddEquip(self,id)
    if table.any(self.rs_IdList,function(v) return v == id  end) then
        RemoveEquip(self,id)
        return 
    end
    if table.count(self.rs_IdList) >= 30 then
        UIUtil.ToolTipFourth(LangUtil.GetSysLang(2030))
        return
    end
    table.insert(self.rs_IdList,id)
    CountGetNum(self,id,true)
end


local function OnResolveButton(self)
    if table.count(self.rs_IdList) == 0 then return end
        local reqData = {}
        reqData.AcquireStarSand = self.rs_sand
        reqData.AcquireGoldCoin = self.rs_gold
        reqData.EquipId = {}
        for k,v in pairs(self.rs_IdList) do
            table.insert(reqData.EquipId,v)
        end

        if table.count(reqData.EquipId) == 0 then
            return
        end
    local tipData = {}
    tipData.title = LangUtil.GetSysLang(9)--"提示"
    tipData.message = LangUtil.GetSysLang(788)
    tipData.callBack = function()
        self.ctrl:SendResolveRequest(reqData);
    end
    UIUtil.ToolTipFirst(tipData)
end



local function OnEquipItem(self,id)
    
    local equip = self.equips[id]
    if UIPublic.GetEquipHolder(equip) ~= nil then
        UIUtil.ToolTipFourth(LangUtil.GetSysLang(1078))--"该装备已被穿戴"
        return
    end

    if equip.Lock == 1 then
        UIUtil.ToolTipFourth(LangUtil.GetSysLang(1035));--"装备已被锁定"
        return
    end
    AddEquip(self,id)
    this.InitButton(self)
end



local function OnScreenButton(self)
    local uiData = {}
    uiData.recordOrder = recordOrder
    uiData.screenTypes = screenTypes
    uiData.callBack = function(list,kind)
        screenTypes = table.clone(list)
        recordOrder.kind = kind
        this.InitEquipListData(self)
        --self.rs_scrollView.verticalScrollbar.value = 1
        --this.InitEquipList(self)
        self.vs_scroll:MoveTop()
    end
    UIManager:GetInstance():OpenWindow(UIWindowNames.UIEquipSort1,uiData)
end


local function InitSortButton(self)
    local txt = self.rs_sortBtn.transform:Find("Text"):GetComponent("Text")
    txt.text = (recordOrder.order == 1 and {LangUtil.GetSysLang(154)} or {LangUtil.GetSysLang(153)})[1]
    --self.rs_scrollView.verticalScrollbar.value = 1
    self.vs_scroll:MoveTop()
end


local function OnSortButton(self)
    recordOrder.order = (recordOrder.order == 1 and {2}or {1})[1]
    InitSortButton(self)
    this.InitEquipListData(self)
    --this.InitEquipList(self)
end


function this.InitEquipListData(self)
    self.rs_list = {}
    for k,v in table.pairsByKeys(self.equips) do
        if v.Lock ~=1  and UIPublic.GetEquipHolder(v)==nil then
            table.insert(self.rs_list,v)
        end
        --table.insert(self.rs_list,v)
    end

    self.rs_list = UIPublic.EquipScreenFunc(self.rs_list,screenTypes)
    table.sort(self.rs_list, function(a,b) return UIPublic.EquipSortFunc(a,b,recordOrder)end )

    if recordOrder.order ~= 1 then
        self.rs_list = table.reverseTable(self.rs_list)
    end
    self.rs_hint:SetActive(table.count(self.rs_list) == 0)
    self.rs_scroll:RefreshData(self.rs_list)
end

function this.InitEquipList(self)
    --self.rs_hint:SetActive(table.count(self.rs_list) == 0)
    self.rs_scroll:Clear()
    self.rs_scroll:ScrollInit(self.rs_list, self.rs_scrollView, pfbName, function (arg)
        local gameObject = arg.go
        local equip = arg.data
        
        UIPublic.InitEquipItemNew(gameObject.transform,equip)
        local select = gameObject.transform:Find("Select1").gameObject
        gameObject.transform:Find("Mask").gameObject:SetActive(false) 
        LangUtil.GetSpriteLang(317, function(sprite) select:GetComponent("Image").sprite = sprite end)
        select:SetActive(table.first(self.rs_IdList,function(v) return v == equip.Id  end) ~= nil)
        UIUtil.AddBtnEvent(gameObject,function ()
            OnEquipItem(self,equip.Id)
            select:SetActive(table.first(self.rs_IdList,function(v) return v == equip.Id  end) ~= nil)
            --self.rs_scroll:RefreshData(self.rs_list)
        end)
    end)
end


function this.InitButton(self)
    if table.count(self.rs_IdList) > 0 then
        UIPublic.InitButton(self.rs_btn,true,1,LangUtil.GetSysLang(225))
    else
        UIPublic.InitButton(self.rs_btn,false,1,LangUtil.GetSysLang(225))
    end
end

function this.Init(self)
    self.rs_IdList = {}
    --self.rs_holdNumTxt.text = table.count(self.equips).."/"..Game.Scene.Player.EquipMax
    self.rs_gold = 0
    self.rs_sand = 0
    InitSortButton(self)
    InitNumTxt(self)
    this.InitButton(self)
    this.InitEquipListData(self)
    --this.InitEquipList(self)

    self.rs_init = true
end


function this.OnLangCreate(self,panel)
    -- LangUtil.LangTextByName(self.langRc:GetObject("NameTextRoot"),"Text")--.text = LangUtil.GetSysLang(88)
    local langRc = panel.transform:Find("LangControl"):GetComponent("ReferenceCollector")
    local resolve = langRc:GetObject("ResolveButton").transform
    local rewardInfo = langRc:GetObject("RewardInfo").transform
    local holdNum = langRc:GetObject("HoldNum").transform
    local screenBtn = langRc:GetObject("ScreenButton").transform
    local sortBtn = langRc:GetObject("SortButton").transform

    self.rs_goldNumTxt  = LangUtil.BindText(langRc:GetObject("GoldText"),FontType.All_Number)
    self.rs_starSandNumTxt  = LangUtil.BindText(langRc:GetObject("MoneyText"),FontType.All_Number)
    self.choseValue = LangUtil.BindText(langRc:GetObject("choseValue"),FontType.All_Number)
    LangUtil.BindText(langRc:GetObject("choseText")).text = LangUtil.GetSysLang(2060)
    self.SandImage = langRc:GetObject("SandImage"):GetComponent("Image")
    LangUtil.BindText(langRc:GetObject("ShowNumText")).text = LangUtil.GetSysLang(252)
    
    LangUtil.BindText(resolve:Find("Text")).text = LangUtil.GetSysLang(225)
    LangUtil.BindText(screenBtn:Find("Text")).text = LangUtil.GetSysLang(155)
    LangUtil.BindText(rewardInfo:Find("Title/Text")).text = LangUtil.GetSysLang(252)
    --self.rs_starSandNumTxt = LangUtil.BindText(rewardInfo:Find("StarSand/Text"))--.text = Z_Currency[4].Name
    --LangUtil.BindText(rewardInfo:Find("StarSand/StarSandNum"),FontType.All_Number)
    --self.rs_goldNumTxt = LangUtil.BindText(rewardInfo:Find("Gold/Text"))--.text = Z_Currency[1].Name
    --LangUtil.BindText(rewardInfo:Find("Gold/GoldNum"),FontType.All_Number)

    LangUtil.BindText(holdNum:Find("Text")).text = LangUtil.GetSysLang(354)
    LangUtil.BindText(holdNum:Find("Value"),FontType.All_Number)
    LangUtil.BindText(sortBtn:Find("Text"))
end

function this.Create(self)
    self.rs_list = {}
    local rc = self.resolve_panel:GetComponent("ReferenceCollector")

    self.rs_scroll = VerticalScroll.New()
    self.rs_scroll:SetUpdateCount(15)
    self.rs_scrollView = rc:GetObject("Scroll View"):GetComponent("ScrollRect")
    this.InitEquipList(self)
    self.rs_content = rc:GetObject("Content").transform
    self.rs_btn = rc:GetObject("ResolveButton")
    
    self.rs_holdNumTxt = rc:GetObject("HoldNum"):GetComponent("Text")
    self.rs_screenBtn = rc:GetObject("ScreenButton")
    self.rs_sortBtn = rc:GetObject("SortButton")
    self.rs_hint = rc:GetObject("Hint")

    
    
    local goldRoot = rc:GetObject("Gold").transform
    local starSandRoot = rc:GetObject("StarSand").transform
    
    UIUtil.SetSprite(goldRoot:Find("Bg"):GetComponent("Image"),AtlasConfig.ItemBg,Z_Currency[1].IconBg..".png")

    UIUtil.SetSprite(starSandRoot:Find("Bg"):GetComponent("Image"),AtlasConfig.ItemBg,Z_Currency[4].IconBg..".png")
    
    
    UIUtil.AddBtnEvent(self.rs_screenBtn,function()OnScreenButton(self) end)
    UIUtil.AddBtnEvent(self.rs_sortBtn,function()OnSortButton(self) end)
    UIUtil.AddBtnEvent(self.rs_btn,function()OnResolveButton(self) end)
end




function this.OnEquipInfoChg(self)
    if self.rs_init then
        self.rs_IdList = {}
        self.rs_holdNumTxt.text = table.count(self.equips).."/"..Game.Scene.Player.EquipMax
        self.rs_gold = 0
        self.rs_sand = 0
        InitNumTxt(self)
        this.InitButton(self)
        this.InitEquipListData(self)
        self.rs_init = true
        self.rs_hint:SetActive(table.count(self.rs_list) == 0)
        UIPublic.InitHint(self.rs_content,self.rs_hint)
    end
end

function this.OnDisable(self)
    self.rs_scroll:Dispose()
    if self.rs_init then
        self.rs_init = false
    end
    screenTypes = {star = 0, Part = 0, exclusive = 0, isEquip = 0}
    recordOrder.order = 1
end

return this
