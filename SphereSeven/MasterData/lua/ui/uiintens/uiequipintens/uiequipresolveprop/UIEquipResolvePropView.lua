---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by win 10.
--- DateTime: 2019/5/24 16:58
---

local UIEquipResolvePropView = BaseClass("UIEquipResolvePropView",UIBaseView);
local base = UIBaseView
local this = UIEquipResolvePropView

local portNames = {"Hand1Equip","Hand2Equip","BodyEquip","HeadEquip","FootEquip","AdornEquip",}

local function InitEquipInfo(self)
    local transform = self.equip1Info
    local equip = self.equip
    local label = transform:Find("Label")
    local lock = transform:Find("Lock")
    local equipName = transform:Find("EquipName"):GetComponent("Text")
    local equipItem = transform:Find("EquipItemNew")
    local prop = transform:Find("PropNum")
    local desc = transform:Find("Desc"):GetComponent("Text")
    local holderAvatar = transform:Find("Holder/Avatar"):GetComponent("Image")
    local holderName = transform:Find("HolderName"):GetComponent("Text")
    LangUtil.BindText(equipName)
    LangUtil.BindText(prop.transform:Find("Text"))
    LangUtil.BindText(prop.transform:Find("Value"),FontType.All_Number)
    LangUtil.BindText(desc)
    LangUtil.BindText(holderName)

    UIPublic.InitButton(self.confirmBtn, equip.Lock ~= 1)
    local zEquip = Z_Equip[equip.TemplateId]
    UIPublic.InitEquipLabel(label,zEquip)
    UIPublic.InitEquipLock(lock,equip.Lock == 1)
    UIPublic.InitEquipHolder(holderAvatar,equip,holderName)
    equipName.text = zEquip.Name
    UIPublic.InitEquipDesc(desc,zEquip)
    UIPublic.InitEquipProp(prop,equip)
    coroutine.start(function()
        UIPublic.InitEquipItemNew(equipItem,equip)
    end)
end


local function SendResolveReq(self)
    local player = Game.Scene.Player
    local reqData = {AcquireStarSand = self.getSand,AcquireGoldCoin = self.getGold,EquipId = {self.equip.Id}}
    
    local g2cEquipDecompose = coroutine.yieldstart(Game.Scene.Session.CoCall, nil,  Game.Scene.Session,
            OuterOpcode.Name2Code.ETModel_C2M_EquipDecompose, reqData);

    if g2cEquipDecompose.Error == ErrorCode.ERR_Success then
        
        player.GoldCoin = player.GoldCoin + reqData.AcquireGoldCoin;
        player.StarSand = player.StarSand + reqData.AcquireStarSand;
        local equipComponent = player:GetComponent("EquipComponent");
        for k,v in pairs(reqData.EquipId) do
            equipComponent:Remove(v);
        end
        DataManager:GetInstance():Broadcast(DataMessageNames.ON_EQUIP_INFO_CHG);
        DataManager:GetInstance():Broadcast(DataMessageNames.ON_PLAYER_INFO_CHG);
        local infos = {{rewardType = RewardType.Gold,TemplateId = 1,num = reqData.AcquireGoldCoin},
                       {rewardType = RewardType.StarSand,TemplateId = 4,num = reqData.AcquireStarSand}}
        local info = {rewards = infos,title = LangUtil.GetSysLang(2024)}
        UIManager:GetInstance():OpenWindow(UIWindowNames.UIReward,info)
        UIManager:GetInstance():CloseWindow(UIWindowNames.UIEquipResolveProp)
    end

end

local function OnResolve(self)
    local holder = UIPublic.GetEquipHolder(self.equip)

    if holder == nil then
        coroutine.start(function()
            SendResolveReq(self)
        end)
    else
        local tipData = {}
        tipData.title = LangUtil.GetSysLang(9)--"提示"
        tipData.message = LangUtil.GetSysLang(1029)--"此装备已被穿戴,确认分解？"
        tipData.callBack = function()
            local equipChangeData = {}
            local t = {}
            t.CardId = holder.Id
            for k,v in pairs(portNames) do
                t[v] = holder[v]
                if holder[v] == self.equip.Id then
                    t[v] = 0
                end
            end
            table.insert(equipChangeData,t)
            PublicRequest.SendChangeEquipRequest(equipChangeData,function() SendResolveReq(self)  end)
        end
        UIUtil.ToolTipFirst(tipData)
    end
end



function this.OnCreate(self)
    base.OnCreate(self)
    self.equip1Info = self.rc:GetObject("Equip1Info").transform
    self.goldNumTxt = self.rc:GetObject("GoldNum"):GetComponent("Text")
    self.starSandNumTxt = self.rc:GetObject("StarSandNum"):GetComponent("Text")
    self.Info2Title = self.rc:GetObject("Txt")
    
    local eventBg = self.rc:GetObject("EventBg")
    
    self.confirmBtn = self.rc:GetObject("ConfirmButton").gameObject
    self.cancelBtn = self.rc:GetObject("CancelButton").gameObject

    UIUtil.AddBtnEvent(self.confirmBtn,function() OnResolve(self)  end)
    
    local func = function()UIManager:GetInstance():CloseWindow(UIWindowNames.UIEquipResolveProp) end
   
    EventTriggerListener.Get(eventBg).onLuaClick = func
    UIUtil.AddBtnEvent(self.cancelBtn,func)

    local goldRoot = self.rc:GetObject("Gold").transform
    local starSandRoot = self.rc:GetObject("StarSand").transform

    UIUtil.SetSprite(starSandRoot:Find("Bg"):GetComponent("Image"),AtlasConfig.EquipBg,"1.png")
    
end

function this.OnEnable(self)
    base.OnEnable(self);
    self:OnRefresh();
end



function this.OnRefresh(self)
    local info = self.model.info
    self.equip = info.equip
    InitEquipInfo(self)
    
    local zEquip = Z_Equip[self.equip.TemplateId]
    local isEquipType = (zEquip.Exclusive ~=0 and {2} or {1})[1]
    local star = self.equip.Star

    local zEquipDecompose = table.first(Z_EquipDecompose,function(v)
        return v.EquipType == isEquipType and v.Star == star
    end)
    LangUtil.BindText(self.goldNumTxt,FontType.All_Number)
    LangUtil.BindText(self.starSandNumTxt,FontType.All_Number)
    LangUtil.BindText(self.confirmBtn.transform:Find("Text"))
    LangUtil.BindText(self.cancelBtn.transform:Find("Text")) 
    self.getGold = zEquipDecompose.GoldCoinPer
    self.getSand = zEquipDecompose.StarSandPer
    
    self.goldNumTxt.text = Z_Currency[1].Name .. "<color=#FFF2AA> x"..self.getGold .."</color>"
    self.starSandNumTxt.text = Z_Currency[4].Name .. "<color=#FFF2AA> x"..self.getSand .."</color>"
    LangUtil.BindText(self.Info2Title).text = LangUtil.GetSysLang(252)  
end


function this.OnAddListener(self)
    base.OnAddListener(self)
end

function this.OnRemoveListener(self)
    base.OnRemoveListener(self);
end

function this.OnDisable(self)
    base.OnDisable(self);
end

function this.OnDestroy(self)
    base.OnDestroy(self);
end

return this;

