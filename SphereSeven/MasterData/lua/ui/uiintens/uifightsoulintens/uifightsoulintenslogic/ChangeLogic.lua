---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by win 10.
--- DateTime: 2019/4/22 9:54
---

local ChangeLogic = {};
local this = ChangeLogic;

local color0 = Color.New(105/255,121/255,157/255)
local color1 = Color.New(255/255,255/255,255/255)


local function InitCardInfo(self) --角色数据
    UIPublic.InitCardItemDataNew(self.cur_card,self.ch_cardInfo,true)
    UIPublic.InitNumerical(self.ch_numerical,self.cur_card)
    UIPublic.InitExpArea(self.ch_expBar,self.cur_card)
end




local function InitFightSouls(self,isfresh) -- 战魂数据
    if self.cur_card == nil  then
        return
    end
    for k,v in pairs(self.ch_fightSouls) do
        local fightSoulId = self.cur_card["FightSoul"..k]
        local addBtn = v:Find("IconRoot/AddButton").gameObject
        local fightItem = v:Find("IconRoot/FightVisitItem")
        local indexTxt = v:Find("IndexTxt"):GetComponent("Text")
        local propTxt = v:Find("PropImg/PropTxt"):GetComponent("Text")
        local effTxt = v:Find("EffTxt"):GetComponent("Text")
        local lock = v:Find("IconRoot/FightVisitItem/Lock").gameObject
        
        
        fightItem.gameObject:SetActive(fightSoulId ~= 0)
        addBtn.gameObject:SetActive(fightSoulId == 0)
        if  fightSoulId ~= 0 then
            local fightSoul = self.fightSouls[fightSoulId]
            if fightSoul == nil then
                Logger.LogError(Z_Card[self.cur_card.TemplateId].Name.."战魂错误")
            else
                UIPublic.InitVsFightSoulItemMId(fightSoul,fightItem,isfresh)
                indexTxt.color = color1
                effTxt.color = color1
                effTxt.text = ""
                local str =Z_FightSoul[fightSoul.TemplateId].EquipEfx
                local arr = string.toarray(str)
                if table.count(arr) > 500 then
                    for i = 1, 100 do
                        effTxt.text = effTxt.text..arr[i]
                    end
                    effTxt.text = effTxt.text.."..."
                else
                    effTxt.text = str
                end
                lock:SetActive(false)
                --UIPublic.InitFightSoulEff(effTxt,Z_FightSoul[fightSoul.TemplateId])
                UIPublic.InitFightSoulProp(propTxt,fightSoul,nil,true)
            end
        else
            indexTxt.color = color0
            effTxt.color = color0
            propTxt.color = color0
            propTxt.text = "+0%"
            effTxt.text = LangUtil.GetSysLang(809)
            lock:SetActive(false)
        end
    end
    
end

local function OnClear(self) --点击一键卸载
    local reqData = {}
    reqData.CardId = self.cur_card.Id
    for k,v in pairs({1,2,3}) do
        reqData["FightSoul"..v] = 0
    end

    PublicRequest.SendChangeFightSoulRequest({reqData})
end

local function OnCardList(self)  --打开角色列表
    UIUtil.OpenCardList({callBack = function(card)
        self.cur_card = card
        this.Init(self)
    end })
end

local function InitClearButton(self) --初始化按钮
  
end


function this.Init(self)
    if self.cur_card == nil then
        --OnCardList(self)
        self.ch_cardInfo.gameObject:SetActive(false)
    else
        self.ch_cardInfo.gameObject:SetActive(true)
        InitCardInfo(self) 
        InitFightSouls(self) 
    end
    InitClearButton(self)
    self.ch_init = true
end

local function OnFightSoulListCallBack(self,fightSoulId,index)
    UIManager:GetInstance():OpenWindow(UIWindowNames.UIFightSoulChangeState1,
            {card = self.cur_card,index = index,state = 1,fightSoul = self.fightSouls[fightSoulId]})
end

local function OnFightSoulItemCallBack(self,fightSoulId,fightSoul,index)
    local uiData = {}
    uiData.fightSoul1 = fightSoul
    uiData.fightSoul2 = Game.Scene.Player:GetComponent("FightSoulComponent").FightSouls[fightSoulId]
    uiData.index = index
    UIManager:GetInstance():OpenWindow(UIWindowNames.UIFightSoulChangeState2,uiData)
end


local function OnFightSoulItem(self,id)
    if self.cur_card == nil then
        UIUtil.ToolTipFourth(LangUtil.GetSysLang(811))
        return
    end
    if self.cur_card["FightSoul"..id] == 0 then  --没有战魂时  直接打开战魂列表
        local fightSouls = Game.Scene.Player:GetComponent("FightSoulComponent"):OnEquipFightSoul(self.cur_card)
        
        UIManager:GetInstance():OpenWindow( UIWindowNames.UIFightSoulList,{
            fightSouls = fightSouls,
            cur_card = self.cur_card,
            callBack = function(fightSoulId) OnFightSoulListCallBack(self,fightSoulId,id)
            end}
        )
    else  --有战魂时 打开state1 弹窗
        --local fightSouls = Game.Scene.Player:GetComponent("FightSoulComponent"):OnEquipFightSoul(self.card)
        --
        --UIManager:GetInstance():OpenWindow(UIWindowNames.UIFightSoulList,
        --        {
        --            fightSouls= fightSouls,
        --            card = self.cur_card,
        --            index = id,
        --            callBack = function(fightSoulId) OnFightSoulItemCallBack(self,fightSoulId,fightSouls)
        --            end})
        local fightSoulId = self.cur_card["FightSoul"..id]
        UIManager:GetInstance():OpenWindow(UIWindowNames.UIFightSoulChangeState1,
                {card = self.cur_card,index = id,state = 2,fightSoul = self.fightSouls[fightSoulId]})
    end
end

function this.OnLangCreate(self,panel)
    -- LangUtil.LangTextByName(self.langRc:GetObject("NameTextRoot"),"Text")--.text = LangUtil.GetSysLang(88)
    local langRc = panel.transform:Find("LangControl"):GetComponent("ReferenceCollector")
    local fightSoulRoot = langRc:GetObject("FightSoulRoot").transform
    local deEquip = langRc:GetObject("DeEquipButton").transform
    local cardListBtn = langRc:GetObject("CardListButton").transform
    local levelTxt = langRc:GetObject("LevelText").transform
    local numerical = langRc:GetObject("Numerical").transform

    for i = 0,fightSoulRoot.childCount - 1 do
        local child = fightSoulRoot:GetChild(i)
        LangUtil.BindText(child:Find("IndexTxt")).text = LangUtil.GetSysLang(724)..":"
        LangUtil.BindText(child:Find("PropImg/PropTxt")).text = "0%"
        LangUtil.BindText(child:Find("EffTxt")).text = LangUtil.GetSysLang(809)
    end
    
    LangUtil.BindText(deEquip:Find("Text")).text = LangUtil.GetSysLang(249)
    LangUtil.BindText(cardListBtn:Find("Text")).text = LangUtil.GetSysLang(250)
    LangUtil.BindText(levelTxt,FontType.All_Number)
    UIPublic.CreateNumericalLang(numerical)
end

function this.OnCreate(self)
    local rc = self.panels[2]:GetComponent("ReferenceCollector")
    local clearBtn = rc:GetObject("ClearButton")
    local cardListBtn = rc:GetObject("CardListButton")
    local fightSoulRoot = rc:GetObject("FightSoulRoot").transform
    self.ch_numerical = rc:GetObject("Numerical").transform
    self.ch_expBar = rc:GetObject("ExpBar").transform
    self.ch_cardInfo = rc:GetObject("CardInfo").transform
    self.ch_fightSouls = {}

    for i = 0,fightSoulRoot.childCount - 1 do
        local child = fightSoulRoot:GetChild(i)
        self.ch_fightSouls[i+1] = child
        UIUtil.AddBtnEvent(child,function()OnFightSoulItem(self,i+1)  end)
    end

    UIUtil.AddBtnEvent(clearBtn,function()OnCardList(self) end)
    UIUtil.AddBtnEvent(cardListBtn,function()OnClear(self) end)
end

function this.OnFightSoulChg(self)
    if  self.ch_init then
        UIPublic.InitNumerical(self.ch_numerical,self.cur_card)
        InitFightSouls(self)
        InitClearButton(self)
    end
end

function this.OnDisable(self)
    self.ch_init = false
end

function this.OnDestroy(self)
    
end

return this
