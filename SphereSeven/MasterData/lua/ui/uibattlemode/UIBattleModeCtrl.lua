---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by win 10.
--- DateTime: 2019/5/24 16:58
---
local expendStarStone = 100

local UIBattleModeCtrl = BaseClass("UIBattleModeCtrl",UIBattleModeCtrl);
local this = UIBattleModeCtrl

function this.CloseSelf(self)
    UIManager:GetInstance():CloseWindow(UIWindowNames.UIBattleMode) 
    local window =UIManager:GetInstance():GetWindow(UIWindowNames.UIHome)
    local view =window.View
    view:ToolTip()
end


local function SendOpenTimeRequest(self,isItem,day)

    --Id

    
    local player = Game.Scene.Player
    local reqData = {}
    reqData.Id = day*10
    

    if isItem then --使用物品
        --[[local item = table.first(player:GetComponent("ItemComponent").Items,function(v) return v.TemplateId == 3014  end)
        local Material = {}
        Material.MaterialId = item.Id
        Material.Amount = 1
        Material.MaterialType = 0
        table.insert(reqData.ExpendMaterialList,Material)]]
    else --使用星石
        local surplusStarStone = player.FreeStarStone - expendStarStone
        if surplusStarStone < 0 then
            reqData.ExpendPaidStarStone = -surplusStarStone
            reqData.ExpendFreeStarStone = player.FreeStarStone
        else
            reqData.ExpendPaidStarStone = 0
            reqData.ExpendFreeStarStone = expendStarStone
        end
        reqData.Id=reqData.Id+1
        if player.PaidStarStone < reqData.ExpendPaidStarStone then
            local tipData = {}
            tipData.title = LangUtil.GetSysLang(9)--"提示"
            tipData.message = LangUtil.GetSysLang(546)--"星石不足,是否前往充值"
            tipData.callBack = function()
                UIUtil.ToolTipFourth(LangUtil.GetSysLang(541))
            end
            UIUtil.ToolTipFirst(tipData)
            return
        end
    end

    coroutine.start(function()
        local response =coroutine.yieldstart(Game.Scene.Session.CoCall,nil,Game.Scene.Session,
                OuterOpcode.Name2Code.ETModel_C2M_OpenTime,reqData)
        if response.Error == ErrorCode.ERR_Success then
           
            player.FreeStarStone = player.FreeStarStone - reqData.ExpendFreeStarStone
            player.PaidStarStone = player.PaidStarStone - reqData.ExpendPaidStarStone
            player:GetComponent("SevenStarComponent").Days[day].OpenTime = response.OpenDateTime
            for k ,v in pairs(reqData.ExpendMaterialList) do
                UIUtil.RemoveItem(v.MaterialId,v.Amount)
            end
            DataManager:GetInstance():Broadcast(DataMessageNames.ON_PLAYER_INFO_CHG)
        end
    end)
end

function this.OpenSevenStarTime(self,day)
    local item = table.first(Game.Scene.Player:GetComponent("ItemComponent").Items,function(v) return v.TemplateId == 3014 end)
    local func = function(isItem)
        SendOpenTimeRequest(self,isItem,day)
    end
    local tipData = {}
    if item ~= nil then
        tipData.title = LangUtil.GetSysLang(9)--"提示"
        tipData.message = LangUtil.GetSysLang(538)--"是否优先消耗'时之沙漏'开放此模式1小时?"
        tipData.callBack = function()
            func(true)
        end
        tipData.cancelCallBack = function()
            local tipData = {}
            tipData.title = LangUtil.GetSysLang(9)--"提示"
            tipData.message = LangUtil.GetSysLang(539)--"确定使用100星石开放此模式1小时吗?"
            tipData.callBack = function()
                func(false)
            end
            UIUtil.ToolTipFirst(tipData)
        end
    else
        tipData.title = LangUtil.GetSysLang(9)--"提示"
        tipData.message = LangUtil.GetSysLang(539)--"确定使用100星石开放此模式1小时吗?"
        tipData.callBack = function()
            func(false)
        end
    end
    UIUtil.ToolTipFirst(tipData)
end

return this;

