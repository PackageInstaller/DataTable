---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by win 10.
--- DateTime: 2019/4/12 21:12
---

local UIAllShopCtrl = BaseClass("UIAllShopCtrl",UIBaseCtrl)
local this = UIAllShopCtrl
local channel = 2

function this.CloseSelf()
    UIManager:GetInstance():CloseWindow(UIWindowNames.UIAllShop)
end

function this.SendStarLightRequest(self,data)
    self.model.packageIsNeedUpdate = false
    local reqTable = {
        goods_id = data.Id
    }

    coroutine.start(function()
        ---编辑器模式依然走Payment
        if UNITY_EDITOR then
            -- local info = coroutine.yieldstart(Game.Scene.Session.CoCall,nil,Game.Scene.Session,
            -- PROTOCOL.BuyPaymentGoodsReq, reqTable)

            -- if info ~= nil then
            -- UIPublic.OpenRewardUI(info.reward_result)
            -- end

            PublicRequest.SendRequest(
            PROTOCOL.CreatePaymentOrderReq,reqTable,
            function(response, error)
                if error == 0 then
                    local goodsInfo = Z_StarLightStoneShop[data.Id]
                    local channelGoodsId = Z_PaymentChannel[goodsInfo.ChannelInfo][channel].ChannelGoodsId

                    ChannelManager:GetInstance():Purchase(channelGoodsId, response.order_id)
                    --ChannelManager:GetInstance():Purchase("com.feimo.sevensphere.goods.6", response.order_id)
                elseif error == 12013 then
                    UIUtil.ToolTipFourth(LangUtil.GetSysLang(2097))
                elseif error == 12009 then
                    UIUtil.ToolTipFourth(LangUtil.GetSysLang(2097))
                end
            end)
        elseif data.Price == 0 then --免费礼包依然走Payment
            local info = coroutine.yieldstart(Game.Scene.Session.CoCall,nil,Game.Scene.Session,
            PROTOCOL.BuyPaymentGoodsReq, reqTable)

            if info ~= nil then
            UIPublic.OpenRewardUI(info.reward_result)
            end
        else --非编辑器模式和付费礼包走Create
            PublicRequest.SendRequest(
            PROTOCOL.CreatePaymentOrderReq,reqTable,
            function(response, error)
                if error == 0 then
                    local goodsInfo = Z_StarLightStoneShop[data.Id]
                    local channelGoodsId = Z_PaymentChannel[goodsInfo.ChannelInfo][channel].ChannelGoodsId

                    ChannelManager:GetInstance():Purchase(channelGoodsId, response.order_id)
                    --ChannelManager:GetInstance():Purchase("com.feimo.sevensphere.goods.6", response.order_id)
                elseif error == 12013 then
                    UIUtil.ToolTipFourth(LangUtil.GetSysLang(2097))
                elseif error == 12009 then
                    UIUtil.ToolTipFourth(LangUtil.GetSysLang(2097))
                end
            end)
        end
    end)
end

function this.SendFreeGoods(self, data)
    self.model.packageIsNeedUpdate = false
    local reqTable = {
        goods_id = data.Id
    }

    coroutine.start(function()
        --免费礼包依然走Payment
        local info = coroutine.yieldstart(Game.Scene.Session.CoCall,nil,Game.Scene.Session,
        PROTOCOL.BuyPaymentGoodsReq, reqTable)

        if info ~= nil then
            UIPublic.OpenRewardUI(info.reward_result)
        end
    end)
end

function this.SendPackageBuyRequest(self, id)
    local reqTable = {
        shop_id = ShowType.Package,
        goods = {
            {
                goods_id = id,
                count = 1
            }
        }
    }
    coroutine.start(function()
        ---@type protocol.BuyGoodsResp
        local info = coroutine.yieldstart(Game.Scene.Session.CoCall,nil,Game.Scene.Session,
            PROTOCOL.BuyGoodsReq, reqTable)

            if info ~= nil then
                if table.any(info.reward_result, function(v) return v.type == RewardType.RewardTypeCharacter end) then
                    local rewardResult = {}
                    for key, value in pairs(info.reward_result) do
                        if value.type == RewardType.RewardTypeCharacter then
                            table.insert(rewardResult, value)
                        end
                    end
                    UIPublic.OpenRewardUI(rewardResult)
                else
                    UIPublic.OpenRewardUI(info.reward_result)
                end
            end
        end)
end

function this.SendBuyRequest(self, data)
    local reqTable = {
        shop_id = StoreType.Skin,
        goods = {
            {
                goods_id = data.StoreId,
                count = 1
            }
        }
    }
    coroutine.start(function()
        PublicRequest.SendRequest(
            PROTOCOL.BuyGoodsReq,
            reqTable,
            function(info, errorCode)
                if errorCode == 202 then
                    UIUtil.ToolTipFourth(LangUtil.GetSysLang(1086))
                    return
                end

                if errorCode == 0 then 
                    local rewardResult = {}
                    for _, value in pairs(info.reward_result) do
                        if value.type == RewardType.RewardTypeCharacterSkin then
                            table.insert(rewardResult, value)
                        end
                    end
                    UIPublic.OpenRewardUI(rewardResult)
                end
            end
        )
        end)
end

return this