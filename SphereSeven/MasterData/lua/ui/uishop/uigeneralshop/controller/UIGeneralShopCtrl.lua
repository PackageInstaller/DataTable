---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by win 10.
--- DateTime: 2019/4/12 21:12
---

local UIGeneralShopCtrl = BaseClass("UIGeneralShopCtrl",UIBaseCtrl)
local this = UIGeneralShopCtrl

function this.CloseSelf()
    UIManager:GetInstance():CloseWindow(UIWindowNames.UIGeneralShop);
end

local function IsItemLimit(zStore, addNum)
    if zStore.GoodsType == 1 then--道具
        return UIPublic.IsItemLimit(1, addNum, {GoodsId = zStore.GoodsId})
    elseif zStore.GoodsType == 2 then-- 装备 
        return UIPublic.IsItemLimit(7, addNum, {hideBtn3 = true})
    elseif zStore.GoodsType == 3  then --角色
        return UIPublic.IsItemLimit(2, addNum, {hideBtn3 = true})
    end
    return false
end

function this.SendBuyRequest(self, zStore, num, kind)
    if IsItemLimit(zStore, zStore.Amount * num) then--限制
        return
    end
    local reqTable = {
        shop_id = kind,
        goods_id = zStore.Id,
        count = num
    }
    coroutine.start(function()
        ---@type protocol.BuyGoodsResp
        local info = coroutine.yieldstart(Game.Scene.Session.CoCall,nil,Game.Scene.Session,
            PROTOCOL.BuyGoodsReq, reqTable)

            if info ~= nil then
                if table.any(info.reward_result, function(v) return v.type == RewardType.RewardTypeCharacter end) then
                    local rewardResult = {}
                    for key, value in pairs(info.reward_result) do
                        if value.type == RewardType.RewardTypeCharacter then
                            table.insert(rewardResult, value)
                        end
                    end
                    UIPublic.OpenRewardUI(rewardResult)
                else
                    UIPublic.OpenRewardUI(info.reward_result)
                end
            end
        end)
    --PublicRequest.SendBuyItemRequest(zStore,num);
end

local function ExpendGoods(zExchangeStore,Num)
    local itemComponent = Game.Scene.Player:GetComponent("ItemComponent").Items;
    for i = 1,#zExchangeStore.ExpendItem do
        for k,v in pairs(itemComponent) do
            if v.TemplateId == zExchangeStore.ExpendItem[i] then
                UIUtil.RemoveItem(v.Id,zExchangeStore.ExpendItemNum[i]*Num);
                break
            end
        end
    end
end

return this