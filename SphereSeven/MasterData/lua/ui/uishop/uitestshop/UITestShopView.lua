---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by win 10.
--- DateTime: 2019/4/12 21:12
---


local UITestShopShopView = BaseClass("UITestShopShopView",UIBaseView)
local base = UIBaseView
local this = UITestShopShopView;

local back_btn_path = "ReturnButton";
local buy_btn_path = "BuyButton"

local item_prefab_path = "ItemPf"
local card_prefab_path = "CardItem"
local equip_prefab_path = "EquipMsgPf"
local fightSoul_prefab_path = "FightSoulMsgPf"

local open_item_btn_path = "Item"
local open_card_btn_path = "CardButton"
local open_equip_btn_path = "EquipButton"
local open_fightSoul_btn_path = "FightSoulButton"

local item_panel_path = "ItemSoulShop";
local card_panel_path = "CardShop";
local equip_panel_path = "EquipShop";
local fightSoul_panel_path = "FightSoulShop";

local item_content_path = "ItemContent"
local card_content_path = "CardContent"
local equip_content_path = "EquipContent"
local fightSoul_content_path = "FightSoulContent"

local desc_text_path = "Text";
local input_field_path = "CountInputField";


local function OnClickBuy(gameObject)
    local self = gameObject:GetComponent("BindData"):Get("self");
    
    if self.goods == nil then
        UIUtil.ToolTipFourth(LangUtil.GetSysLang(1069));--"没有选择商品"
        return;
    end

    if self.panel_id == 2 then

        local str = self.input_lv_field.text
        local str2 = self.input_star_field.text
        local lv = tonumber(str)
        local star = tonumber(str2)
        if lv==nil or lv==0 or lv>80 then
            lv=1
        end
        if star ==nil or star==0 or star>5 then
            star=1
        end
        self.ctrl:SendBuyCardRequest(self.goods,lv,star);
    elseif self.panel_id == 1 then
        local str = self.input_field.text;
        if str == "" or tonumber(str) == 0 then
            UIUtil.ToolTipFourth(LangUtil.GetSysLang(1070));--"没有选择数量"
            return;
        elseif tonumber(str) < 0 then
            UIUtil.ToolTipFourth(LangUtil.GetSysLang(1071));--"数量不能小于0"
            return;
        end
        self.ctrl:SendBuyItemRequest(self.goods,tonumber(str));
    elseif self.panel_id == 3 then
        self.ctrl:SendBuyEquipRequest(self.goods);
    elseif self.panel_id == 4 then
        self.ctrl:SendBuyFightSoulRequest(self.goods);
    end
    
end


local function OnClickGoods(gameObject)
    local bindData = gameObject:GetComponent("BindData");
    local self = bindData:Get("self");
    if self.panel_id == 1 then
        self.goods = bindData:Get("item");
        self.desc_text.text = "--物品:"..Z_Item[self.goods.Id].Name;
    elseif self.panel_id == 2 then
        self.goods = bindData:Get("card");
        self.desc_text.text = "--角色:"..Z_Card[self.goods.TemplateId].Name;
    elseif self.panel_id == 3 then
        self.goods = bindData:Get("zEquip");
        self.desc_text.text = "--装备:"..self.goods.Name;
    elseif self.panel_id == 4 then
        self.goods = bindData:Get("zFightSoul");
        self.desc_text.text = "--战魂:"..self.goods.Name;
    end
end


local function InitFightSoulContent(self)
    if self.needLoad_fightSoul == true then
        coroutine.start(function()
            for k,v in table.pairsByKeys(Z_FightSoul) do
                if self.active == false then self:OnDisable() return end;
                ListChildPool:GetInstance():GetChild("FightSoulMsgPf",self.fightSoul_content,function(object)
                    object:SetActive(false);
                    local fightSoul = {};
                    fightSoul.Star = 1;
                    fightSoul.TemplateId = v.Id;
                    UIPublic.InitFightSoulMsg(self,object,fightSoul,false);
                    local bindData = UIUtil.GetButtonDataComponent(object);
                    bindData:Add("self",self);
                    bindData:Add("zFightSoul",v);
                    ButtonListener.Get(object).OnClickHandler = OnClickGoods;
                    object:SetActive(true);
                end);
            end
        end)
        self.needLoad_fightSoul = false;
    end
end


local function InitEquipContent(self)
    if self.needLoad_equip == true then
        coroutine.start(function()
            for k,v in table.pairsByKeys(Z_Equip) do
                if self.active == false then self:OnDisable() return end;
                if not string.IsNullOrEmpty(v.Name) then
                    ListChildPool:GetInstance():GetChild("EquipMsgPf",self.equip_content,function(object)
                        object:SetActive(false);
                        local equip = {};
                        equip.Level = 0;
                        equip.Star = 0;
                        equip.TemplateId = v.Id;
                        UIPublic.InitEquipMsg(object,equip);
                        local bindData = UIUtil.GetButtonDataComponent(object);
                        bindData:Add("self",self);
                        bindData:Add("zEquip",v);
                        ButtonListener.Get(object).OnClickHandler = OnClickGoods;
                        object:SetActive(true);
                    end);
                end
            end
        end)
        self.needLoad_equip = false
    end
end


local function InitItemContent(self)
    if self.needLoad_item == true then
        coroutine.start(function()
            for k,v in table.pairsByKeys(Z_Item) do
                if self.active == false then self:OnDisable() return end;
                ListChildPool:GetInstance():GetChild("TestItemPf",self.item_content,function(object)
                    object:SetActive(false);
                    local bindData = UIUtil.GetButtonDataComponent(object);
                    local transform = object.transform;
                    local icon = transform:Find("Image"):GetComponent("Image");
                    local text = transform:Find("Image/Text"):GetComponent("Text");
                    UIUtil.SetSprite(icon,AtlasConfig.Item,GetItemIcon(v));
                    text.text = v.Name;
                    bindData:Add("item",v);
                    bindData:Add("self",self);
                    ButtonListener.Get(object).OnClickHandler = OnClickGoods;
                    object:SetActive(true);
                end);
            end
        end)
        self.needLoad_item = false;
    end
end

local function InitCardContent(self)
     if self.needLoad_card == true then
        coroutine.start(function()
            for k,v in table.pairsByKeys(Z_Card) do
                if self.active == false then self:OnDisable() return end;
                if v.SsUnitId ~=0 and v.IsMonster ~= 1 then
                    local card = {};
                    card.TemplateId = k;
                    card.Star = 1;
                    card.Stage = 1;
                    card.Level = 1;
                    UIPublic.InitCardItem(self,self.card_content,card,false,OnClickGoods);
                end
            end
        end)
         self.needLoad_card = false
    end
end

local function Fresh(self)
    self.goods = nil;
    self.desc_text.text = "--未选择物品";
    self.input_field.text = "0";
    self.input_lv_field.text="1"
    self.input_star_field.text="1"
end

local function OnClickOpenPanelButton(self,id)
    for k,v in table.pairsByKeys(self.panel_tab) do
        if k == id then
            v:SetActive(true);
        else
            v:SetActive(false);
        end
    end
    self.panel_id = id;
    self.func_tab[id](self);
    Fresh(self)
end

function this.OnCreate(self)
    base.OnCreate(self);
    
    self.panel_id = 3;
    self.needLoad_item = true;
    self.needLoad_equip = true;
    self.needLoad_card = true;
    self.needLoad_fightSoul = true;

    self.item_content = self.rc:GetObject(item_content_path);
    self.card_content = self.rc:GetObject(card_content_path);
    self.equip_content = self.rc:GetObject(equip_content_path);
    self.fightSoul_content = self.rc:GetObject(fightSoul_content_path);
    
    self.back_btn = self.rc:GetObject(back_btn_path);
    self.buy_btn = self.rc:GetObject(buy_btn_path);
    self.item_prefab = self.rc:GetObject(item_prefab_path);
    self.card_prefab = self.rc:GetObject(card_prefab_path);
    self.equip_prefab = self.rc:GetObject(equip_prefab_path);
    self.fightSoul_prefab = self.rc:GetObject(fightSoul_prefab_path);
    self.open_item_btn = self.rc:GetObject(open_item_btn_path);
    self.open_card_btn = self.rc:GetObject(open_card_btn_path);
    self.open_equip_btn = self.rc:GetObject(open_equip_btn_path);
    self.open_fightSoul_btn = self.rc:GetObject(open_fightSoul_btn_path);
    self.item_panel = self.rc:GetObject(item_panel_path);
    self.card_panel = self.rc:GetObject(card_panel_path);
    self.equip_panel = self.rc:GetObject(equip_panel_path);
    self.fightSoul_panel = self.rc:GetObject(fightSoul_panel_path);
    self.desc_text = self.rc:GetObject(desc_text_path):GetComponent("Text");
    self.input_field = self.rc:GetObject(input_field_path):GetComponent("InputField");
    self.input_lv_field = self.rc:GetObject("LvInputField"):GetComponent("InputField");
    self.input_star_field = self.rc:GetObject("StarInputField"):GetComponent("InputField");

    
    self.panel_tab = {[1] = self.item_panel,[2] = self.card_panel,[3] = self.equip_panel,[4] = self.fightSoul_panel};
    self.func_tab = {[1] = InitItemContent,[2] = InitCardContent,[3] = InitEquipContent,[4] = InitFightSoulContent};
    
    ButtonListener.Get(self.back_btn).OnClickHandler = self.ctrl.CloseSelf;
    
    UIUtil.GetButtonDataComponent(self.buy_btn):Add("self",self);
    ButtonListener.Get(self.buy_btn).OnClickHandler = OnClickBuy;
    ButtonListener.Get(self.open_equip_btn).OnClickHandler = function(v) OnClickOpenPanelButton(self,3) end
    ButtonListener.Get(self.open_item_btn).OnClickHandler = function(v) OnClickOpenPanelButton(self,1) end
    ButtonListener.Get(self.open_card_btn).OnClickHandler = function(v) OnClickOpenPanelButton(self,2) end
    ButtonListener.Get(self.open_fightSoul_btn).OnClickHandler = function(v) OnClickOpenPanelButton(self,4) end

   
  
end

function this.OnEnable(self)
    base.OnEnable(self);
    self:OnRefresh();
end

function this.OnRefresh(self)
    Fresh(self);
    OnClickOpenPanelButton(self,self.panel_id);
end

function this.OnAddListener(self)
    base.OnAddListener(self);
   
end

function this.OnRemoveListener(self)
    base.OnRemoveListener(self);
   
end

function this.OnDisable(self)
    base.OnDisable(self);
    self.needLoad_item = true;
    self.needLoad_equip = true;
    self.needLoad_card = true;
    self.needLoad_fightSoul = true;
 
    ListChildPool:GetInstance():ClearContent(self.card_content);
    ListChildPool:GetInstance():ClearContent(self.equip_content);
    ListChildPool:GetInstance():ClearContent(self.item_content);
    ListChildPool:GetInstance():ClearContent(self.fightSoul_content);
end

function this.OnDestroy(self)
    base.OnDestroy(self);
end

return this
