---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by win 10.
--- DateTime: 2019/4/12 21:12
---

local UIPropsForShopCtrl = BaseClass("UIPropsForShopCtrl",UIBaseCtrl)
local this = UIPropsForShopCtrl

function this.CloseSelf()
    UIManager:GetInstance():CloseWindow(UIWindowNames.UIPropsForShop);
end



local function ItemIsEnough(zExchangeStore)

    local items = Game.Scene.Player:GetComponent("ItemComponent").Items;

    local tempTab = {};
    for i = 1,#zExchangeStore.ExpendItem do
        tempTab[i] = {};
        tempTab[i].Id = zExchangeStore.ExpendItem[i];
        tempTab[i].Amount = zExchangeStore.ExpendItemNum[i];
    end
    
    return table.all(tempTab,function(a)  
        local item = table.first(items,function(b) return b.TemplateId == a.Id  end )
        if item == nil then return false end;
        return item.Amount >= a.Amount;
    end)
    
end


local function ExpendGoods(zExchangeStore)
    local itemComponent = Game.Scene.Player:GetComponent("ItemComponent").Items;

    for i = 1,#zExchangeStore.ExpendItem do
        for k,v in pairs(itemComponent) do
            if v.TemplateId == zExchangeStore.ExpendItem[i] then
                UIUtil.RemoveItem(v.Id,zExchangeStore.ExpendItemNum[i]);
                break;
            end
        end
    end
end


function this.SendBuyRequest(self,zExchangeStore)
    
    local itemComponent = Game.Scene.Player:GetComponent("ItemComponent");
    local Items = itemComponent.Items;

    if not ItemIsEnough(zExchangeStore) then
        UIUtil.ToolTipFourth("物品不足"); -- ignoreCN
        return;
    end
    
    coroutine.start(function()
        local g2cStorePurchase = coroutine.yieldstart(Game.Scene.Session.CoCall, nil,  Game.Scene.Session,
                OuterOpcode.Name2Code.ETModel_C2M_ItemExchange, {  ExchangeStoreId = zExchangeStore.Id})
        if g2cStorePurchase.Error == ErrorCode.ERR_Success then
           
            ExpendGoods(zExchangeStore);
            local itemInfo = g2cStorePurchase.ItemBean;
            UIPublic.AddItem(itemInfo)
            DataManager:GetInstance():Broadcast(DataMessageNames.ON_ITEM_INFO_CHG);
        end
    end)
end

return this