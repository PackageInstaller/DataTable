---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by win 10.
--- DateTime: 2019/5/24 16:58
---

local UITransitionView = BaseClass("UITransitionView",UIBaseView);
local base = UIBaseView
local this = UITransitionView

function this.OnCreate(self)
    base.OnCreate(self);
    self.image = self.gameObject:GetComponent("Image");
    self.image.color = Color.New(0,0,0,1);
    self.workingMode = 0 -- 0没工作  1打开界面  2关闭界面
    self.delay = 0
    self.openingTime = 0
end

function this.OnEnable(self)
    base.OnEnable(self);
    self:OnRefresh()
end

local function OnTransitChg(self)
    self:OnRefresh()
end

function this.Update(self)
    if self.workingMode == 0 then -- 没工作
        return
    end
    if self.workingMode == 1 then -- 打开界面
        local wnd = UIManager:GetInstance():GetWindow(self.model.ui_name, true, true)
        if wnd == nil or wnd.View.canvas.unity_canvas.sortingOrder <= 0 then
            return
        end
    end
    self.delay = self.delay - Time.deltaTime
    if self.delay <= 0 then
        self.workingMode = 0
        self.image.raycastTarget = false
        self.image:DOFade(0,0.2)
    end
end

function this.OnRefresh(self)
    if self.model.mode == 1 then -- 自宅独立逻辑
        coroutine.start(function ()
            self.image.raycastTarget = true
            self.image.color = Color.New(0,0,0,0);
            self.image:DOFade(1, 1.5)
            coroutine.waitforseconds(self.model.time)
            self.image:DOFade(0, 1.5)
            coroutine.waitforseconds(1.5)
            self.image.raycastTarget = false
        end)
        return
    end
    if self.model.mode == nil then -- 界面过渡逻辑
        if self.workingMode == 1 then -- 正在打开界面
            return
        end
        if self.workingMode == 0 then -- 没工作
            if not string.IsNullOrEmpty(self.model.ui_name) then
                self.workingMode = 1
            else
                self.workingMode = 2
            end
            self.image:DOKill()
            self.image.color = Color.New(0,0,0,1)
            self.image.raycastTarget = true
            self.delay = self.model.time
            self.openingTime = Time.time
        elseif self.workingMode == 2 then
            if not string.IsNullOrEmpty(self.model.ui_name) then
                self.workingMode = 1
                self.image:DOKill()
                self.image.color = Color.New(0,0,0,1)
                self.image.raycastTarget = true
                self.delay = self.model.time
                self.openingTime = Time.time
            end
        end
    end
end

function this.OnAddListener(self)
    base.OnAddListener(self)
    self:AddUIListener(UIMessageNames.ON_UI_TRANSIT, OnTransitChg)
end

function this.OnRemoveListener(self)
    base.OnRemoveListener(self);
    self:RemoveUIListener(UIMessageNames.ON_UI_TRANSIT)
end

function this.OnDisable(self)
    base.OnDisable(self);
end

function this.OnDestroy(self)
    base.OnDestroy(self);
end

return this;

