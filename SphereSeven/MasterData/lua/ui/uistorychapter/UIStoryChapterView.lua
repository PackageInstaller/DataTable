---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by win 10.
--- DateTime: 2019/5/24 16:58
---

local UIStoryChapterView = BaseClass("UIStoryChapterView",UIBaseView);
local base = UIBaseView
local this = UIStoryChapterView

local pfbName = "StoryChapterItem"
local lockPfbName = "StoryChapterLockItem"
local activityName = "ActivityChapterItem"

local color1 = Color.New(0/255,0/255,0/255)
local color2 = Color.New(80/255,78/255,75/255)

local Kind = {Story = 1, Activity = 2}--1.主线物语、2.活动物语

local function OnClickChapterItem(self,chapterId)
    print("--进入第"..chapterId.."--章,难度为:"..self.clientData:GetStoryRecord(chapterId).Difficulty)
    local againstComponent = Game.Scene:GetComponent("AgainstComponent")
    againstComponent.ChapterId = chapterId
    againstComponent.CurLevelDifficulty = self.clientData:GetStoryRecord(chapterId).Difficulty
    ClientData:GetInstance():SetCurChapterId(chapterId)
    UIManager:GetInstance():OpenWindow(UIWindowNames.UILaunchAtk, {mode = self.model.mode, chapterId = chapterId})
end

function this.AutoClickChapterItem(self, chapterId)
    OnClickChapterItem(self, chapterId)
end

local function ActiveIsOpen(self, activityType, chapterId)
    local data = self.storyComponent:ActiveStoryIsOpen(activityType)
    
    if data ~= nil then
        local sections = table.choose(Z_StorySection,function(k,v)
            return v.ChapterId == chapterId and not string.IsNullOrEmpty(v.StoryId)
        end)
        data.totalSection = table.count(sections)
        data.curSection = 0
        local storyId = self.storyComponent:GetCompletedSection(chapterId)[1]
        for _, v in pairs(sections) do
            if storyId >= v.Id then
                data.curSection = 1 + data.curSection
            end
        end
    end
    
    return data
end

local function GetChapterMaxSection(self,chapterId)
    local sections = table.choose(Z_StorySection,function(k,v)return v.ChapterId == chapterId end)
    if table.count(sections) == 0 then return nil end
    local maxId = table.first(sections).Id
    for _,v in pairs(sections) do
        if v.Id > maxId then
            maxId = v.Id
        end
    end
    return maxId
end

local function GetOpenChapter(self, kind)
    local openChapters = {}
    if Kind.Story == kind then
        for _, v in pairs(Z_StoryChapter) do
            if v.IsOpen == 1 and v.ChapterId < 1000 and v.IsMainLevel == 1 then
                local limit = 1
                local maxId = GetChapterMaxSection(self, v.ChapterId)
                if v.IsLock == 1 or maxId == nil then
                    limit = 0--锁住
                end
                table.insert(openChapters, {Id = v.Id, limit = limit, maxId = maxId})
            end
        end
    elseif Kind.Activity == kind then
        for _, v in pairs(Z_StoryChapter) do
            if v.IsOpen == 1 and v.ChapterId > 1000 and v.IsMainLevel == 1 then
                --1.上线、2.已下线
                local data = ActiveIsOpen(self, v.ActivityType, v.ChapterId)
                if data ~= nil then
                    if v.IsLock == 1 or data.totalSection <= 0 then
                        data.limit = 0--锁住
                    end
                    --activityType 排序
                    table.insert(openChapters, {Id = v.Id, data = data})
                end
            end
        end
    end
    
    return openChapters
end

local function showTips(self, transform, str)
    self.ShowTextBg.position = transform.position
    self.ShowTextBg.anchoredPosition = self.ShowTextBg.anchoredPosition + Vector3.New(0, 80, 0)
    local storyContent = self.ShowText.transform.parent
    local clampRight = storyContent.anchoredPosition.x + storyContent.sizeDelta.x / 2 - 285
    if self.ShowTextBg.anchoredPosition.x > clampRight then
        self.ShowTextBg.anchoredPosition = self.ShowTextBg.anchoredPosition - Vector3.New(self.ShowTextBg.anchoredPosition.x - clampRight + 30, 0, 0)
    end
    self.tipText.text = str
    self.ShowText:SetActive(true)
end


-- 显示有效章节和活动
local function InitStoryContent(self)
    self.ActivityView.gameObject:SetActive(false)
    self.StoryView.gameObject:SetActive(true)
    if self.storyInit then
        return
    end
    self.storyInit = true
    
    local openChapters = GetOpenChapter(self, Kind.Story)--主线已开的章节
    if table.count(openChapters) <= 3 then
        local resolution = CS.UnityEngine.Screen.width / CS.UnityEngine.Screen.height
        self.storyHorizontalLayout.spacing = math.max( resolution * 170 - 190, 80)
    else
        self.storyHorizontalLayout.spacing = 100
    end
    coroutine.start(function()
        ListChildPool:GetInstance():ClearContent(self.storyContent)
        table.walk(openChapters, function (_, v)
            local zData = Z_StoryChapter[v.Id]
            ListChildPool:GetInstance():GetChild(pfbName, self.storyContent, function(gameObject)
                local transform = gameObject.transform
                local avatar = transform:Find("Avatar"):GetComponent("Image")
                local name = LangUtil.BindText(transform:Find("Frame/NameBg/Name"))
                local title = LangUtil.BindText(transform:Find("Frame/Title"))
                local btn = transform:Find("Frame/Button")
                local lockImage = transform:Find("Frame/LockImage")
                btn.gameObject:SetActive(true)
                avatar.sprite = DeActiveSprite

                name.text = zData.Name
                local avatarPath = ""
                if v.limit == 0 then--锁住
                    if string.IsNullOrEmpty(zData.TipsLock) then
                        title.text = ""
                        btn.gameObject:SetActive(false)
                    else
                        title.text = LangUtil.GetSysLang(930)--未开放
                        title.color = color2
                        LangUtil.BindText(btn:GetChild(0)).text = LangUtil.GetSysLang(924)--预告
                        UIUtil.AddBtnEvent(btn, function() showTips(self, gameObject.transform, zData.TipsLock) end)
                    end
                    name.color = color2
                    avatarPath = "chapter_lock_" .. zData.ChapterId ..".png"
                    lockImage.gameObject:SetActive(true)
                    btn.gameObject:SetActive(false)
                else
                    --if v.limit == 1 then--1.前一关未通关、2.前一关已通关、3.已通关
                    --end
                    name.color = color1
                    title.color = color1
                    title.text = zData.Title
                    LangUtil.BindText(btn:GetChild(0)).text = LangUtil.GetSysLang(923)--简介
                    UIUtil.AddBtnEvent(btn, function() showTips(self, gameObject.transform, zData.Tips) end)
                    avatarPath = "chapter_" .. zData.ChapterId ..".png"
                    lockImage.gameObject:SetActive(false)
                    btn.gameObject:SetActive(true)
                end
                UIUtil.AddBtnEvent(gameObject, function()
                    if v.limit == 0 then
                        UIUtil.ToolTipFourth(LangUtil.GetSysLang(925))--将在之后的版本更新时解锁，敬请期待
                    else
                        OnClickChapterItem(self, zData.ChapterId)
                    end
                end)
                coroutine.start(function()
                    avatar.sprite = AtlasManager:GetInstance():CoLoadImageAsync("UI/Atlas/ChapterIcon/" .. avatarPath)
                end)
            end)
        end)
        
    end)
end

local function InitActivityContent(self)
    self.ActivityView.gameObject:SetActive(true)
    self.StoryView.gameObject:SetActive(false)
    if self.activityInit then
        return
    end
    self.activityInit = true
    
    local openChapters = GetOpenChapter(self, Kind.Activity)--活动开放的章节
    if table.count(openChapters) <= 3 then
        local resolution = CS.UnityEngine.Screen.width / CS.UnityEngine.Screen.height
        self.activityHorizontalLayout.spacing = math.max( resolution * 140 - 190, 60)
    else
        self.activityHorizontalLayout.spacing = 60
    end
    
    coroutine.start(function()
        ListChildPool:GetInstance():ClearContent(self.activityContent)
        table.walk(openChapters, function (_, v)
            local zData = Z_StoryChapter[v.Id]
            ListChildPool:GetInstance():GetChild(activityName, self.activityContent, function(gameObject)
                local transform = gameObject.transform
                local avatar = transform:GetComponent("Image")
                local title = LangUtil.BindText(transform:Find("Title"))
                local mask = transform:Find("mask").gameObject
                local label = transform:Find("label").gameObject
                local text = LangUtil.BindText(transform:Find("Text"))
                local timeText = LangUtil.BindText(transform:Find("TimeBg/TimeText"))
                local btn = transform:Find("Button")
                transform:Find("Lock").gameObject:SetActive(false)
                transform:Find("TimeBg").gameObject:SetActive(true)
                if avatar:GetComponent("Button") then
                    avatar:GetComponent("Button").enabled = false
                end
                avatar.material = nil
                timeText.fontSize = 30
                timeText.color = color1
                avatar.sprite = DeActiveSprite

                --0.锁住、 1.上线、2.已下线
                local data = v.data
                title.text = data.curSection .. "/" .. data.totalSection .. LangUtil.GetSysLang(74)--话
                text.text = ""
                if data.limit == 0 then
                    mask:SetActive(true)
                    label:SetActive(false)
                    avatar.material = DeActiveMat
                elseif data.limit == 1 then--需StartDate, EndDate..
                    mask:SetActive(false)
                    label:SetActive(false)
                    timeText.text = UIPublic.GetTimeStr(data.StartDate, data.EndDate)
                    UIUtil.AddBtnEvent(avatar.gameObject, function()
                        local isOpen = ActiveIsOpen(self, zData.ActivityType, zData.ChapterId)
                        if isOpen ~= nil and isOpen.limit == 1 then--时间已过
                            OnClickChapterItem(self, zData.ChapterId)
                        else
                            UIUtil.ToolTipFourth(LangUtil.GetSysLang(839))--活动已结束
                            self:OnRefresh()
                        end
                    end)
                elseif data.limit == 2 then
                    LangUtil.GetSpriteLang(202, function(sprite) label:GetComponent("Image").sprite = sprite end)
                    mask:SetActive(true)
                    label:SetActive(true)
                    timeText.text = LangUtil.GetSysLang(928)--可在图鉴追忆欣赏完整剧情
                    timeText.fontSize = 24
                    timeText.color = color2
                    avatar.material = DeActiveMat
                    UIUtil.AddBtnEvent(avatar.gameObject, function()
                        UIUtil.ToolTipFourth(LangUtil.GetSysLang(839))--活动已结束
                    end)
                end
                if not string.IsNullOrEmpty(zData.Tips) then
                    LangUtil.BindText(btn:GetChild(0)).text = LangUtil.GetSysLang(923)--简介
                    UIUtil.AddBtnEvent(btn, function() showTips(self, gameObject.transform, zData.Tips) end)
                    btn.gameObject:SetActive(true)
                else
                    btn.gameObject:SetActive(false)
                end
                coroutine.start(function()
                    avatar.sprite = AtlasManager:GetInstance():CoLoadImageAsync("UI/StoryChapter/" .. zData.ActivityType .. ".png")
                end)
            end)
        end)
        local count = 2--占位
        if table.count(openChapters) >= 2 then
            count = 1
        end
        for i = 1, count do
            ListChildPool:GetInstance():GetChild(activityName, self.activityContent, function(gameObject)
                local transform = gameObject.transform
                local avatar = transform:GetComponent("Image")
                transform:Find("Title"):GetComponent("Text").text = ""
                transform:Find("mask").gameObject:SetActive(false)
                transform:Find("label").gameObject:SetActive(false)
                transform:Find("Lock").gameObject:SetActive(false)
                local text = LangUtil.BindText(transform:Find("Text")) 
                transform:Find("TimeBg").gameObject:SetActive(false)
                transform:Find("Button").gameObject:SetActive(false)
                text.text = LangUtil.GetSysLang(930)--敬请期待
                avatar.material = nil
                coroutine.start(function()
                    avatar.sprite = AtlasManager:GetInstance():CoLoadImageAsync("UI/StoryChapter/image" .. i .. ".png")
                end)
                if avatar:GetComponent("Button") then
                    avatar:GetComponent("Button").enabled = false
                end
            end)
        end
        
    end)
end

function this.OnLangCreate(self)
    self.tipText = LangUtil.BindText(self.ShowTextBg:Find("Text"))
    self.showTipsText = LangUtil.BindText(self.TipsPanel:Find("Tips/Text"))
    self.showTipsText.text = ""
end

function this.OnCreate(self)
    base.OnCreate(self)
    --self.mat = self.rc:GetObject("Mat"):GetComponent("Image").material
    
    self.StoryView = self.rc:GetObject("StoryView")
    self.storyContent = self.rc:GetObject("StoryContent").transform
    local LayoutElement = self.storyContent:GetComponent("LayoutElement")
    LayoutElement.minWidth = self.StoryView:GetComponent("RectTransform").rect.width
    self.storyHorizontalLayout = self.storyContent:GetComponent("HorizontalLayoutGroup")
    UIPublic.SetBackButton(
        self.rc:GetObject("ReturnButton"),
        UIWindowNames.UIStoryChapter,
        430
    )
    --UIUtil.AddBtnEvent(homeBtn,function()
    --    UIManager:GetInstance():CloseWindowByStackExcept(UIWindowNames.UIHome)
    --end, "Back")

    self.ActivityView = self.rc:GetObject("ActivityView")
    self.activityContent = self.rc:GetObject("ActivityContent").transform
    local activityLayoutElement = self.activityContent:GetComponent("LayoutElement")
    activityLayoutElement.minWidth = self.ActivityView:GetComponent("RectTransform").rect.width
    self.activityHorizontalLayout = self.activityContent:GetComponent("HorizontalLayoutGroup")
    
    self.ShowText = self.rc:GetObject("ShowText").gameObject
    self.ShowText:SetActive(false)
    self.ShowTextBg = self.ShowText.transform:Find("Bg")
    EventTriggerListener.Get(self.ShowText).onLuaClick = function() self.ShowText:SetActive(false) end
    
    --新手引导剧情
    local guide=Game.Scene:GetComponent("GuideComponent")
    local guideData = table.first(guide.GuideList,function (h) return h.Id == 6001  end)
    if guideData == nil or guideData.Step < 5 then
        guide:CheckStart(5,0)
    end

    self.TipsPanel = self.rc:GetObject("TipsPanel").transform
    self.rc:GetObject("TipsBgBtn").gameObject:SetActive(false)
    -- self.TipsBtn = backBtn.transform:Find("Text/TipsBtn")
    -- UIPublic.SetWindowTip(self.TipsPanel, self.TipsBtn, self.rc:GetObject("TipsBgBtn"))
end

function this.OnEnable(self)
    base.OnEnable(self);
    self:OnRefresh();
end


function this.OnRefresh(self)
    self.storyInit = nil
    self.activityInit = nil
    self.player = Game.Scene.Player
    self.storyComponent = self.player:GetComponent("StoryComponent")
    self.againstComponent =Game.Scene:GetComponent("AgainstComponent")
    self.clientData = ClientData:GetInstance()
    if self.model.kind == Kind.Activity then
        self.TipsPanel.gameObject:SetActive(true)
        -- self.TipsBtn.gameObject:SetActive(true)
        self.titleText.text = LangUtil.GetSysLang(926)--活动物语
        InitActivityContent(self)
        if self.storyComponent:ActiveStoryIsOpen(2) ~= nil then--第二个活动
            self.showTipsText.text = LangUtil.GetSysLang(4070)--钥匙出现后
        else
            self.showTipsText.text = LangUtil.GetSysLang(4069)
        end
    else
        self.TipsPanel.gameObject:SetActive(false)
        --self.TipsBtn.gameObject:SetActive(false)
        --self.titleText.text = LangUtil.GetSysLang(922)--主线物语
        InitStoryContent(self)
    end
end

function this.OnViewTop(self)
    base.OnViewTop(self)
end

function this.OnDisViewTop(self)
    base.OnDisViewTop(self)
end

local function OnStoryChg(self)
    self.storyInit = nil
    self.activityInit = nil
    if self.model.kind == Kind.Activity then
        InitActivityContent(self)
    else
        InitStoryContent(self)
    end
end

--新手引导
local function ON_Guide_Click(self,cid,num,isrun,minStep)
    if cid==5 and isrun then
            if num==0 and minStep == 1 then
                OnClickChapterItem(self,1)
            end
    end
end


function this.OnAddListener(self)
    base.OnAddListener(self)
    self:AddUIListener(UIMessageNames.UILAUNCHATK_ON_STORY_MAIN_CHG, OnStoryChg);
    --self:AddUIListener(UIMessageNames.ON_STORY_DIFF_CHG,OnDiffChg)
    self:AddUIListener(UIMessageNames.ON_Guide_Click,ON_Guide_Click)
end

function this.OnRemoveListener(self)
    base.OnRemoveListener(self);
    self:RemoveUIListener(UIMessageNames.UILAUNCHATK_ON_STORY_MAIN_CHG);
    --self:RemoveUIListener(UIMessageNames.ON_STORY_DIFF_CHG)
    self:RemoveUIListener(UIMessageNames.ON_Guide_Click)
end

function this.OnDisable(self)
    base.OnDisable(self);
    ListChildPool:GetInstance():ClearContent(self.storyContent)
    ListChildPool:GetInstance():ClearContent(self.activityContent)
    self.storyInit = nil
    self.activityInit = nil
end

function this.OnDestroy(self)
    base.OnDestroy(self);
end

return this;

