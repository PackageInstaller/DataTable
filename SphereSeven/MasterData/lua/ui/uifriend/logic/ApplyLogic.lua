---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by win 10.
--- DateTime: 2019/7/11 17:09
---


local ApplyLogic = {};
local this = ApplyLogic;

local applyPfbName = "FriendItem"


function this.OnClickAllRefuseButton(self)
    Game.Scene.Player:GetComponent("FriendComponent"):ClearApplyFriends()
    this.Init(self)
end

local function OnClickAgreeButton(self,Id)
    PublicRequest.SendRequest(
        PROTOCOL.ApplyFriendRequestReq,
        {
            role_id = Id,
        },
        nil
    )
end

local function OnClickRefuseButton(self,Id)
    PublicRequest.SendRequest(
        PROTOCOL.RemoveFriendRequestReq,
        {
            role_id = Id,
        },
        nil
    )
end

function this.InitContent(self,addFriends)
    ListChildPool:GetInstance():ClearContent(self.apply_Content);
    self.hint:SetActive(table.count(addFriends) == 0)
    coroutine.start(function ()
        ---@param v SocietyRole
        for k,v in table.pairsByKeys(addFriends) do
            ListChildPool:GetInstance():GetChild(applyPfbName,self.apply_Content,function(object)
                if self.active == false then ListChildPool:GetInstance():Remove(object) return end
                local rc = object:GetComponent("ReferenceCollector")
                local avatar_Image = rc:GetObject("Avatar"):GetComponent("Image")
                local name_Text = rc:GetObject("Name")
                local level_Text = rc:GetObject("Level"):GetComponent("Text")
                local StateLX = rc:GetObject("StateLX")
                local StateZX = rc:GetObject("StateZX")
                local IDText= rc:GetObject("IDText")
            
                LangUtil.GetSpriteLang(456, function(sprite) StateLX:GetComponent("Image").sprite = sprite end)
                LangUtil.GetSpriteLang(457, function(sprite) StateZX:GetComponent("Image").sprite = sprite end)
                LangUtil.GetSpriteLang(458, function(sprite) rc:GetObject("SupportImage"):GetComponent("Image").sprite = sprite end)
                LangUtil.GetSpriteLang(459, function(sprite) rc:GetObject("NoFightSoulImage"):GetComponent("Image").sprite = sprite end)
            
                LangUtil.BindText(IDText, FontType.All_Number).text = v.info.roleId
            
                ---@type UnityEngine.Transform
                local buttonRoot = rc:GetObject("ButtonRoot").transform
                local agree_Btn, refuse_Btn
                for i = 0, buttonRoot.childCount - 1 do
                    local child = buttonRoot:GetChild(i)
                    if child.gameObject.name == "Apply" then
                        child.gameObject:SetActive(true)
                        agree_Btn = child.transform:Find("Button1")
                        refuse_Btn = child.transform:Find("Button2")
                    else
                        child.gameObject:SetActive(false)
                    end
                end
                LangUtil.BindText(agree_Btn:Find("Text")).text = LangUtil.GetSysLang(333)
                LangUtil.BindText(refuse_Btn:Find("Text")).text = LangUtil.GetSysLang(334)
            
                if not v.isOnLine then
                    local timeDate = ""
                    local timeData = TimeUtil.ConvertTimeForm(os.time() - v.info.logoutTime)
                    local day = timeData.day
                    local hour = timeData.hour
                    if day < 1 then
                        if hour < 1 then
                            local min = timeData.minute
                            if min < 1  then
                                min = 1
                            end
                            timeDate = string.gsub(LangUtil.GetSysLang(728),"X",min)
                        else
                            timeDate = string.gsub(LangUtil.GetSysLang(726),"X",hour)
                        end
                    else
                        if day>30 then
                            day = 30
                        end
                        timeDate = string.gsub(LangUtil.GetSysLang(727),"X",day)
                    end
                    --end
                    LangUtil.BindText(rc:GetObject("OneLineTimeValue")).text = "[" .. timeDate .. "]"
                    rc:GetObject("BgImage"):GetComponent("Image").material = DeActiveMat -- 离线
                else
                    rc:GetObject("BgImage"):GetComponent("Image").material = nil -- 在线
                end

                local cardItem = rc:GetObject("CardItemLittle")
                local fightSoulItem = rc:GetObject("FightVisitItemMid")
                cardItem:SetActive(v.supportUnits.cardData ~= nil)
                if v.supportUnits.cardData ~= nil then
                    UIPublic.InitCardItemLittle(
                        v.supportUnits.cardData,
                        cardItem
                    )
                end
                fightSoulItem:SetActive(v.supportUnits.fight_soul ~= nil and v.supportUnits.fight_soul.id ~= 0)
                if v.supportUnits.fight_soul ~= nil and v.supportUnits.fight_soul.id ~= 0 then
                    UIPublic.InitVsFightSoulItemMId(
                        v.supportUnits.fightSoulEntity,
                        fightSoulItem
                    )
                end
                if v.info.avatar ~= nil and Z_HeadPortrait[v.info.avatar] ~= nil then
                    UIUtil.SetPlayerIcon(avatar_Image,Z_HeadPortrait[v.info.avatar].Resourse)
                end
                LangUtil.BindText(name_Text).text = v.info.username
                level_Text.text = "LV.".. v.info.level
                StateLX:SetActive(not v.isOnLine)--离线
                StateZX:SetActive(v.isOnLine)--在线
                UIUtil.AddBtnEvent(agree_Btn, function(go) OnClickAgreeButton(self,v.info.roleId) end)
                UIUtil.AddBtnEvent(refuse_Btn, function(go) OnClickRefuseButton(self,v.info.roleId) end)
                UIUtil.AddBtnEvent(avatar_Image.gameObject,function()
                    UIPublic.OpenRoleInfo(v)
                end)
            end)
        end
    end)
end

function this.Init(self)
    this.InitContent(self,self.requests);
end


return this;